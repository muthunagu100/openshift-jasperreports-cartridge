dd.tables={PAGE:"tables",TREE_TEMPLATE_DOM_ID:"list_responsive_collapsible_type_tables",SOURCE_TABLES_DOM_ID:"sourceTablesTree",DESTINATION_TABLES_DOM_ID:"destinationTablesTree",SOURCE_TABLES_COLUMN_DOM_ID:"sourceTablesColumn",DESTINATION_TABLES_COLUMN_DOM_ID:"destTablesColumn",SOURCE_TABLES_TREE_PROVIDER:"choiceTreeDataProvider",DESTINATION_TABLES_TREE_PROVIDER:"selectedMetaDataTreeDataProvider",DATA_SOURCE_LABEL_DOM_ID:"dataSource",MOVE_BUTTON_IDS:["left","right","toLeft"],MANAGE_DATA_SOURCE_DIALOG_ID:"manageDataSource",nodeCopyMoveController:new domain.TablesCopyMoveController,organizationId:null,publicFolderUri:null,sourceTablesTree:null,destinationTablesTree:null,dataSource:null,dataSourceSelectedProperties:null,usedTablesByItemId:null,joins:null,askForSchemas:null,getValidationPostData:function(){return{selectedModel:this.getSelectedModel(),page:this.PAGE}},getSelectedModel:function(){var e=this.destinationTablesTree;if(!e||!e.getRootNode()||!e.getRootNode().childs)return"[]";var t=this.destinationTablesTree.getRootNode().childs;return Object.toJSON(t.findAll(function(e){return!e.isHidden()}))},fillForm:function(){$("selectedModel").writeAttribute("value",this.getSelectedModel()),$("autoGenerateJoins").writeAttribute("value",(!!$F("inspectAndJoin")).toString()),$("datasources").writeAttribute("value",Object.toJSON([this.dataSource])),$("unsavedChangesPresent").writeAttribute("value",dd.isUnsavedChangesPresent().toString())},initFromOptions:function(e){this.organizationId=e.organizationId,this.publicFolderUri=e.publicFolderUri,this.dataSource=e.dataSourcesList.first(),this.dataSourceSelectedProperties=e.datasourcesProperties,this.usedTablesByItemId=e.usedTablesByItemId,this.joins=e.jsonJoins,this.askForSchemas=e.askForSchemas},init:function(e){this.initFromOptions(e),dd.calcFieldsAndFiltersValidator.init(dd.validateForCalcFields.bind(dd),dd.getTablesUsedForFilters.bind(dd,this.usedTablesByItemId[this.dataSource.name])),domain.resetTreeSelectionHandler.init(this.MOVE_BUTTON_IDS.concat([this.SOURCE_TABLES_COLUMN_DOM_ID,this.DESTINATION_TABLES_COLUMN_DOM_ID,this.SOURCE_TABLES_DOM_ID,this.DESTINATION_TABLES_DOM_ID,this.MANAGE_DATA_SOURCE_DIALOG_ID]).collect(function(e){return"#"+e}),function(){return[this.sourceTablesTree,this.destinationTablesTree]}.bind(this),this.updateButtonsState.bind(this)),domain.registerClickHandlers([this.selectDataSourceClickEventHandler.bind(this),this.moveButtonsClickEventHandler.bind(this)]),this.manageDataSourceDialog.init({dataSourceUri:this.dataSource.uri,organizationId:this.organizationId,publicFolderUri:this.publicFolderUri,callback:this.setDataSource.bind(this),selectSchema:this.selectSchema.bind(this),getSchemas:this.checkForSchemas.bind(this),hasSchemas:this.hasSchemas}),this.selectSchemasDialog.init(this.findInvalidFields.bind(this),this.fixSchemaPrefixesValidator.validate),this.autoGenerateJoinsValidator.init(this.joins),this.invalidSelectedTablesValidator.init(this.findInvalidFields.bind(this),this.removeInvalidFields.bind(this)),this.fixSchemaPrefixesValidator.init(this.fixSchemaPrefixes.bind(this)),this.initTrees(),this.destinationTablesTree.showTree(1,this.initDataSource.bind(this),domain.treeErrorHandler),this.updateButtonsState()},initTrees:function(){this.sourceTablesTree=domain.createItemsTree({handleNodeOnDblclick:!1,treeId:this.SOURCE_TABLES_DOM_ID,providerId:this.SOURCE_TABLES_TREE_PROVIDER,templateDomId:this.TREE_TEMPLATE_DOM_ID,dragPattern:dd.TREE_DRAG_PATTERN,nodeClass:domain.TablesCustomNode,selectOnMousedown:!0}),this.destinationTablesTree=domain.createItemsTree({handleNodeOnDblclick:!1,treeId:this.DESTINATION_TABLES_DOM_ID,providerId:this.DESTINATION_TABLES_TREE_PROVIDER,templateDomId:this.TREE_TEMPLATE_DOM_ID,dragPattern:dd.TREE_DRAG_PATTERN,nodeClass:domain.TablesCustomNode,selectOnMousedown:!0});for(var e in this.treeEventFactory)[this.sourceTablesTree,this.destinationTablesTree].invoke("observe",e,this.treeEventFactory[e].bindAsEventListener(this));this.initDragAndDrop()},initDragAndDrop:function(){var e=[this.SOURCE_TABLES_DOM_ID,this.SOURCE_TABLES_COLUMN_DOM_ID,this.DESTINATION_TABLES_DOM_ID,this.DESTINATION_TABLES_COLUMN_DOM_ID],t=function(e,t){var i=e.node;if(i){var s=dynamicTree.trees[i.getTreeId()],a=matchAny(t,["#"+this.SOURCE_TABLES_COLUMN_DOM_ID],!0)?this.sourceTablesTree:this.destinationTablesTree;s!==a&&this.moveNodes(s.selectedNodes,a.getRootNode())}}.bind(this);e.each(function(e){Droppables.remove(e),Droppables.add(e,{accept:["draggable","wrap"],onDrop:t})})},initDataSource:function(){this.updateDataSourceLabel(this.dataSource.name);var e=function(e){var t={dataSource:this.dataSource,selectedProperties:e,presentationSelected:dd.presentationSelected,reloadBoth:!1};this.setDataSourceOrReloadTree(t)};this.askForSchemas?this.selectSchema({dataSource:this.dataSource,initialChange:!0,callback:e.bind(this)}):e.bind(this)(this.dataSourceSelectedProperties)},setDataSourceOrReloadTree:function(e){var t=function(){this.invalidSelectedTablesValidator.validate(this.updateButtonsState.bind(this))};!e.presentationSelected||this.askForSchemas?this.setDataSource(e.dataSource,e.selectedProperties):(this.dataSource=e.dataSource,this.dataSourceSelectedProperties=e.selectedProperties,e.reloadBoth?this.reloadBothTrees(null):this.reloadTree(this.sourceTablesTree,t.bind(this)))},updateDataSourceLabel:function(e){$(this.DATA_SOURCE_LABEL_DOM_ID).update(e)},hasSchemas:function(e,t){return e&&e[t]&&e[t].schemas&&e[t].schemas.first()},reloadBothTrees:function(e){var t=function(){this.invalidSelectedTablesValidator.validate(e)};this.reloadTree(this.sourceTablesTree,null),this.reloadTree(this.destinationTablesTree,t.bind(this))},reloadTree:function(e,t){var i=function(){dd.hasSchemas=this.hasSchemas(this.dataSourceSelectedProperties,this.dataSource.name),this.updateDataSourceLabel(this.dataSource.name),this.updateButtonsState(),t&&t()};e.showTree(1,i.bind(this),domain.treeErrorHandler)},selectSchema:function(e){var t=null,i=function(i){if(e.handleDsProps&&e.handleDsProps(i),this.hasSchemas(i,e.dataSource.name)){var a=i[e.dataSource.name].schemas;e.hideDialog&&e.hideDialog(),this.selectSchemasDialog.show({schemasList:a,selectedSchemas:e.selectedSchemas,standalone:e.initialChange,dataSource:e.dataSource,callback:s.bind(this)})}else t=i,e.callback&&e.callback(t)},s=function(i){t={},t[e.dataSource.name]={},t[e.dataSource.name].schemas=i,t[e.dataSource.name].catalogs=[],e.showDialog&&e.showDialog(),e.callback&&e.callback(t)};e.dsProps?i.bind(this)(e.dsProps):this.checkForSchemas(e.dataSource,i.bind(this))},findInvalidFields:function(){var e=[];return this.destinationTablesTree.getRootNode().childs.each(function(t){if(!t.isHidden()){var i=t.childs.findAll(function(e){return"true"===e.param.extra.isInvalid});e=e.concat(i)}}),e},removeInvalidFields:function(e){e&&e.first()&&(e.each(function(e){e.parent.removeChild(e)}),this.destinationTablesTree.getRootNode().childs.collect(function(e){return e}).each(function(e){e.childs.first()?(delete e.param.extra.isInvalid,e.refreshStyle()):e.parent.removeChild(e)}),this.updateButtonsState())},fixSchemaPrefixes:function(e,t){var i={flowExecutionKey:dd.flowExecutionKey,flowId:dd.FLOW_ID,eventId:"initAction",selectedSchemas:t.join(",")};this.dataSource.id=e.id,this.dataSource.uri=e.uri,domain.submitForm(dd.formDomId,i,this.fillForm.bind(this))},deleteCalcFields:function(e,t){var i={eventId:"deleteCalculatedField",flowExecutionKey:dd.flowExecutionKey},s={fieldsToDelete:Object.toJSON(e)};domain.sendAjaxRequest(i,s,t)},checkForSchemas:function(e,t){var i={flowExecutionKey:dd.flowExecutionKey,eventId:"checkForSchemas"},s={selectedDatasources:Object.toJSON([e])},a=function(e){t&&t(e?e.first():{})};domain.sendAjaxRequest(i,s,a.bind(this))},setDataSource:function(e,t){var i={flowExecutionKey:dd.flowExecutionKey,eventId:"setDatasources"},s={datasources:Object.toJSON([e]),datasourcesProperties:Object.toJSON(t)},a=!0,o=function(){this.dataSource=e,this.dataSourceSelectedProperties=t,this.pickDataSource(a)};domain.sendAjaxRequest(i,s,o.bind(this))},pickDataSource:function(e){var t={flowExecutionKey:dd.flowExecutionKey,eventId:"pickDatasource"},i=this.destinationTablesTree,s="[]";i&&i.getRootNode()&&(s=Object.toJSON(i.getRootNode().childs.findAll(function(e){return!e.isHidden()})));var a={selectedDatasource:this.dataSource.name,selectedModel:s,replaced:e,added:!e,page:this.PAGE},o=function(){this.reloadBothTrees(this.updateButtonsState.bind(this))};domain.sendAjaxRequest(t,a,o.bind(this))},moveNodes:function(e,t){if(e&&e.first()&&t){var i=dynamicTree.trees[e.first().getTreeId()];i==this.sourceTablesTree?this.moveNodesFromSourceTree(e,t):this.moveNodesFromDestTree(e,t),dd.setUnsavedChangesPresent(!0)}},moveNodesInternal:function(e,t){if(e&&e.first()&&t){var i=dynamicTree.trees[t.getTreeId()];i._getElement().parentNode.scrollTop=0;var s=this.nodeCopyMoveController.move(e,t);i.resortSubtree(i.getRootNode()),i.renderTree(),s.each(function(e){i.addNodeToSelected(e),e.refreshStyle()}),s.first()._getElement().focus(),this.updateButtonsState()}},moveNodesFromSourceTree:function(e,t){var i=dynamicTree.trees[e.first().getTreeId()],s=e.findAll(function(e){return!e.isloaded||!e.childs||!e.childs.first()}),a=function(s,a){s&&a&&i.setMultipleNodesChilden(s,a),this.moveNodesInternal(e,t),sessionManager.resetSession(dd.flowExecutionKey)};s&&s.first()?i.getTreeMultipleNodesChildren(s,a.bind(this),domain.treeErrorHandler):a.bind(this)()},moveNodesFromDestTree:function(e,t){var i=function(i,s){s&&s.length>0&&this.deleteCalcFields(s);var a=this.findNodesToDeleteAndNodesToRestore(e);a.nodesToDelete.each(function(e){e.parent.removeChild(e)}),this.moveNodesInternal(a.nodesToRestore,t)};dd.calcFieldsAndFiltersValidator.validate(e,!0,i.bind(this))},findNodesToDeleteAndNodesToRestore:function(e){var t=this.dataSourceSelectedProperties,i=this.dataSource,s=[];this.hasSchemas(t,i.name)&&(s=t[i.name].schemas);var a=[],o=[];return e.each(function(e){var t=null,i=e.param.extra.table.split(".");i.length>=2&&(t=i[0]);var d=t&&s.find(function(e){return e===t});if(e.param.extra.isInvalid){var n=e.childs.findAll(function(e){return e.param.extra.isInvalid});n.length==e.childs.length?a.push(e):(n.each(function(t){e.removeChild(t)}),o.push(e))}else s.length>0&&t?d?o.push(e):a.push(e):s.first()||t?a.push(e):o.push(e)}),{nodesToDelete:a,nodesToRestore:o}},nodeDblClick:function(e){var t=e.memo.node;if(t){var i=dynamicTree.trees[t.getTreeId()],s=i==this.sourceTablesTree?this.destinationTablesTree:this.sourceTablesTree;i&&s&&(i._deselectAllNodes(),t.select(),this.moveNodes(i.selectedNodes,s.getRootNode()))}Event.stop(e)},moveButtonsClickEventHandler:function(e){var t=!1;return this.moveButtonsClickEventMap.each(function(i){if(domain.elementClicked(e,i.key)){var s=dynamicTree.trees[i.value.sourceTree],a=dynamicTree.trees[i.value.destTree],o=i.value.moveAll?s.getRootNode().childs.findAll(function(e){return!e.isHidden()}):s.selectedNodes;throw this.moveNodes(o,a.getRootNode()),t=!0,$break}}.bind(this)),t},updateButtonsState:function(){var e=this.destinationTablesTree,t=this.sourceTablesTree,i=e&&e.getRootNode()&&e.getRootNode().hasVisibleChilds(),s=t&&t.getRootNode()&&t.getRootNode().hasVisibleChilds(),a=i&&e.selectedNodes.length>0,o=s&&t.selectedNodes.length>0,d={destTreeHasSelectedNodes:a,sourceTreeHasSelectedNodes:o,destTreeHasVisibleNodes:i,sourceTreeHasVisibleNodes:s};for(var n in this.moveButtonsUpdateStatusEventFactory){var r=this.moveButtonsUpdateStatusEventFactory[n](d);domain.enableButton(n,r)}},selectDataSourceClickEventHandler:function(e){return domain.elementClicked(e,"#"+this.DATA_SOURCE_LABEL_DOM_ID)?(this.manageDataSourceDialog.show(this.dataSource,this.dataSourceSelectedProperties),!0):void 0}};var dd_tables=dd.tables;dd_tables.treeEventFactory={"node:dblclick":dd_tables.nodeDblClick,"node:mouseup":function(e){this.updateButtonsState(),Event.stop(e)}},dd_tables.moveButtonsUpdateStatusEventFactory={left:function(e){return e.destTreeHasSelectedNodes},right:function(e){return e.sourceTreeHasSelectedNodes},toLeft:function(e){return e.destTreeHasVisibleNodes}},dd_tables.moveButtonsClickEventMap=$H({"#left":{sourceTree:dd_tables.DESTINATION_TABLES_DOM_ID,destTree:dd_tables.SOURCE_TABLES_DOM_ID},"#right":{sourceTree:dd_tables.SOURCE_TABLES_DOM_ID,destTree:dd_tables.DESTINATION_TABLES_DOM_ID},"#toLeft":{moveAll:!0,sourceTree:dd_tables.DESTINATION_TABLES_DOM_ID,destTree:dd_tables.SOURCE_TABLES_DOM_ID}}),"undefined"==typeof require&&document.observe("dom:loaded",dd.initialize.bind(dd));