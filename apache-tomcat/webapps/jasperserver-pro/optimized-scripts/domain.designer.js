domain.designer={FLOW_ID:"domainDesignerFlow",CREATE_DS_FLOW:"createSLDatasourceFlow",TABLES_VIEW:"domainDesigner_tables",DERIVED_TABLES_VIEW:"domainDesigner_derivedTables",JOINS_VIEW:"domainDesigner_joins",CALC_FIELDS_VIEW:"domainDesigner_calculatedFields",FILTERS_VIEW:"domainDesigner_filters",DISPLAY_VIEW:"domainDesigner_display",ACTION_MODEL_TAG:"domainDesignerActionModel",TREE_DRAG_PATTERN:".draggable",WHITELIST_REGEX_PATTERN:/[a-zA-Z0-9\._]/gi,BLACKLIST_REGEX_PATTERN:/[-+='"!#$%^&,<> %:;?{}@()|\*\[\]\/\\]/,formDomId:"stepDisplayForm",currentPage:null,flowExecutionKey:null,hasSchemas:!1,presentationSelected:!1,unsavedChangesPresent:!1,initialize:function(){webHelpModule.setCurrentContext("domain");var e=localContext.domainInitOptions;this.flowExecutionKey=e.flowExecutionKey,this.unsavedChangesPresent=e.unsavedChangesPresent,this.allowDesignerCloseWithValidationErrors=e.allowDesignerCloseWithValidationErrors;var t=e.dataSourceId;if(!t&&e.dataSourcesList&&e.dataSourcesList.first()&&(t=e.dataSourcesList.first().id),!t)return void this.redirectToCreateDomain();this.presentationSelected=e.presentationSelected;var n=e.datasourcesProperties[t]?e.datasourcesProperties[t].schemas:null;this.hasSchemas=n&&n.first(),domain.registerClickHandlers([this.flowControlsClickEventHandler.bind(this),this.stopEventForToolbarButtonsClickEventHandler.bind(this)]),domain.confirmDialog.init(),domain.detailsDialog.init(),this.currentPage=document.body.identify();var i=this.pageInitFactory[this.currentPage]();this.initModule(i,e)},initModule:function(e,t){e&&(e.fillForm&&(dd.fillForm=e.fillForm.bind(e)),e.getValidationPostData&&(dd.getValidationPostData=e.getValidationPostData.bind(e)),e.getCheckDesignValidator&&(dd.getCheckDesignValidator=e.getCheckDesignValidator.bind(e)),e.exportEnabled&&(dd.exportEnabled=e.exportEnabled.bind(e)),e.exportBundleStub&&(dd.exportBundleStub=e.exportBundleStub.bind(e)),dd.initToolbar(e.toolbarActionMap),e.init.bind(e)(t))},initToolbar:function(e){this.toolbarActionMap=Object.extend(this.toolbarActionMap,e),toolbarButtonModule.ACTION_MODEL_TAG=this.ACTION_MODEL_TAG,toolbarButtonModule.initialize(this.toolbarActionMap)},redirectToCreateDomain:function(){document.location=buildActionUrl({flowId:this.CREATE_DS_FLOW})},fillForm:function(){},getValidationPostData:function(){return{}},getCheckDesignValidator:function(){return dd.checkDesignValidator},flowControlsClickEventHandler:function(e){var t=!1;return this.flowControlsEventMap.each(function(n){if(domain.elementClicked(e,n.key)){var i=n.value;if(t=!0,this.currentPage===i.returnOnPage)throw $break;i.flowExecutionKey=this.flowExecutionKey;var a=function(){delete i.returnOnPage,delete i.performValidation,i.flowId=this.FLOW_ID,domain.submitForm(this.formDomId,i,this.fillForm)},o="#done"===n.key&&this.allowDesignerCloseWithValidationErrors;throw i.performValidation?this.getCheckDesignValidator().validate(o,a.bind(this)):a.bind(this)(),$break}}.bind(this)),t},stopEventForToolbarButtonsClickEventHandler:function(e){var t=!1;return $H(this.toolbarActionMap).each(function(n){if(domain.elementClicked(e,"#"+n.key))throw t=!0,$break}.bind(this)),t},checkDesign:function(e,t){var n={flowExecutionKey:this.flowExecutionKey,eventId:"validateSchema"};domain.sendAjaxRequest(n,this.getValidationPostData(),e,t)},checkForEmptySets:function(e){var t={flowExecutionKey:this.flowExecutionKey,eventId:"checkForEmptySets"};domain.sendAjaxRequest(t,{},e)},deleteEmptySets:function(e,t){var n={flowExecutionKey:this.flowExecutionKey,eventId:"deleteEmptySets"},i={emptySets:Object.toJSON(e)};domain.sendAjaxRequest(n,i,t)},exportToXml:function(e){var t={flowExecutionKey:this.flowExecutionKey,eventId:"exportToXML"};this.hasSchemas&&(t.exportSchemaPrefix=!!e),domain.submitForm(this.formDomId,t,null)},generateAndDownloadBundles:function(e,t,n,i){var a={flowExecutionKey:this.flowExecutionKey,eventId:"bundle"},o={generateDescrKey:!!e,generateLabelKey:!!t},d=function(e){"success"===e&&(n&&i?i.done(this.downloadBundleStubs.bind(this)):this.downloadBundleStubs(),n&&n())};domain.sendAjaxRequest(a,o,d.bind(this))},downloadBundleStubs:function(){var e={flowExecutionKey:this.flowExecutionKey,eventId:"downloadBundleStubs"};domain.submitForm(this.formDomId,e,null)},validateForCalcFields:function(e,t,n){var i={flowExecutionKey:this.flowExecutionKey,eventId:"validateDeletedTablesForCalcFields"},a={deletedTablesIds:e,isRealTables:t};domain.sendAjaxRequest(i,a,n)},changeTableAlias:function(e,t,n){var i={};i[e]=t;var a={flowExecutionKey:dd.flowExecutionKey,eventId:"changeTableAlias"},o={aliasChangesMap:Object.toJSON(i)};domain.sendAjaxRequest(a,o,n)},createTreeNodesMap:function(e){var t=function(e,n){e&&(n[e.param.id]=e,e.isParent()&&e.childs.each(function(e){t(e,n)}))};e.treeMap={},e.getRootNode().childs.each(function(n){t(n,e.treeMap)})},deleteNodesFromTreeById:function(e,t,n){if(e&&e.first()){var i=function(e){return e.childs.length},a=function(e){return e.parent.removeChild(e)},o=function(e){delete t.treeMap[e.param.id],e.isParent()&&e.childs.each(o)};e.each(function(e){var d=t.treeMap[e];d&&(n.hide([d],i,a),o(d))}.bind(this))}},getTablesUsedForFilters:function(e,t){if(!t.first())return[];var n=t.findAll(function(t){if(!e)return!1;var n=t.param.extra.itemId;return e&&e[n]&&e[n].itemId===n});return n.collect(function(e){return e.param.extra.itemId})},insertAtCaret:function(e,t,n){if(document.selection){if(n||(n=document.selection.createRange()),n.parentElement()!=e)return e.value+=t,!1;e.focus(),n.text=t,n.collapse(!1),n.select()}else if(Object.isNumber(e.selectionStart)&&e.selectionStart>=0){var i=e.getValue(),a=e.selectionStart,o=e.selectionEnd;e.setValue(i.substr(0,a)+t+i.substr(o)),e.focus(),e.setSelectionRange(a,a+t.length)}else e.value+=t},emptyValidator:function(e){return{isValid:e&&e.strip(),errorMessage:domain.getMessage("field.empty")}},itemIdValidator:function(e,t){var n=t.match(dd.WHITELIST_REGEX_PATTERN),i=t.match(dd.BLACKLIST_REGEX_PATTERN);return{isValid:!t||null!=n&&null==i,errorMessage:domain.getMessage(e)}},nonEmptyItemIdValidator:function(e){var t=e.match(dd.WHITELIST_REGEX_PATTERN),n=e.match(dd.BLACKLIST_REGEX_PATTERN);return{isValid:e&&e.strip()&&null!=t&&null==n,errorMessage:domain.getMessage("id.invalid")}},escapeJsonValidator:function(e){return{isValid:!e||!e.match(/[\?]+/g),errorMessage:domain.getMessage("field.invalid")}}};var dd=domain.designer;dd.confirmAndLeave=function(){return dd.isUnsavedChangesPresent()?confirm(domain.getMessage("exitMessage")):!0},dd.setUnsavedChangesPresent=function(e){dd.unsavedChangesPresent=!!e},dd.isUnsavedChangesPresent=function(){return dd.unsavedChangesPresent},dd.toolbarActionMap={checkDesign:"dd.validateDesign",exportSchema:"dd.exportSchema",exportBundleStub:"dd.exportBundleStub"},dd.toolbarEnableMap={exportSchema:function(){return dd.exportEnabled()},exportBundleStub:function(){return dd.exportEnabled()}},dd.updateToolBarButtons=function(){$H(dd.toolbarEnableMap).each(function(e){toolbarButtonModule.setButtonState(e.key,e.value())})},dd.exportSchema=function(){dd.exportSchemaValidator.validate(dd.exportToXml.bind(dd))},dd.isPresentationSelected=function(){return dd.presentationSelected},dd.exportBundleStub=function(){dd.exportBundlesValidator.validate(dd.generateAndDownloadBundles.bind(dd))},dd.exportEnabled=function(){return dd.presentationSelected},dd.validateDesign=function(){dd.getCheckDesignValidator().validate(!1)},dd.pageInitFactory={domainDesigner_tables:function(){return dd_tables},domainDesigner_derivedTables:function(){return dd_derivedTables},domainDesigner_joins:function(){return dd_joins},domainDesigner_calculatedFields:function(){return dd_calcFields},domainDesigner_filters:function(){return dd_filters},domainDesigner_display:function(){return dd_display}},dd.flowControlsEventMap=$H({"#tablesTab":{returnOnPage:dd.TABLES_VIEW,eventId:"tables"},"#derivedTablesTab":{returnOnPage:dd.DERIVED_TABLES_VIEW,eventId:"query"},"#joinsTab":{returnOnPage:dd.JOINS_VIEW,eventId:"joins"},"#calcFieldsTab":{returnOnPage:dd.CALC_FIELDS_VIEW,eventId:"calcFields"},"#preFiltersTab":{returnOnPage:dd.FILTERS_VIEW,eventId:"filters"},"#displayTab":{returnOnPage:dd.DISPLAY_VIEW,eventId:"design"},"#done":{eventId:"done",performValidation:!0},"#cancelButton":{eventId:"cancel"}});