var localContext={PRINT_DIALOG_TIMEOUT:3e3,CONTROL_FRAME:"controlFrame",CONTENT_FRAME:"contentFrame",TEXT_FRAME:"textFrame",CLICKABLE_FRAME:"clickableFrame",CONTAINER_ID_STUB:"Container",DASHBOARD_VIEWER_PARAM:"&dashboardViewer=true",CONTROL_PREFIX:"input_",HIDDEN_PARAM_PREFIX:"hidden_",CONTENT_FRAME_PREFIX:"contentFrame_",timers:[],buttonIdToAction:{},VIEW_DOM_ID:"dashboardViewer",NOTHING_SUBSTITUTE:"~NOTHING~",CONTENT_FRAME_PATTERN:"div.componentContainer.iframe",CONTROL_BUTTON_PATTERN:"div.componentContainer.control.actionButton>button.action",FLOATING_BUTTON_PATTERN:"div.floatingMenu button.button",controlsController:null,CUSTOM_RESOURCE_TYPE:"customResourceType",CUSTOM_URL_IFRAME_TIMEOUT:1e4,customUrlLoadingTimeouts:{},getMode:function(){return designerBase.DASHBOARD_RUNTIME},_isHoverSupported:function(){try{return!window.frameElement||jQuery(window.frameElement).hasClass("outerDashboardFrame")}catch(t){return!0}},initDashboardViewEvents:function(){$(this.VIEW_DOM_ID).observe("mouseover",function(t){var e=null,a=t.element();isIPad()||(e=matchAny(a,[this.CONTENT_FRAME_PATTERN],!0),e&&this._isHoverSupported()&&e.addClassName("over"))}.bind(this)),$(this.VIEW_DOM_ID).observe("mouseout",function(t){var e=null,a=t.element();e=matchAny(a,[this.CONTENT_FRAME_PATTERN],!0),e&&this._isHoverSupported()&&e.removeClassName("over")}.bind(this)),$(this.VIEW_DOM_ID).observe("click",function(t){var e=null,a=null,n=null,r=t.element();if(e=matchAny(r,[this.CONTROL_BUTTON_PATTERN],!0)){a=/[A-Za-z]+$/;var o=e.identify();n=a.exec(o)[0],n&&this.buttonIdToAction[n]()}if(e=matchAny(r,[this.FLOATING_BUTTON_PATTERN],!0)){a=/[A-Za-z]+_\d+$/;var i=e.identify();if(n=a.exec(i)[0])if(i.startsWith("refresh_")){var s=$("containerOverlay_"+n);if(s){{s.getAttribute("data-isCustom")}this.refreshIFrame(n)}}else i.startsWith("open_")&&this._getDrillThroughSource(n)}}.bind(this))},initButtonIdToActionFunctions:function(){this.buttonIdToAction={submit:_.bind(this.submitInputControlParams,this),reset:_.bind(this.resetInputControlParams,this),print:_.bind(this.printDashboard,this)}},_initAllFrameSources:function(t){if(t){{this._hasSubmitButton()?!0:!1}this._updateIFrameSRCParams(!paramsChanged,!0)}else contentFrames.each(function(t){var e=$(this.CONTENT_FRAME_PREFIX+t.frameName);this.loadIframe(e,t.src,t.resourceType===this.CUSTOM_RESOURCE_TYPE)}.bind(this))},loadDashboard:function(){this.controlsController=new JRS.Controls.DashboardRuntimeController({reportUri:"/dashboard/viewer/"+clientKey,viewModel:new JRS.Controls.DashboardRuntimeViewModel}),this._isPrintableWindow()&&(this._hideControlButtons(),this._updateIFrameSRCParams(!0,!0)),controlFrames.length>0?(this.controlsController.fetchControlsStructure(this.getInitialControlValues(!0)).always(_.bind(this._initAllFrameSources,this,!0)),JRS.Controls.listen({"viewmodel:values:changed":_.bind(function(){!this._hasSubmitButton()&&this.submitInputControlParams()},this)})):this._initAllFrameSources(!0),this.initDashboardViewEvents(),this.initButtonIdToActionFunctions(),JRS.reportExecutionCounter.check()},getInitialControlValues:function(t){var e={};return _.each(controlFrames,_.bind(function(t){e[t.paramName]=t.paramValue},this)),t?_.extend(e,this.getHiddenParamValuesForControls()):e},getHiddenParamValuesForControls:function(){var t={};return hiddenParams.length>0&&_.each(controlFrames,_.bind(function(e){var a=this.getHiddenParamValue(e.paramName);a&&(t[e.paramName]=a)},this)),t},getHiddenParamValue:function(t){var e=[];return _.each(hiddenParams,function(a){a.paramName===t&&e.push(a.paramValue)}),e.length>0?e:null},setRefreshTimer:function(t,e){var a=this._convertFromMinToMilliSecs(e);this.timers[t]=setInterval("localContext.refreshIFrame('"+t+"')",a)},refreshIFrame:function(t){var e=$(this.CONTENT_FRAME_PREFIX+t);if(e)try{this._showFrameLoadingImage(e);var a=_.find(contentFrames,function(e){return e.frameName===t});this.loadIframe(e,e.src,a.resourceType===this.CUSTOM_RESOURCE_TYPE)}catch(n){}},_convertFromMinToMilliSecs:function(t){return 6e4*parseInt(t)},_getDrillThroughSource:function(t){var e=this._getIFrameByName(t);if(e){var a=e.src;a=a.replace("&viewAsDashboardFrame=true",""),a=a.replace(localContext.DASHBOARD_VIEWER_PARAM,""),launchNewWindow(a)}},_getIFrameByName:function(t){var e=this.CONTENT_FRAME+"_"+t;return $(e)},_getControlFrameObjectByName:function(t){var e=null;return controlFrames.each(function(a){if(a.frameName===t)throw e=a,$break}),e},_getControlFrameObjectByParamName:function(t){var e=null;return controlFrames.each(function(a){if(a.paramName===t)throw e=a,$break}),e},_getFrameContainerByName:function(t,e){var a=t+localContext.CONTAINER_ID_STUB+"_"+e;return $(a)},_getSelectedValuesForControlFrame:function(t){return this.controlsController.getViewModel().get("selection")[t.paramName]},_setSelectedValuesForControlFrame:function(t,e){var a=null,n=t.dataType,r=null,o=null,i=null,s=null,l=document.getElementsByName(this.CONTROL_PREFIX+t.paramName);if(l.length>0?o=l[0].type:(a=document.getElementById(this.CONTROL_PREFIX+t.paramName),o=a.type),1==l.length&&(a=l[0]),o)if("text"===o)if("Date"===n){var u=new Date;u.setTime(getDateFromFormat(e,staticDatePattern,!0)),a.value=formatDate(u,localDateFormat)}else if("Timestamp"===n){var u=new Date;u.setTime(getDateFromFormat(e,staticDatePattern,!0)),a.value=formatDate(u,localDateTimeFormat)}else a.value=e;else if("select-one"===o)for(s=a.options.length,r=0;s>r;r++)i=a.options[r],i.value===e&&(a.selectedIndex=r);else if("select-multiple"===o){s=a.options.length;var m=e.split("@@");for(r=0;s>r;r++)i=a.options[r],i.selected=m.include(i.value)?!0:!1}else{if("checkbox"!==o&&"radio"!==o)throw"[_setSelectedValuesForControlFrame]: unknown control type!!";for(var c=e.split("@@"),h=0;h<l.length;h++){for(var d=!1,_=0;_<c.length;_++){var f=String(c[_]),T=String(l[h].value);if(f===T){d=!0;break}}l[h].checked=d?"checked":""}}},_formatParamValue:function(t,e){for(var a="",n=t+"=",r=0;r<e.length;r++)a+=n+encodeURIComponent(e[r]),r<e.length-1&&(a+="&");return a},_updateIFrameSRCParams:function(t,e){var a=null,n=null,r=null;contentFrames.each(function(o){var i=o.frameName,s="";if(t||controlFrames.each(function(t){if(a=o[t.paramName]){var e=this._getSelectedValuesForControlFrame(t);n=this._formatParamValue(a,e),r=getSymbolToAppendNextParam(o.src+s),s=s+r+n}}.bind(this)),hiddenParams.each(function(e){a=o[e.paramName]?o[e.paramName]:e.paramName;var r=_.find(controlFrames,function(t){return t.paramName===e.paramName});!a||r&&!t||(n=this._formatParamValue(a,[e.paramValue]),s=s+getSymbolToAppendNextParam(o.src+s)+n)}.bind(this)),e||s){isIPad()||(document.getElementById("contentFrameContainer_"+i).style.backgroundImage="url(themes/default/images/wait_animation_large.gif)");var l=this._getIFrameByName(i);this._showFrameLoadingImage(l),l.className="hidden";var u=o.src.indexOf(localContext.DASHBOARD_VIEWER_PARAM)>-1?"":localContext.DASHBOARD_VIEWER_PARAM,m=o.src+s+(o.src.indexOf("http://")<0?u:"");this.loadIframe(l,m,o.resourceType===this.CUSTOM_RESOURCE_TYPE)}}.bind(this))},loadIframe:function(t,e,a){var n=jQuery(t);if(n.attr("src",e),a){var r=n.attr("id").split(this.CONTENT_FRAME+"_")[1],o=n.parent().parent();o.removeClass("hideLoadingAnimation"),o.find(".externalUrlEmbeddingError").remove(),this.customUrlLoadingTimeouts[r]&&clearTimeout(this.customUrlLoadingTimeouts[r]),this.customUrlLoadingTimeouts[r]=setTimeout(function(){var t=jQuery("<div></div>");t.html(DASHBOARD_CUSTOM_URL_ERROR.replace("\n","<br>")).addClass("externalUrlEmbeddingError"),o.addClass("hideLoadingAnimation").prepend(t)},this.CUSTOM_URL_IFRAME_TIMEOUT)}},_buildHiddenParamsURL:function(){var t="";return controlFrames.each(function(e){var a=this._getSelectedValuesForControlFrame(e);t=t+"&"+this._formatParamValue(this.HIDDEN_PARAM_PREFIX+e.paramName,a)}.bind(this)),hiddenParams.each(function(e){var a=_.find(controlFrames,function(t){return t.paramName===e.paramName});a||(t=t+"&"+this._formatParamValue(this.HIDDEN_PARAM_PREFIX+e.paramName,[e.paramValue]))}.bind(this)),t},submitInputControlParams:function(){this._updateIFrameSRCParams(!1)},resetInputControlParams:function(){var t=this.controlsController.updateControlsValues(this.getInitialControlValues(!1));t.done(function(){this._updateIFrameSRCParams(!1)}.bind(this))},printDashboard:function(){var t=new RegExp("(&)?"+this.HIDDEN_PARAM_PREFIX+"[^=]+=([^&]+)?","g"),e=document.location.toString().replace(t,"");window.open(e+"&JSprint=true&viewAsDashboardFrame=true"+this._buildHiddenParamsURL(),"PrintPreview")},_hideControlButtons:function(){var t=this._hasPrintButton(),e=this._hasResetButton(),a=this._hasSubmitButton();t&&t.addClassName("hidden"),e&&e.addClassName("hidden"),a&&a.addClassName("hidden")},_showPrintButton:function(){this._hasPrintButton()&&$("button_print").removeClassName("hidden")},_updateIFrameLoadingStatus:function(t){var e=null,a=$(t);if(a&&(e=this._getIFrameIDFromOverlay(a),$(e))){$(e).setAttribute("data-iframeLoaded","complete");var n=(Element.up($(t),"DIV"),document.getElementById(e));n&&n.getAttribute("src")&&(0==n.getAttribute("src").indexOf("http")||n.getAttribute("src").indexOf("_flowId=dashboardRuntimeFlow")>0)&&(document.getElementById(e).className=""),Element.show($(e)),this._updateScroll(),$(e).observe("touchstart",cancelEventAndPreventDefault).observe("touchmove",cancelEventAndPreventDefault).observe("touchend",cancelEventAndPreventDefault).observe("orientationchange",cancelEventAndPreventDefault)}},_updateScroll:function(){var t=$("dashboardFrameParent"),e=0,a=0;if(t){var n=$$(".control");if(n.length>0){var r=designerBase.getContentDimensions(n);r.width>0&&(e=r.width),r.height>0&&(a=r.height)}t.setStyle({width:e+"px",height:a+25+"px"})}},_showFrameLoadingImage:function(t,e){var a=$(t).up("DIV");$(a)&&($(a).setStyle({backgroundImage:""}),e?$(t).show():$(t).hide())},_getIFrameIDFromOverlay:function(t){return t?$(t).getAttribute("data-iFrameID"):null},_isPrintableWindow:function(){return document.location.href.indexOf("&JSprint=true")>-1},_isIFrameSrcUpdateable:function(t){return!t||t.indexOf("blank.htm")>-1},_hasSubmitButton:function(){return $("button_submit")},_hasPrintButton:function(){return $("button_print")},_hasResetButton:function(){return $("button_reset")}};