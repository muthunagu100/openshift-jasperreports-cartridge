define(["require","backbone","jquery","actionModel.modelGenerator","adhoc/filter/FilterCollection","json3","namespace","underscore","core.layout","common/util/featureDetection","adhoc/filter/enum/filterDataTypes","adhoc/filter/factory/filterEditorFactory","bundle!AdHocFiltersBundle","jquery.ui.mouse.touch","components.dialog"],function(e){var t=e("backbone"),i=e("jquery"),n=e("actionModel.modelGenerator"),l=e("adhoc/filter/FilterCollection"),r=e("json3"),s=e("namespace"),o=e("underscore"),a=e("core.layout"),h=e("common/util/featureDetection"),c=e("adhoc/filter/enum/filterDataTypes"),d=e("adhoc/filter/factory/filterEditorFactory"),u=e("bundle!AdHocFiltersBundle");e("jquery.ui.mouse.touch"),e("components.dialog");var f=s.components.ConfirmDialog;return t.View.extend({collectionConstructor:l,events:function(){var e={"click .button.action.primary":"applyFilters","click .button.minimize":"markPanelStateAsManuallyChanged"};return h.supportsTouch?e["click #filterPanelMutton"]="showFiltersMenu":e["mouseover #filterPanelMutton"]="showFiltersMenu",e}(),initialize:function(e){this.onApply=e.onApply,this.onStateUpdate=e.onStateUpdate,this.onFilterRemove=e.onFilterRemove,this.resetFilterPanelState=e.resetFilterPanelState,this.service=e.service,this.clientKey=e.clientKey,this.collection=e.collection||new l([],{service:this.service,isOlap:this.isOlap}),this._filtersChanged=!1,this.confirmDialog=new f,o.bindAll(this,"addFilter","addSliceFilter","updateFilter","toggleFilter","minimizeAllFilters","maximizeAllFilters","deleteAllFilters","onMove"),this.filtersMenuActionModel=this.createFiltersMenuActionModel(),this.once("reset:panel",this.resetFilterPanelState),this.on("reset:panel",this.render),this.on("change:filters",this.toggleApplyButtonState),this.on("invalid:filters",this.showFilterServerError),this.listenTo(this.collection,"reset",this.recreateFilterEditors),this.listenTo(this.collection,"add",this.addFilterEditor),this.listenTo(this.collection,"remove",this.removeFilterEditor),this.listenTo(this.collection,"destroy",this.deleteFilter),this.listenTo(this.collection,"destroyConfirm",this.removeConfirm),this.listenTo(this.collection,"move",this.onMove),this.listenTo(this.collection,"toggle",this.toggleFilter),this.listenTo(this.collection,"operationChange",this.updateFilter),this.listenTo(this.collection,"validated",this.toggleApplyButtonState),this.listenTo(this.collection,"change:value change:isAnyValue add remove operationChange",o.partial(this.setFiltersChanged,!0)),this.sizerEl=this.$(".sizer:eq(0)")[0]},markPanelStateAsManuallyChanged:function(){a.manuallyChangePanelState("filters",this.clientKey,!0)},unmarkPanelStateAsManuallyChanged:function(){a.manuallyChangePanelState("filters",this.clientKey,!1)},onPanelResize:function(){this.filterEditors&&o.invoke(this.filterEditors,"resizeTitle")},hasNotAppliedFilters:function(){return this._filtersChanged},setFiltersChanged:function(e){this._filtersChanged=e,this.trigger("change:filters")},render:function(){this.$("#filter-container ul.filters").empty();var e=document.createDocumentFragment();return o.each(this.filterEditors,function(t){e.appendChild(t.el)}),this.$("#filter-container ul.filters").html(e),this.initSortable(),this.resizeFilterEditorTitles(),this},initSortable:function(){this.$el.sortable({delay:200,handle:".header",items:"#filter-container li.filter",axis:"y",start:function(e,t){t.item.data("oldIndex",t.item.index())},stop:o.bind(function(e,t){var i=t.item.data("oldIndex"),n=t.item.index();i!=n&&this.moveFilter(this.collection.at(i),i,n)},this)})},createFiltersMenuActionModel:function(){var e={};return e[this.cid]=[n.createMenuElement("simpleAction",{text:u.ADH_1220_DYNAMIC_FILTER_MINIMIZE_ALL,action:this.minimizeAllFilters}),n.createMenuElement("simpleAction",{text:u.ADH_1221_DYNAMIC_FILTER_MAXIMIZE_ALL,action:this.maximizeAllFilters}),n.createMenuElement("separator"),n.createMenuElement("simpleAction",{text:u.ADH_1219_DYNAMIC_FILTER_REMOVE_ALL,action:this.deleteAllFilters})],e},removeFilterEditor:function(e){var t=this._getFilterEditorByModel(e);t&&this.stopListening(t,"uiChange:filters",this.onFilterEditorUIChanged),t&&t.remove(),this.$el.sortable("refresh")},addFilterEditor:function(e){a.maximize(this.el,!0),this.unmarkPanelStateAsManuallyChanged();var t=this.createEditor(e);o.isArray(this.filterEditors)||(this.filterEditors=[]),this.filterEditors.push(t),this.$("#filter-container ul.filters").append(t.$el),o.defer(o.bind(t.resizeTitle,t)),this.$el.sortable("refresh")},resizeFilterEditorTitles:function(){o.invoke(this.filterEditors||[],"resizeTitle")},onFilterEditorUIChanged:function(e){setTimeout(o.bind(this.resizeFilterEditorTitles,this),100),e.valueEditorUIChanged&&e.el===o.last(this.$(".leaf.filter"))&&setTimeout(o.bind(function(){this.$("> .content > .body").scrollTop(o.reduce(this.$(".leaf.filter"),function(e,t){return e+i(t).height()},0))},this),50),e.valueEditorUIChanged=!0},showFiltersMenu:function(e){n.showDynamicMenu(this.cid,e.originalEvent,"menu vertical dropDown fitable",null,this.filtersMenuActionModel),e.stopPropagation()},recreateFilterEditors:function(){this.cleanUpEditors(),this.filterEditors=this.collection.map(function(e){return this.createEditor(e)},this),this.trigger("reset:panel")},cleanUpEditors:function(){var e=this;o.each(this.filterEditors,function(t){e.stopListening(t,"uiChange:filters",e.onFilterEditorUIChanged)}),o.invoke(this.filterEditors||[],"remove")},createEditor:function(e){var t=d(e.isReadOnly()?c.READ_ONLY:e.get("filterDataType"),this.isOlap),i=t(e);return this.listenTo(i,"uiChange:filters",this.onFilterEditorUIChanged),i},showFilterServerError:function(e,t){this.$("#filterMessage span").html(t)},onMove:function(e,t){var i=this._getFilterEditorByModel(e),n=i.$el.index(),l=t.direction;0>l&&0===n||l>0&&n===this.collection.length-1||(-1===l?i.$el.insertBefore(this.$("#filter-container li.filter:eq("+(n+l)+")")):i.$el.insertAfter(this.$("#filter-container li.filter:eq("+(n+l)+")")),this.$el.sortable("refreshPositions"),this.moveFilter(e,n,n+l))},removeConfirm:function(e){this.confirmDialog.show({ok:o.bind(function(){var t=this._getFilterEditorByModel(e);t.removeFilter({force:!0})},this),messages:u.ADH_1230_DYNAMIC_FILTER_ADVANCED_CONFIRM_REMOVE})},_getFilterEditorByModel:function(e){return o.find(this.filterEditors,function(t){return e.cid===t.model.cid})},hasFilterForField:function(e){return!o.isEmpty(this.collection.where({name:e}))},toggleApplyButtonState:function(){this._filtersChanged&&this.collection.every(function(e){return e.get("filterDataType")===c.READ_ONLY?!0:e.isValid()})?this.enableApplyButton():this.disableApplyButton()},disableApplyButton:function(){this.$("#applyFilter > button.action").attr("disabled","disabled").removeClass("over")},enableApplyButton:function(){this.$("#applyFilter > button.action").removeAttr("disabled")},setFilters:function(e,t){this.setFiltersChanged(e.isFiltersDraft);var i=t&&t.reset?"reset":"set";this.collection[i](e.existingFilters)},getFilters:function(){return this.service.get().done(o.bind(function(e){this.setFilters(e,{reset:!0})},this))},addFilter:function(e){var t=!o.isEmpty(e)&&e[0].fieldName?"fieldName":"name";return this.service.add(o.pluck(e,t)).done(o.bind(function(e){this.collection.set(e.existingFilters),this.onStateUpdate(e)},this))},addSliceFilter:function(e,t){var i=o(t).filter(function(e){return"true"!==e.isSummary}).map(function(e){return e.path}).uniq();return this.service.addSlice(t[0].axis,"true"===e,i).done(o.bind(function(e){this.onApply(e),a.maximize(this.el,!0),this.setFilters(e,{reset:!0}),this.unmarkPanelStateAsManuallyChanged()},this))},updateFilter:function(e){return e.isValid(!0)?e.saveValue().done(o.bind(function(t){var i=o.findWhere(t.existingFilters,{id:e.id});i&&e.set(i,{silent:!0}),this.onStateUpdate(t)},this)):void 0},_deleteFilterDoneCallback:function(e,t){this.collection.set(t.existingFilters),this.onStateUpdate(t),this.onFilterRemove([e])},deleteFilter:function(e){return this.service.remove(e.id).done(o.bind(this._deleteFilterDoneCallback,this,e.toJSON()))},_deleteAllFiltersDoneCallback:function(e,t){this.collection.reset(t.existingFilters),this.onStateUpdate(t),this.onFilterRemove(e),this.setFiltersChanged(!0)},deleteAllFilters:function(){return this.service.removeAll().done(o.bind(this._deleteAllFiltersDoneCallback,this,this.collection.toJSON()))},moveFilter:function(e,t,i){return this.service.reorder(t,i).done(o.bind(function(e){this.collection.set(e.existingFilters),this.onStateUpdate(e)},this))},toggleFilter:function(e){return this.service.toggleVisibility(e.get("id"))},minimizeAllFilters:function(){return this.collection.invoke("set","filterPodMinimized",!0),this.service.minimizeAll()},maximizeAllFilters:function(){return this.collection.invoke("set","filterPodMinimized",!1),this.service.maximizeAll()},applyFilters:function(){return this.$("#filterMessage span").empty(),this.setFiltersChanged(!1),this.service.applyFiltersAndExpression(this.collection.toExpression(),"").done(o.bind(function(e){this.setFilters(e),this.onApply(e)},this)).fail(o.bind(function(e){var t=r.parse(e.responseText);t.editFilterError&&this.collection.trigger("invalid:filters",this.collection,t.editFilterError)},this))}})});