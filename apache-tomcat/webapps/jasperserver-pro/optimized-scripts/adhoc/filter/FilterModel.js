define(["require","underscore","jquery","backbone","bundle!AdHocFiltersBundle","common/util/parse/number","adhoc/filter/filterModelTrait/dateRangeFilterModelTrait","adhoc/filter/filterModelTrait/listFilterModelTrait","adhoc/filter/filterModelTrait/literalFilterModelTrait","adhoc/filter/filterModelTrait/rangeFilterModelTrait","adhoc/filter/filterModelTrait/readOnlyFilterModelTrait","adhoc/filter/enum/filterDataTypes","adhoc/filter/enum/filterExpressionTypes","adhoc/filter/enum/filterOperators","adhoc/filter/factory/filterModelValidationFactory","adhoc/filter/factory/filterModelExpressionTypeFactory","adhoc/filter/factory/filterModelDefaultValueFactory","adhoc/filter/format/OlapFilterValueFormatter","common/component/singleSelect/dataprovider/DataProviderNew","common/component/singleSelect/dataprovider/ValueFormattingDataProvider","settings!adhocFilterSettings","adhoc/filter/validation/backboneValidationExtensions"],function(e){function t(e){return e===E.TIMESTAMP||e===E.DATE}function i(e){return e===E.BOOLEAN}function a(e){return e===E.TIME}function r(e){return e===E.STRING}function n(e){return e===E.INTEGER||e===E.DECIMAL||e===E.LONG||e===E.NUMERIC}var l=e("underscore"),s=e("jquery"),o=e("backbone"),u=e("bundle!AdHocFiltersBundle"),d=e("common/util/parse/number"),h=e("adhoc/filter/filterModelTrait/dateRangeFilterModelTrait"),f=e("adhoc/filter/filterModelTrait/listFilterModelTrait"),p=e("adhoc/filter/filterModelTrait/literalFilterModelTrait"),c=e("adhoc/filter/filterModelTrait/rangeFilterModelTrait"),T=e("adhoc/filter/filterModelTrait/readOnlyFilterModelTrait"),E=e("adhoc/filter/enum/filterDataTypes"),A=e("adhoc/filter/enum/filterExpressionTypes"),y=e("adhoc/filter/enum/filterOperators"),N=e("adhoc/filter/factory/filterModelValidationFactory"),m=e("adhoc/filter/factory/filterModelExpressionTypeFactory"),_=e("adhoc/filter/factory/filterModelDefaultValueFactory"),v=e("adhoc/filter/format/OlapFilterValueFormatter"),g=e("common/component/singleSelect/dataprovider/DataProviderNew"),D=e("common/component/singleSelect/dataprovider/ValueFormattingDataProvider"),V=e("settings!adhocFilterSettings");e("adhoc/filter/validation/backboneValidationExtensions");var O={};O[A.LITERAL]=p,O[A.LIST]=f,O[A.DATE_RANGE]=h,O[A.RANGE]=c,O[A.READ_ONLY]=T;var S={DATA_CHOOSER_NO_PROMPT:"ADH_1215_DYNAMIC_FILTER_UNEDITABLE_TITLE",SLICE_COMPLEX_KEEPONLY:"ADH_1208_DYNAMIC_FILTER_KEEP",SLICE_COMPLEX_EXCLUDE:"ADH_1209_DYNAMIC_FILTER_EXCLUDE"},M=o.Model.extend({initialize:function(e,t){this.service=t.service,this.isOlap=t.isOlap,V=l.defaults(V||{},{availableItemsPageSizeOlap:"999",availableItemsPageSize:"999"}),this.dataProvider=new g({pageSize:this.isOlap?+V.availableItemsPageSizeOlap:+V.availableItemsPageSize,request:new D({request:l.bind(this._requestValues,this),format:this.isOlap?new v(this.get("isFirstLevelInHierarchyAll")).format:null}).getData,controlGetTotal:!0,saveLastCriteria:!0}),this.removeAvailableData(),this.removeMinMaxValues(),this.on("change:operatorName",this._onOperatorNameChange),this.on("change:expressionType",this._onExpressionTypeChange),this._updateModelBehavior()},_requestValues:function(e){var t=this.get("showLoading");return this.service.fetchValues(this.get("name"),e,t)},setShowLoading:function(e){this.set("showLoading",e,{silent:!0})},removeAvailableData:function(){this.dataProvider.clear()},removeMinMaxValues:function(){this._minMaxValuesDeferred=null,this.minValue=null,this.maxValue=null},fetchDataForChangeFilterType:function(){return this.dataProvider.getData({offset:0,limit:1})},fetchMinMaxValues:function(){var e=this;return this._minMaxValuesDeferred||(this._minMaxValuesDeferred=this.service.getMaxMinValues(this.get("name")).done(function(t){var i=t.maxMin;e.minValue=i[0],e.maxValue=i[1]})),this._minMaxValuesDeferred},loadAdditionalServerData:function(e){var t=this;return this.additionalServerDataDeferred(e).done(function(){t._setValue()})},additionalServerDataDeferred:function(e){var t=new s.Deferred;return t.resolve(),this.isString()&&l.include([y.IN,y.NOT_IN,y.EQUALS,y.NOT_EQUAL],this.get("operatorName"))?e||(t=s.when(this.fetchDataForChangeFilterType())):(this.isNumber()||this.isDate()||this.isTime())&&(l.include([y.IN,y.NOT_IN],this.get("operatorName"))?e||(t=s.when(this.fetchDataForChangeFilterType())):l.include([y.LESS,y.LESS_OR_EQUAL,y.GREATER,y.GREATER_OR_EQUAL,y.BETWEEN,y.NOT_BETWEEN,y.BETWEEN_DATES,y.NOT_BETWEEN_DATES],this.get("operatorName"))&&(t=s.when(this.fetchMinMaxValues()))),t},_onOperatorNameChange:function(){var e=this.previousAttributes();"undefined"!=typeof e.operatorName&&e.operatorName===y.IN&&this.get("operatorName")!==y.IS_ANY_VALUE&&this.get("isAnyValue")&&this.set("isAnyValue",!1,{silent:!0});var t=m(this.get("filterDataType"),this.get("operatorName"));this.set("expressionType",t,{silent:!0}),this.trigger("change:expressionType",this,this.get("expressionType"))},saveValue:function(){return this.service.update(this.get("id"),this.toExpression())},_onExpressionTypeChange:function(){var e=this;this._updateModelBehavior(),this.loadAdditionalServerData().done(function(){e.trigger("operationChange",e)})},_updateModelBehavior:function(){this._updateInstanceWithTrait(),this._updateInstanceWithValidation()},_setValue:function(){if(!this.isReadOnly()){var e=this.previousAttributes();if(!l.isEmpty(e)&&this._isDefaultValueSelected(e))this._setDefaultValue();else{var t=this.get("value"),i=[y.EQUALS,y.NOT_EQUAL],a=[y.CONTAINS,y.NOT_CONTAINS,y.STARTS_WITH,y.NOT_STARTS_WITH,y.ENDS_WITH,y.NOT_ENDS_WITH],r=[y.IN,y.NOT_IN];l.include(a,e.operatorName)&&l.include(i,this.get("operatorName"))?this._setDefaultValue():(this.isString()||this.isBoolean())&&l.include(i,e.operatorName)&&l.include(r,this.get("operatorName"))?this.set({value:[t]},{silent:!0,validate:!0}):e.expressionType===A.LIST&&this.get("expressionType")===A.LITERAL?this.set({value:l.isArray(t)?t[0]:t},{silent:!0,validate:!0}):e.expressionType===A.LIST&&l.include([A.RANGE,A.DATE_RANGE],this.get("expressionType"))?this.set({value:[t[0],t[t.length-1]]},{silent:!0,validate:!0}):l.include([y.EQUALS,y.NOT_EQUAL],e.operatorName)&&l.include([A.RANGE,A.DATE_RANGE],this.get("expressionType"))?this.set({value:[t,t]},{silent:!0,validate:!0}):l.include([y.GREATER,y.GREATER_OR_EQUAL],e.operatorName)&&l.include([A.RANGE,A.DATE_RANGE],this.get("expressionType"))?this.set({value:[t,this.maxValue]},{silent:!0,validate:!0}):l.include([y.LESS,y.LESS_OR_EQUAL],e.operatorName)&&l.include([A.RANGE,A.DATE_RANGE],this.get("expressionType"))?this.set({value:[this.minValue,t]},{silent:!0,validate:!0}):l.include([A.RANGE,A.DATE_RANGE],e.expressionType)&&this.get("expressionType")===A.LIST?this._setDefaultValue():l.include([A.RANGE,A.DATE_RANGE],e.expressionType)&&l.include([y.EQUALS,y.NOT_EQUAL,y.GREATER,y.GREATER_OR_EQUAL],this.get("operatorName"))?this.set({value:t[0]},{silent:!0,validate:!0}):l.include([A.RANGE,A.DATE_RANGE],e.expressionType)&&l.include([y.LESS,y.LESS_OR_EQUAL],this.get("operatorName"))&&this.set({value:t[t.length-1]},{silent:!0,validate:!0}),this.isValid(!0)||this._setDefaultValue()}}},_getDefaultValue:function(){return _(this.get("filterDataType"),this.get("operatorName"),this.isOlap,this.additionalModelDataForDefaultValue())},_setDefaultValue:function(){this.set(this._getDefaultValue(),{silent:!0,validate:!0})},_isDefaultValueSelected:function(e){var t=_(this.get("filterDataType"),e.operatorName,this.isOlap,this.additionalModelDataForDefaultValue()),i={value:e.value,isAnyValue:e.isAnyValue};return M.valueObjectsAreEqual(i,t)},additionalModelDataForDefaultValue:function(){var e=[];if(this.dataProvider.dataCacheTotal>0){var t=this.dataProvider.dataCache.slice(0,this.dataProvider.pageSize);e=l.map(t,function(e){return e.value})}return{min:this.minValue,max:this.maxValue,values:e,allValuesLoaded:this.dataProvider.dataCacheTotal<=this.dataProvider.pageSize}},set:function(e,t,i){var a;return null==e?this:("object"==typeof e?(a=e,i=t):(a={})[e]=t,i||(i={}),a=M.normalizeAttributes(a),o.Model.prototype.set.call(this,a,i))},_updateInstanceWithTrait:function(){return l.extend(this,O[this.get("expressionType")])},_updateInstanceWithValidation:function(){this.validation=N(this.get("filterDataType"),this.get("operatorName"))},toExpression:function(){var e=this.get("operatorName");(this.isTime()||this.isNumber())&&(e===y.BETWEEN?e=y.IN:e===y.NOT_BETWEEN&&(e=y.NOT_IN)),this.get("isAnyValue")&&(e=y.IS_ANY_VALUE);var t={type:this.get("operatorType"),name:e,operands:[{type:this.get("filterLabelType"),name:this.get("name")}]};return this.get("isAnyValue")||[].push.apply(t.operands,this._rValue()),[t]},_rValue:function(){var e=this._expressionRValue();return l.isArray(e)?e:[e]},isDate:function(){return t(this.get("filterDataType"))},isBoolean:function(){return i(this.get("filterDataType"))},isTime:function(){return a(this.get("filterDataType"))},isString:function(){return r(this.get("filterDataType"))},isNumber:function(){return n(this.get("filterDataType"))},isReadOnly:function(){return!this.get("editable")}},{normalizeAttributes:function(e){var i=l.clone(e);if(i.hasOwnProperty("expressionAsString")&&delete i.expressionAsString,i.hasOwnProperty("editable")&&(i.editable||(i.filterDataType=E.READ_ONLY,i.operatorName=y.READ_ONLY,i.label=u[S[e.source]||S.DATA_CHOOSER_NO_PROMPT],i.isComplex="complex"===e.name.toLowerCase())),l.isUndefined(i.isAnyValue)&&i.hasOwnProperty("operatorName")&&(i.operatorName===y.IS_ANY_VALUE?(i.isAnyValue=!0,i.operatorName=t(i.filterDataType)?y.BETWEEN_DATES:y.IN):i.isAnyValue=!1),i.hasOwnProperty("operatorName")&&i.hasOwnProperty("filterDataType")){var a=m(i.filterDataType,i.operatorName);l.isUndefined(i.expressionType)&&(i.expressionType=a),a===A.LITERAL&&i.hasOwnProperty("value")&&l.isArray(i.value)&&1===i.value.length&&(i.value=i.value[0])}return i},_isArraysEquals:function(e,t){if(e.length!=t.length)return!1;var i,a={};for(i=0;i<e.length;i++)a[e[i]]=!0;for(i=0;i<t.length;i++)if(!a[t[i]])return!1;return!0},valueObjectsAreEqual:function(e,t){if("undefined"==typeof e.isAnyValue&&t.isAnyValue===!0||"undefined"==typeof t.isAnyValue&&e.isAnyValue===!0||"undefined"!=typeof e.isAnyValue&&"undefined"!=typeof t.isAnyValue&&e.isAnyValue!==t.isAnyValue)return!1;var i=e.value,a=t.value;if(l.isArray(i)&&l.isArray(a))return this._isArraysEquals(i,a);if(l.isArray(i)||l.isArray(a))return!1;var r=d.parseNumber(i),n=d.parseNumber(a);return"undefined"==typeof r&&"undefined"==typeof n?i==a:r==n}});return l.extend(M.prototype,o.Validation.mixin),M});