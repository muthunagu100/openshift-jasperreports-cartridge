define(["require","underscore","jquery","json3","common/component/dialog/Dialog","common/component/dialog/AlertDialog","common/component/panel/Panel","common/component/tree/Tree","common/component/tree/TreeDataLayer","common/component/panel/trait/tabbedPanelTrait","common/component/tree/plugin/TooltipPlugin","common/component/tree/plugin/SearchPlugin","common/component/tree/plugin/InfiniteScrollPlugin","common/component/tree/plugin/NoSearchResultsMessagePlugin","jrs.configs","common/enum/repositoryResourceTypes","bundle!adhoc_messages","common/util/browserDetection","text!adhoc/datachooser/template/datachooserDialogTemplate.htm","text!adhoc/datachooser/template/sidebarTreeLeafTemplate.htm","text!adhoc/datachooser/template/datachooserTabTemplate.htm"],function(e){function t(e){switch(e.value.resourceType){case T.REPORT_UNIT:e.cssClass="topic";break;case T.DOMAIN_TOPIC:e.cssClass="domain topic";break;case T.SEMANTIC_LAYER_DATA_SOURCE:e.cssClass="domain";break;case b:e.cssClass="olap"}return e}var o=e("underscore"),i=e("jquery"),r=e("json3"),a=e("common/component/dialog/Dialog"),s=e("common/component/dialog/AlertDialog"),n=(e("common/component/panel/Panel"),e("common/component/tree/Tree")),l=e("common/component/tree/TreeDataLayer"),c=e("common/component/panel/trait/tabbedPanelTrait"),h=e("common/component/tree/plugin/TooltipPlugin"),u=e("common/component/tree/plugin/SearchPlugin"),p=e("common/component/tree/plugin/InfiniteScrollPlugin"),d=e("common/component/tree/plugin/NoSearchResultsMessagePlugin"),m=e("jrs.configs").contextPath,T=e("common/enum/repositoryResourceTypes"),g=e("bundle!adhoc_messages"),_=e("common/util/browserDetection"),f=e("text!adhoc/datachooser/template/datachooserDialogTemplate.htm"),D=e("text!adhoc/datachooser/template/sidebarTreeLeafTemplate.htm"),y=e("text!adhoc/datachooser/template/datachooserTabTemplate.htm"),C="reportType",b="olapCube",O=22,E="decorate",R="embeddedDesigner",A="list",I=5e3,S="&recursive=true",v="&recursive=false",N=m+"/rest_v2/api/resources?{{= id != '@fakeRoot' ? 'folderUri=' + id : ''}}",w="&type="+T.DOMAIN_TOPIC+"&type="+T.TOPIC+"&type="+T.SEMANTIC_LAYER_DATA_SOURCE,L="&type="+T.SECURE_MONDRIAN_CONNECTION+"&type="+T.MONDRIAN_CONNECTION+"&type="+T.XMLA_CONNECTION,P="&offset={{= offset }}&limit={{= limit }}&forceTotalCount=true&forceFullPage=true",U=N+v+"&containerType="+T.FOLDER,H=N+S+P,x=[T.MONDRIAN_CONNECTION,T.SECURE_MONDRIAN_CONNECTION,T.XMLA_CONNECTION];return a.extend({events:{resize:"onResizeHeight"},onResizeHeight:function(){this.$contentContainer.height(this.$el.height()-this._resizableContainerShiftHeight),this.listTreeView.rootLevel.list.$el.height(this.$el.height()-this._resizableContainerShiftHeight),this.hierarhicalTreeView.rootLevel.list.$el.height(this.$el.height()-this._resizableContainerShiftHeight)},constructor:function(e){e||(e={}),this._dfdRenderSerachFormTo=i.Deferred();var s=this._getParameterByName(C);s=s||"crosstab",this.reportType="chart"===s?"ichart":s,this.decorate=this._getParameterByName(E)||"yes",this.isEmbeddedDesigner=this._getParameterByName(R);var _=U+w;_+="table"===this.reportType?P:L+P;var b=n.use(h).use(p).create(),A=o.union([T.TOPIC,T.DOMAIN_TOPIC,T.SEMANTIC_LAYER_DATA_SOURCE],x),S=n.use(h).use(d).use(u,{additionalParams:{type:"table"===this.reportType?o.first(A,3):A},dfdRenderTo:this._dfdRenderSerachFormTo}).create(),v={treeNodeProcessor:{processItem:function(e){return e._node=o.contains(o.union([T.FOLDER],x),e.value.resourceType),e}},filterPublicFolderProcessor:{processItem:function(e){return"/public"!==e.value.uri?e:void 0}},filterTempFolderProcessor:{processItem:function(e){return-1===e.value.uri.indexOf("/temp")?e:void 0}},filterEmptyFoldersProcessor:{processItem:function(e){return"folder"!==e.value.resourceType||""!==e.value._links.content?e:void 0}},cssClassItemProcessor:{processItem:t}},N=new l({requestType:"POST",dataUriTemplate:m+"/rest_v2/connections",processors:[v.cssClassItemProcessor],levelDataId:"uri",getDataArray:function(e){return e&&e[T.RESOURCE_LOOKUP]?e[T.RESOURCE_LOOKUP]:[]}}),k=function(e){var t=o.contains(x,e.resource.resourceType);if(t){var i=o.clone(this.customDataLayers.olapDataLayer);return o.extend(i,{accept:"application/repository."+e.resource.resourceType+".metadata+json",contentType:"application/repository."+e.resource.resourceType+"+json",data:r.stringify(e.resource)}),i}return this.customDataLayers&&this.customDataLayers[e.id]?this.customDataLayers[e.id]:this.defaultDataLayer};this.hierarhicalTreeView=b.instance({itemsTemplate:D,listItemHeight:O,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,bufferSize:I,additionalCssClasses:"folders",dataUriTemplate:_,levelDataId:"uri",customDataLayers:{"/":o.extend(new l({dataUriTemplate:m+"/flow.html?_flowId=searchFlow&method=getNode&provider=repositoryExplorerTreeFoldersProvider&uri=/&depth=1",processors:o.chain(v).omit("filterPublicFolderProcessor").values().value(),getDataArray:function(e){e=r.parse(i(e).text());var t=o.find(e.children,function(e){return"/public"===e.uri}).label;return[{id:"@fakeRoot",label:e.label,uri:"/",resourceType:"folder",_links:{content:"@fakeContentLink"}},{id:"/public",label:t,uri:"/public",resourceType:"folder",_links:{content:"@fakeContentLink"}}]}}),{accept:"text/html",dataType:"text"}),olapDataLayer:N},processors:o.values(v),getDataArray:function(e){return e&&e[T.RESOURCE_LOOKUP]?e[T.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,o){return+o.getResponseHeader("Total-Count")},getDataLayer:k}),this.listTreeView=S.instance({rootLevelHeight:o.bind(this.getContentHeight,this),itemsTemplate:D,listItemHeight:O,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,dataUriTemplate:H,levelDataId:"uri",cache:{searchKey:"searchString",pageSize:100},processors:[{processItem:function(e){return e._node=o.contains(x,e.value.resourceType),e}},v.cssClassItemProcessor,v.filterTempFolderProcessor],customDataLayers:{olapDataLayer:N},getDataLayer:k,getDataArray:function(e){return e&&e[T.RESOURCE_LOOKUP]?e[T.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,o){return+o.getResponseHeader("Total-Count")}}),a.prototype.constructor.call(this,{template:f,modal:!0,resizable:!0,additionalCssClasses:"sourceDialogNew",title:g.ADH_108_DATA_CHOOSER_DIALOG_TITLE,traits:[c],tabHeaderContainerSelector:".header .tabHeaderContainer",tabContainerClass:"tabContainer control groupBox treeBox",optionTemplate:y,toggleClass:"down",tabs:[{label:g.ADH_108_DATA_CHOOSER_FOLDERS_TAB,action:"tree",content:this.hierarhicalTreeView,exposeAction:!0,additionalCssClasses:"action square small",i18n:g},{label:g.ADH_108_DATA_CHOOSER_LIST_TAB,action:"list",content:this.listTreeView,exposeAction:!0,additionalCssClasses:"action square small",i18n:g}],buttons:[{label:g.ADH_016_BUTTON_OK,action:"apply",primary:!0},{label:g.ADH_010_BUTTON_CANCEL,action:"cancel",primary:!1}]}),this.disableButton("apply"),this.on("button:apply",o.bind(this._onSelectDataDialogOkButtonClick,this)),this.on("button:cancel",o.bind(this._onSelectDataDialogCancelButtonClick,this))},initialize:function(){var e=function(e){var t=o.find(this.buttons.options,function(e){return"apply"===e.model.attributes.action}).$el,i=e&&o.isArray(e)&&e[0],r=i?e[0].uri:void 0,a=i?e[0].resourceType:void 0;return i||r||a?(a!==T.FOLDER?this.$(".itemDescription").text(i.description||""):this.$(".itemDescription").empty(),t.find(".wrap").text(a===T.SEMANTIC_LAYER_DATA_SOURCE?g.ADH_108_DATA_CHOOSER_DOMAIN_LABEL:g.ADH_016_BUTTON_OK),o.contains(o.union([T.FOLDER],x),a)?(delete this.resourceData,void this.disableButton("apply")):(this.resourceData={},a===b?(this.resourceData.resourceUri=r.substring(0,r.lastIndexOf("/")),this.resourceData.cube=r.substring(r.lastIndexOf("/")+1),this.resourceData.reportType="olap_"+this.reportType):(this.resourceData.resourceUri=r,this.resourceData.reportType=this.reportType),this.resourceData.event=this._getAdHocFlowEvent(a),this.resourceData.flowExecutionKey=flowExecutionKey,void this.enableButton("apply"))):(this.disableButton("apply"),void this.$(".itemDescription").empty())};this.errorDialog=new s,this.listenTo(this.hierarhicalTreeView,"selection:change",e),this.listenTo(this.listTreeView,"selection:change",e),this.listenTo(this.hierarhicalTreeView,"levelRenderError",o.bind(this._onLevelRenderError,this.errorDialog)),this.listenTo(this.listTreeView,"levelRenderError",o.bind(this._onLevelRenderError,this.errorDialog)),this.listenTo(this.hierarhicalTreeView,"item:dblclick",this._onSelectDataDialogOkButtonClick),this.listenTo(this.listTreeView,"item:dblclick",this._onSelectDataDialogOkButtonClick),this.listenTo(this.listTreeView.searchForm,"search",this._onSearch),this.listenTo(this.listTreeView.searchForm,"clear",this._resetItemSelection),this.on("tab:tree tab:list",this._resetItemSelection,this),a.prototype.initialize.apply(this,arguments)},getContentHeight:function(){return this.$el.height()-this._resizableContainerShiftHeight},render:function(){return a.prototype.render.apply(this,arguments),this._dfdRenderSerachFormTo.resolve(this.$tabHeaderContainer),this.openTab(A),this},open:function(){var e=this;e._resizableContainerShiftHeight=20,a.prototype.open.apply(this,arguments);var t=o.bind(function(){this.$contentContainer.find(".tabContainer").css({height:"inherit","overflow-y":"auto"})},this);_.isIE8()||_.isIE9()?setTimeout(t,1):t(),this.$el.find(".content").children(":not(.subcontainer)").each(function(){e._resizableContainerShiftHeight+=e.$(this).outerHeight(!0)}),this.$contentContainer.height(this.$el.height()-this._resizableContainerShiftHeight)},close:function(){this.hierarhicalTreeView&&(this.hierarhicalTreeView.collapse("@fakeRoot",{silent:!0}),this.hierarhicalTreeView.collapse("/public",{silent:!0}),this.hierarhicalTreeView.resetSelection()),a.prototype.close.apply(this,arguments)},_onSearch:function(){this.openTab(A),this.disableButton("apply")},_resetItemSelection:function(){this.hierarhicalTreeView.resetSelection(),this.listTreeView.resetSelection(),this.$(".itemDescription").empty()},_getAdHocFlowEvent:function(e){var t="";return e==T.REPORT_UNIT||e==T.DOMAIN_TOPIC?t="startAdHocWithTopic":e==T.SEMANTIC_LAYER_DATA_SOURCE?t="startQueryBuilder":e===b&&(t="startAdhocForOlap"),t},_onSelectDataDialogOkButtonClick:function(){this.resourceData&&(document.location="flow.html?_flowId=adhocFlow&realm="+encodeURIComponent(encodeURIComponent(this.resourceData.resourceUri))+"&_flowExecutionKey="+this.resourceData.flowExecutionKey+"&reportType="+this.resourceData.reportType+"&embeddedDesigner="+this.isEmbeddedDesigner+"&decorate="+this.decorate+"&_eventId="+this.resourceData.event+(this.resourceData.cube?"&cube="+this.resourceData.cube:""))},_onLevelRenderError:function(e,t,o){t=r.parse(t),this.setMessage(t.parameters[0].substring(t.parameters[0].indexOf(": ")+2,t.parameters[0].indexOf("\n"))),this.open(),o.$el.removeClass(o.loadingClass).addClass(o.openClass)},_onSelectDataDialogCancelButtonClick:function(){this.close(),this.isEmbeddedDesigner&&-1===document.referrer.indexOf("login.html")?i(document).trigger("adhocDesigner:cancel"):!alreadyEditing||document.referrer.indexOf("login.html")>0?document.location="flow.html?_flowId=homeFlow":window.history.back()},_getParameterByName:function(e){var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),o=t.exec(location.search);return null==o?"":decodeURIComponent(o[1].replace(/\+/g," "))}})});