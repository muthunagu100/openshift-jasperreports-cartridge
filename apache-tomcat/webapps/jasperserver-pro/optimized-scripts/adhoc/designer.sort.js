var adhocSort={TEMPLATE_ID:"sortDialog",SORT_FIELDS_LIST_TEMPLATE_ID:"list_fields_hideRoot_column_simple",SORT_FIELDS_ITEM_TEMPLATE_ID:"list_fields_hideRoot_column_simple:leaf",AVAILABLE_ID:"sortDialogAvailable",AVAILABLE_FIELDS_PROVIDER_ID:"availableFieldsTreeDataProvider",SORT_FIELDS_ID:"sortDialogSortFields",OK_PATTERN:"#sortDialogOk",CANCEL_PATTERN:"#sortDialogCancel",ADD_PATTERN:"#sortDialogAddToSort",TO_TOP_PATTERN:"#sortDialogToTop",TO_BOTTOM_PATTERN:"#sortDialogToBottom",UP_PATTERN:"#sortDialogUpward",DOWN_PATTERN:"#sortDialogDownward",REMOVE_PATTERN:"#sortDialogRemoveFromSort",BUTTON_PATTERN:"#sortDialogSortFields .icon.button",DROP_CLASS:"dragging",SORT_DRAG_CLASS:".draggable",EVENT:{SORT:"sort:sort"},initialize:function(){this.originalSortFields=[],this.preselectedFieldNames=null,this._dialog=$(this.TEMPLATE_ID),this._add=$$(this.ADD_PATTERN)[0],this._remove=$$(this.REMOVE_PATTERN)[0],this._ok=$$(this.OK_PATTERN)[0],this._cancel=$$(this.CANCEL_PATTERN)[0],this._toTop=$$(this.TO_TOP_PATTERN)[0],this._toBottom=$$(this.TO_BOTTOM_PATTERN)[0],this._up=$$(this.UP_PATTERN)[0],this._down=$$(this.DOWN_PATTERN)[0],this.tree=this.createAvailableFieldsTree(),this.list=this.createSortFieldsList(),this.actionHash={"#sortDialogOk":function(){this.hideDialog()},"#sortDialogCancel":function(){this.fire(this.EVENT.SORT,{fields:this.originalSortFields,hide:!0})},"#sortDialogAddToSort":function(){this._addToSort()},"#sortDialogRemoveFromSort":function(){this._removeFromSort()},"#sortDialogUpward":function(){this._oneStepMoveTo(!0)},"#sortDialogDownward":function(){this._oneStepMoveTo(!1)},"#sortDialogToTop":function(){this._moveTo(!0)},"#sortDialogToBottom":function(){this._moveTo(!1)},"li .icon.button":function(e){this._toggleSortOrder(this.list.getItemByEvent(e))}},this.actionHash.getAction=function(e){for(var t in this)if(e.match(t)&&"getAction"!=t)return this[t];return doNothing},this.observe("sort:sort",function(e){adhocDesigner.setSorting(e.memo.fields,function(){e.memo.hide&&adhocSort.hideDialog()})}),this._dialog.observe(isSupportsTouch()?"touchend":"mouseup",function(e){var t=e.element(),i=matchAny(t,[this.ADD_PATTERN,this.REMOVE_PATTERN,this.OK_PATTERN,this.CANCEL_PATTERN,this.BUTTON_PATTERN,this.UP_PATTERN,this.DOWN_PATTERN,this.TO_TOP_PATTERN,this.TO_BOTTOM_PATTERN],!0);i&&this.actionHash.getAction(i).bind(this)(e)}.bindAsEventListener(this))},updateAndShowAvailableFieldsTree:function(e){var t=function(){this.tree=this.createAvailableFieldsTree(e),this.tree.showTree(20)}.bind(this);designerBase.sendRequest(adhocDesigner.getControllerPrefix()+"_updateAvailableTree",[],t,{target:"ajaxbuffer",bPost:!0})},createAvailableFieldsTree:function(e){var t=adhocDesigner.getAvailableFieldsTree(this.AVAILABLE_ID,adhocSort.AVAILABLE_FIELDS_PROVIDER_ID);if(t.DEFAULT_TREE_CLASS_NAME="responsive fields",t.multiSelectEnabled=!0,isIPad()){var i=$(this.AVAILABLE_ID);new TouchController(i,i.up(1))}t.observe("tree:loaded",function(){_.each(adhocDesigner.getAllLeaves(null,t),function(e){var t=adhocDesigner.findFieldByName(e.param.id);t.aggregateField&&adhocDesigner.removeNodeFromTree(e)}),e&&e.length>0&&e.each(function(e){t.openAndSelectNode(e)}.bind(this)),this._addSortFieldsToList(),buttonManager.disable(this._add)}.bindAsEventListener(this)),t.observe("leaf:dblclick",function(e){this._addToSort(e.memo.node)}.bindAsEventListener(this));var s=this._refreshAddButton;return t.observe("leaf:selected",s.bindAsEventListener(this)),t.observe("node:selected",s.bindAsEventListener(this)),t.observe("leaf:unselected",s.bindAsEventListener(this)),t.observe("node:unselected",s.bindAsEventListener(this)),Droppables.remove(t.getId()),Droppables.add(t.getId(),{accept:[this.SORT_FIELDS_ID],hoverclass:layoutModule.DROP_TARGET_CLASS,onDrop:function(e){e.items&&this._removeFromSort()}.bind(this)}),t},createSortFieldsList:function(){var e=new dynamicList.List(this.SORT_FIELDS_ID,{listTemplateDomId:this.SORT_FIELDS_LIST_TEMPLATE_ID,itemTemplateDomId:this.SORT_FIELDS_ITEM_TEMPLATE_ID,excludeFromSelectionTriggers:[this.BUTTON_PATTERN],dragPattern:isIPad()?void 0:this.SORT_DRAG_CLASS,multiSelect:!0,selectOnMousedown:!isIPad(),comparator:function(e,t){var i=e.getValue().order,s=t.getValue().order;return i>s?1:s>i?-1:0}});return e.observe("item:selected",function(){e.getSelectedItems().length>0&&buttonManager.enable(this._remove),this._refreshMoveButtons()}.bindAsEventListener(this)),e.observe("item:unselected",function(){0==e.getSelectedItems().length&&buttonManager.disable(this._remove),this._refreshMoveButtons()}.bindAsEventListener(this)),e.observe("item:dblclick",function(e){this._removeFromSort(e.memo.item)}.bindAsEventListener(this)),Droppables.add($(this.SORT_FIELDS_ID),{accept:[this.AVAILABLE_ID],hoverclass:layoutModule.DROP_TARGET_CLASS,onDrop:function(e){e.node&&this._addToSort()}.bind(this)}),e},createSortFieldItem:function(e){var t=new dynamicList.ListItem({label:e.label.unescapeHTML(),value:e});return t.refreshStyle=function(){dynamicList.ListItem.prototype.refreshStyle.call(this);var e=this.getValue().isAsc;e?(this._getElement().addClassName(layoutModule.ASCENDING_CLASS),this._getElement().removeClassName(layoutModule.DESCENDING_CLASS)):(this._getElement().addClassName(layoutModule.DESCENDING_CLASS),this._getElement().removeClassName(layoutModule.ASCENDING_CLASS))},t},recreateSortFieldsScroll:function(){if(isIPad()){var e=$(this.SORT_FIELDS_ID);return new TouchController(e,e.up(1))}return null},getSortFields:function(){return this.list.getItems().collect(function(e){var t=e.getValue();return t.toData()})},_isOriginalField:function(e){return this.originalSortFields.detect(function(t){return t.name==e}.bind(this))},_getMergedPreselectedWithOriginalFields:function(e){var t=this.originalSortFields?this.originalSortFields.slice(0):[],i=this;return jQuery(e).each(function(){var e=this.toString();i._isOriginalField(e)||t.push({name:e,isAsc:!0})}),t},_addSortFieldsToList:function(){var e=this._getMergedPreselectedWithOriginalFields(this.preselectedFieldNames),t=[],i=[],s=[],o=this;jQuery(e).each(function(e){var r=o.tree.findNodeById(this.name);if(r){var n=new adhocSort.Field(r,this.isAsc,e).item;t.push(r),o.preselectedFieldNames&&jQuery.inArray(this.name,o.preselectedFieldNames)>-1&&i.push(n),s.push(n)}}),this.list.setItems(s),jQuery(t).each(function(){this.refreshStyle()}),this.list.show(),this.recreateSortFieldsScroll(),jQuery(i).each(function(){this.select()}),e&&e.length!==(this.originalSortFields?this.originalSortFields.length:0)&&this.fire(this.EVENT.SORT,{fields:this.getSortFields(),hide:!1})},launchDialog:function(e){dialogs.popup.show(this._dialog),this.list.setItems([]),this.list.show(),[this._add,this._remove,this._up,this._down,this._toTop,this._toBottom].each(function(e){buttonManager.disable(e)}),this.originalSortFields=localContext.state.sortFields||[];var t=this.originalSortFields.collect(function(e){return adhocSort.Util.fieldNameToUriList(e.name)}).flatten();if(jQuery.isArray(e)){this.preselectedFieldNames=e;for(var i=0;i<e.length;i++)t=t.concat(adhocSort.Util.fieldNameToUriList(e[i]))}else this.preselectedFieldNames=e?[e]:null,e&&(t=t.concat(adhocSort.Util.fieldNameToUriList(e)));this.updateAndShowAvailableFieldsTree(t)},hideDialog:function(){dialogs.popup.hide(this._dialog)},stopObserving:function(e,t){this._dialog.stopObserving(e,t)},observe:function(e,t){this._dialog.observe(e,t)},fire:function(e,t){this._dialog.fire(e,t)},_isOnlyFieldsSelected:function(){return this.tree.getSelectedNode()&&!this.tree.selectedNodes.detect(function(e){return e.isParent()||e.param.id===designerBase.SPACER_NAME})},_getOnlyChildren:function(e){var t=[];return e.each(function(e){e.isParent()?t=t.concat(this._getOnlyChildren(e.childs)):t.push(e)}.bind(this)),t},_toggleSortOrder:function(e){e.getValue().isAsc=!e.getValue().isAsc,e.refresh(),this.fire(this.EVENT.SORT,{fields:this.getSortFields(),hide:!1})},_addToSort:function(e){if(this._isOnlyFieldsSelected()){var t=this._getOnlyChildren(e?[e]:this.tree.selectedNodes),i=this.list.getItems(),s=t.collect(function(e,t){return new adhocSort.Field(e,!0,i.length+t).item}.bind(this));this.list.addItems(s),t.invoke("refreshStyle"),t.invoke("deselect"),this.list.refresh(),this.fire(this.EVENT.SORT,{fields:this.getSortFields(),hide:!1}),this._refreshAddButton(),this._refreshMoveButtons()}},_removeFromSort:function(e){var t=e?[e]:this.list.getSelectedItems(),i=this.tree;this.list.removeItems(t),t.each(function(e){var t=e.getValue();i._deselectAllNodes(),t.node.hidden=!1,t.node.refreshStyle(),t.node.select()}),this.fire(this.EVENT.SORT,{fields:this.getSortFields(),hide:!1}),this._refreshMoveButtons()},_oneStepMoveTo:function(e){var t=this.list.getItems(),i=this.list.getSelectedItems();e||(t=t.clone().reverse());var s=e?-1:1,o=null;t.each(function(e){var t=i.detect(function(t){return t==e});t&&o?(o.getValue().order-=s,t.getValue().order+=s):o=e}),this._resort()},_moveTo:function(e){var t=this.list.getItems(),i=this.list.getSelectedItems(),s=t.findAll(function(e){return!i.include(e)});e||(i=i.clone().reverse(),s=s.clone().reverse());var o=e?1:-1,r=e?0:t.length,n=function(e){e.getValue().order=r,r+=o};i.each(n),s.each(n),this._resort()},_resort:function(){this.list.sort(),this.list.show(),this._refreshMoveButtons(),this.fire(this.EVENT.SORT,{fields:this.getSortFields(),hide:!1})},_refreshMoveButtons:function(){var e=this.list.getItems(),t=this.list.getSelectedItems(),i=e.length>1&&t.length>0,s=i&&!(1==t.length&&t[0].first),o=i&&!(1==t.length&&t[0].last);[this._toTop,this._up].each(function(e){(s?buttonManager.enable:buttonManager.disable)(e)}),[this._toBottom,this._down].each(function(e){(o?buttonManager.enable:buttonManager.disable)(e)})},_refreshAddButton:function(){(this._isOnlyFieldsSelected()?buttonManager.enable:buttonManager.disable)(this._add)}};adhocSort.Util={fieldNameToUri:function(e){return"/"+e},fieldNameToUriList:function(e){var t=".",i=e.split(t),s=i.slice(0,i.length-1).collect(function(e,t){return"/"+i.slice(0,t+1).join("/")});return s.length>0&&s.push(s.last()+"/"+e),s.push("/"+e),s},uriToFiledName:function(e){var t=e.split("/");return t[t.length-1]}},adhocSort.Field=function(e,t,i){this.name=adhocSort.Util.uriToFiledName(e.param.uri),this.label=e.name.escapeHTML(),this.isAsc=!!t,this.order=i||0,this.node=e,this.item=adhocSort.createSortFieldItem(this),this.node&&(this.node.hidden=!0)},adhocSort.Field.addMethod("toData",function(){return{name:this.name,isAsc:this.isAsc}}),adhocSort.Field.addMethod("toJSON",function(){return this.toData()});