define(["require","jquery","underscore","backbone","bundle!adhoc_messages","adhoc/calculatedFields/model/CalculatedFieldModel","text!adhoc/calculatedFields/template/CalculatedFieldTemplate.htm","adhoc/calculatedFields/factory/operatorsFactory","adhoc/calculatedFields/view/SummaryCalculationView","adhoc/calculatedFields/view/ExpressionEditorView"],function(e){var a=e("jquery"),l=e("underscore"),t=e("backbone"),i=e("bundle!adhoc_messages"),s=e("adhoc/calculatedFields/model/CalculatedFieldModel"),o=e("text!adhoc/calculatedFields/template/CalculatedFieldTemplate.htm"),r=e("adhoc/calculatedFields/factory/operatorsFactory"),d=e("adhoc/calculatedFields/view/SummaryCalculationView"),m=e("adhoc/calculatedFields/view/ExpressionEditorView");return t.View.extend({template:l.template(o),events:{"click .formulaBuilderTab":"formulaTabClick","click .summaryCalcTab":"summaryTabClick","keyup .fieldLabelInput":"onFieldLabelChange"},initialize:function(){this.model=new s({operators:r}),this.formulaEditor=new m({assignedAttribute:"expression",title:i.ADH_421_FORMULA,model:this.model}),this.summaryTab=new d({model:this.model}),this.listenTo(this.model,"change:fieldLabel",this.updateFieldLabel),this.listenTo(this.model,"change:kind",this.setNameInputLabel),this.listenTo(this.model,"invalid:fieldLabel",this.showFieldLabelError),this.listenTo(this.model,"invalid:summaryExpression",this.showSummaryTab),this.listenTo(this.model,"invalid:summaryParameter",this.showSummaryTab)},render:function(){this.$el.empty(),this.$el.html(this.template({i18n:i})),this.formulaEditor.setElement(".formulaBuilderSection").render(),this.summaryTab.setElement(".summaryCalcSection").render();var e=this.$(".fieldLabelInput");return enableSelection(e.parent()[0]),setTimeout(function(){e.focus()},500),this},setNameInputLabel:function(){var e="MEASURE"===this.model.get("kind"),a=e?"ADH_402_MEASURE_NAME":"ADH_402_FIELD_NAME",l=e?"ADH_402_MEASURE_NAME_TIP":"ADH_402_FIELD_NAME_TIP";if(this.$(".measureNameSection label.control.input span.wrap").text(i[a]),this.$(".measureNameSection label.control.input").attr("title",i[l]),!this.isEdit){var t=e?i.ADH_403_NEW_MEASURE_DEFAULT_NAME:i.ADH_403_NEW_FIELD_DEFAULT_NAME;this.model.set("fieldLabel",t?t:"")}},updateFieldLabel:function(){var e=this.$(".fieldLabelInput");e.val(this.model.get("fieldLabel"));var a=e.val().length;e.selection("setPos",{start:a,end:a})},onFieldLabelChange:function(e){this.$(".measureNameSection label.control").removeClass("error"),this.model.set("fieldLabel",a(e.target).val(),{silent:!0}),this.model.isLabelValid()},showFieldLabelError:function(e){var a=this.$(".measureNameSection .message.warning"),l=e.errorCode?i[e.errorCode]:e.errorMessage;a.text(l?l:""),a.parent().addClass("error")},showFormulaTab:function(){this.$(".formulaBuilderTab").addClass("selected"),this.$(".formulaBuilderTab a").removeClass("over"),this.$(".summaryCalcTab").removeClass("selected"),this.$(".summaryCalcSection").addClass("hidden"),this.$(".formulaBuilderSection").removeClass("hidden")},showSummaryTab:function(){this.$(".summaryCalcTab").addClass("selected"),this.$(".summaryCalcTab a").removeClass("over"),this.$(".formulaBuilderTab").removeClass("selected"),this.$(".formulaBuilderSection").addClass("hidden"),this.$(".summaryCalcSection").removeClass("hidden")},formulaTabClick:function(){this.$(".formulaBuilderTab.selected")[0]||this.showFormulaTab()},summaryTabClick:function(){this.$(".summaryCalcTab.selected")[0]||this.model.trigger("validate:expression",l.bind(this.showSummaryTab,this))}})});