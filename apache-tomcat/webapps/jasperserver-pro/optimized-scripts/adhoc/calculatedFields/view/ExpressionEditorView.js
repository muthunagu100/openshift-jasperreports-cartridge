define(["require","underscore","jquery","backbone","bundle!jasperserver_messages","bundle!adhoc_messages","adhoc/calculatedFields/factory/codeExampleFactory","adhoc/calculatedFields/view/SimpleSelectListView","common/util/featureDetection","text!adhoc/calculatedFields/template/ExpressionEditorTemplate.htm","underscore.string","jquery.selection"],function(e){var t=e("underscore"),s=e("jquery"),i=e("backbone"),n=t.extend(e("bundle!jasperserver_messages"),e("bundle!adhoc_messages")),o=e("adhoc/calculatedFields/factory/codeExampleFactory"),r=e("adhoc/calculatedFields/view/SimpleSelectListView"),a=e("common/util/featureDetection"),l=e("text!adhoc/calculatedFields/template/ExpressionEditorTemplate.htm");return e("underscore.string"),e("jquery.selection"),i.View.extend({template:t.template(l),events:{"keyup .control.textArea textarea":"onExpressionEdit","click .expressionEditorOperators li.button.math":"operatorClick","click .expressionEditorValidate .button":"validateButton"},initialize:function(e){this.assignedAttribute=e.assignedAttribute,this.title=e.title?e.title:"",this.lastSelectionPos={start:0,end:0},this.listenTo(this.model,"change:"+this.assignedAttribute,this.setExpression),this.listenTo(this.model,"change:availableFields",this.renderFields),this.listenTo(this.model,"change:availableFunctions",this.renderFunctions),this.listenTo(this.model,"invalid:"+this.assignedAttribute,this.setError)},render:function(){var e={i18n:n,title:this.title,operators:this.model.get("operators")};return this.$el.empty(),this.$el.html(this.template(e)),this.expressionInput=this.$(".control.textArea textarea"),enableSelection(this.expressionInput.parent()[0]),enableSelection(this.$(".inputRow .description p.text")[0]),this},renderFields:function(){var e=new r({el:this.$el.find(".expressionEditorFieldsList ul")});this.listenTo(e,"item:dblClick",this.fieldDblClick),!a.supportsModernSelection&&this.listenTo(e,"item:click",this.resetSelectionPos);var s=this.model.get("availableFields");s.length>0&&e.render(t.chain(s).map(function(e){return{name:e.id,label:e.label,tooltip:e.tooltip,nodeClass:e.expression?"calculated":"",iconClass:"DIMENSION"===e.kind?"field":"measure"}}).sortBy("label").value())},renderFunctions:function(){var e=new r({el:this.$el.find(".expressionEditorFunctionsList ul")});this.listenTo(e,"item:click",this.functionClick),this.listenTo(e,"item:dblClick",this.functionDblClick);var s=this.model.get("availableFunctions");s.length>0&&e.render(t.chain(s).map(function(e){return{name:e.name,label:e.name,iconClass:"function"}}).sortBy(function(e){return e.name.toUpperCase()}).value())},successMessage:function(){this.clearMessages(),this.$(".expressionEditorValidate.group span.message.warning").text(n["adh.calculated.fields.validation.successful"]),this.$(".expressionEditorValidate.group span.message.warning").addClass("success"),this.$(".expressionEditorValidate.group").addClass("error")},errorMessage:function(e){var t=e?e:"";this.clearMessages(),this.$(".expressionEditorValidate.group span.message.warning").text(t),this.$(".control.textArea").addClass("error"),this.$(".expressionEditorValidate.group").addClass("error")},clearMessages:function(){this.$(".control.textArea").removeClass("error"),this.$(".expressionEditorValidate.group").removeClass("error"),this.$(".expressionEditorValidate.group span.message.warning").removeClass("success")},operatorClick:function(e){var i=e.target.hasClassName("math")?e.target:s(e.target).parent("li.math")[0];if(i){var n=i.readAttribute("value"),o=t.find(this.model.get("operators"),function(e){return e.id===n});this.insertText(o.value)}},fieldDblClick:function(e){var s=t.find(this.model.get("availableFields"),function(t){return t.id===e});this.updateSelectionPos(),this.insertText(s.alias)},updateSelectionPos:function(){var e=this;!a.supportsModernSelection&&this.expressionInput.selection("setPos",{start:e.lastSelectionPos.start,end:e.lastSelectionPos.end})},resetSelectionPos:function(){a.supportsModernSelection||(this.lastSelectionPos=this.expressionInput.selection("getPos"))},functionClick:function(e){var t=n["adh.calculated.fields.function.description."+e];this.resetSelectionPos(),this.$(".inputRow .description p.title").text(e),this.$(".inputRow .description p.text").text(t?t:""),this.$(".inputRow .description p.code").text(o(e,!0))},functionDblClick:function(e){var t=this.$(".control.checkBox input")[0].checked,s=o(e,t);this.updateSelectionPos(),this.insertText(s)},insertText:function(e){var s=e,i=this.expressionInput.val()[this.expressionInput.selection("getPos").start-1],n=this.expressionInput.val()[this.expressionInput.selection("getPos").end];'"'===i&&'"'===n?s=t.trim(s,'"'):(i&&!t.contains([" ","("],i)&&")"!==s&&(s=" "+s),n&&!t.contains([" ",")",","],n)&&"("!==s&&(s+=" ")),this.clearMessages(),this.expressionInput.selection("replace",{text:s});var o=this.expressionInput.selection("getPos").end;this.expressionInput.selection("setPos",{start:o,end:o}),this.model.set(this.assignedAttribute,this.expressionInput.val(),{silent:!0})},setExpression:function(){var e=this.model.get(this.assignedAttribute);this.clearMessages(),this.expressionInput.val(e)},setError:function(e){this.errorMessage(e.errorCode?n[e.errorCode]:e.errorMessage)},onExpressionEdit:function(e){this.clearMessages(),this.model.set(this.assignedAttribute,s(e.target).val(),{silent:!0}),this.model.isExpressionValid(this.assignedAttribute)},validateButton:function(){this.model.trigger("validate:"+this.assignedAttribute,t.bind(this.successMessage,this))}})});