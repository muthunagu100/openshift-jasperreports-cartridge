!function(e,t,a,n){var i=null,s=LayoutManager=function(e,t){this.init(e,t)};LayoutManager.fn=LayoutManager.prototype={axes:{},template:null,init:function(e,t){this.initProperties(t),this.initialized&&(this.initModeSpecificBehavior(this.mode),this.initAxes(e),this.initEventListeners())},initProperties:function(t){this.measuresGroupId=t.measuresGroupId,this.isOlapMode=!!t.isOlapMode,this.mode=t.mode,this.element=e("#"+t.id),this.initialized=!!this.element[0]},initModeSpecificBehavior:function(e){a.extend(this,i[e])},initAxes:function(t){a.each(t,function(t){var n=a.clone(t);n.element=e("#"+n.elementId),this.axes[n.elementId]=n,this.setData(n,n.data||[])},this)},getTemplate:function(){return null===this.template&&(this.template=s.compileTemplate("#"+this.mode+"LayoutManagerTemplate",{variable:"data"})),this.template},render:function(t,n){this.initialized&&(a.each(this.axes,function(a){n||this.setData(a,this.normalizeModel(t[a.name])),e(a.element).html(this.getTemplate()(a.data)),this.createSortable(a.element[0]),this.createMeasuresSortable(a.element[0])},this),Draggables.removeObserver(this.element[0]),Draggables.addObserver(new r(this.element[0],this.onMove)))},setData:function(e,t){e.data=t,this.updateAxesDataCache&&this.updateAxesDataCache()},initEventListeners:function(){a.bindAll(this,"onContextMenu","onRemove","onAdd","onMove","onMeasureReorder"),document.stopObserving(layoutModule.ELEMENT_CONTEXTMENU,s.onContextMenu||e.noop),document.observe(layoutModule.ELEMENT_CONTEXTMENU,this.onContextMenu),s.onContextMenu=this.onContextMenu;var t=isSupportsTouch()?"touchend":"mouseup";e(this.element).undelegate("span.remove",t),e(this.element).delegate("span.remove",t,this.onRemove)},onContextMenu:function(t){var n=this,i=e(t.memo.node).closest("li.button"),s=i.hasClass("meazure")||i.hasClass("member"),r=i.closest(s?"li.measure":"li.dimension");if(i){var l=e(i).closest("ul.sortable").attr("id"),o=this.axes[l];o&&(Event.stop(t),this.element.trigger("lm:contextMenu",a.extend(t.memo,{extra:{axis:o.name,axisId:l,name:i.attr(this.nameAttr),dimensionId:i.attr("data-dimension"),level:i.attr("data-level"),index:i.index(),groupIndex:r.index(),isMeasure:s,allLevels:i.siblings().addBack().map(function(){return e(this).attr(n.nameAttr)}).get()}})))}},onRemove:function(t){var a=e(t.target).closest("li");if(!s.isElementDragging(a)){var n=a.index(),i=this.axes[a.closest("ul.sortable").attr("id")],r=a.attr("data-dimension");this.element.trigger("lm:removeItem",{axis:i.name,index:n,item:{level:a.attr("data-level"),dimensionId:r,isMeasure:this.measuresGroupId===r}})}},onAdd:function(t){var n=t.node;if(n){var i,s=e(t).index(),r=t.nodes||[n],l=this.axes[e(t).closest("ul").attr("id")],o=this[l.name].validateAdd,u=[];return i=this.filter(r,l),o&&!o.call(this,i,s,l.name,u)?(!a.isEmpty(u)&&dialogs.systemConfirm.show(u.join("</br>"),5e3),void this.render(this.axes,!0)):void this.add(i,s,l.name)}},add:function(e,t,n){var i;if(!a.isEmpty(e))if(1===e.length){i=e[0];var s=i.param.extra||i.param;this.element.trigger("lm:addItem",{axis:n,dimensionId:s.dimensionId,level:s.id,index:t,hierarchyName:s.hierarchyName})}else this.element.trigger("lm:addItems",{axis:n,levels:a.pluck(e,"param"),index:t})},onMove:function(t,n,i,s,r,l){var o=e(t.element),u=this.axes[i],d=this.axes[s],m=this[d.name].validateMove,h=[];if(!n||r!==l)return n||!m||m.call(this,u,d,o,h)?void this.element.trigger("lm:"+(n?"moveItem":"switchItem"),{axis:d.name,item:o.attr(this.moveAttr),from:r,to:l}):(!a.isEmpty(h)&&dialogs.systemConfirm.show(h.join("</br>"),5e3),void this.render(this.axes,!0))},onMeasureReorder:function(t,a){var n=e(a.element);this.element.trigger("lm:measureReorder",{measure:n.attr("data-level"),to:n.index()})},createSortable:function(e){Sortable.create(e,{delay:isIE()?200:0,constraint:!1,overlap:"horizontal",containment:a(this.axes).keys(),dropOnEmpty:!0,accept:["measure","dimension","meazure","dimenzion"],onDrop:this.onAdd}),Draggables.removeObserver(e)},createMeasuresSortable:function(t){var a=e("li.measure > ul.members",t);if(0!==a.length)return 0===a.find("li.member").length?void Sortable.destroy(a[0]):void Sortable.create(a[0],{delay:isIE()?200:0,constraint:!1,overlap:"horizontal",onUpdate:this.onMeasureReorder})}},LayoutManager.basicFilter=function(e){return a.inject(e,function(e,t){return e.concat(s.toLeavesArray(t))},[])},LayoutManager.removeDuplicatesFilter=function(e,t,n){var i;return a(e).filter(function(e){return i=e.param.extra,"_spacer"===i.id||!a.any(t,function(e){return a.all(n,function(t,a){return i[a]===e[t]})})})},LayoutManager.compileTemplate=function(t,n){return a.template(e(t).html(),null,a.defaults(n,{evaluate:/\{\{([\s\S]+?)\}\}/g,interpolate:/\{\{=([\s\S]+?)\}\}/g,escape:/\{\{-([\s\S]+?)\}\}/g}))},LayoutManager.toLeavesArray=function(e,t){var a=t||[];if(!e.childs||0===e.childs.length)return a.push(e),a;for(var n=0;n<e.childs.length;n++)s.toLeavesArray(e.childs[n],a);return a},LayoutManager.isElementDragging=function(e){return Draggable._dragging[e.jquery?e[0]:e]};var r=Class.create({initialize:function(e,a){this.element=t(e),this.observer=a,this.axes=["olap_rows","olap_columns"]},onStart:function(t,a){this.axis=this.getAxis(a),this.from=e(a.element).index(),isIE()&&(this.changedElement=a.element,this.changedElement&&(this.changedElement.setStyle({display:"inline-block"}),this.changedElement.hasClassName("measure")&&this.changedElement.setStyle({padding:"0px"})))},onEnd:function(t,a){if(this.axis){var n=this.getAxis(a);if(n&&this.axes.include(n.id)){Sortable.unmark();var i=this.axis.id===n.id,s=e(a.element).index();this.observer(a,i,this.axis.id,n.id,this.from,s),isIE()&&this.changedElement&&(this.changedElement.style.removeAttribute("display"),this.changedElement.style.removeAttribute("padding"))}}},getAxis:function(e){return e.element.up("ul")}});i={table:{nameAttr:"fieldname",moveAttr:"fieldname",filter:function(e,t){return e=s.basicFilter(e),"column"===t.name?e:s.removeDuplicatesFilter(e,t.data,{id:"name"})},fieldExists:function(e,t){return a.find(e,function(e){return e.name===t})},group:{validateAdd:function(e,t,n,i){return 0===e.length?(i&&i.push("Field or measure already in use."),!1):a.any(e,function(e){return e.param.extra.isMeasure||"_spacer"===e.param.extra.id})?(i&&i.push(errorAddTpGroups),!1):!0},validateMove:function(e,t,a,n){return a.hasClass("meazure")?(n&&n.push(errorAddTpGroups),!1):this.fieldExists(t.data,a.attr("fieldname"))?(n&&n.push("Cannot move field already present in groups"),!1):!0}},column:{validateAdd:function(e,t,a,n){return 0===e.length?(n&&n.push("Field or measure already in use."),!1):!0},validateMove:function(e,t,a,n){return this.fieldExists(t.data,a.attr("fieldname"))?(n&&n.push("Cannot move field already present in columns"),!1):!0}},normalizeModel:function(e){var t=!1,n=null;return a.map(e,function(e){return t=e.measure||!!e.isSpacer,n="_null"!==e.currentDisplayName?e.currentDisplayName:null,{name:e.name,title:e.isSpacer?adhocDesigner.messages.spacer:n||e.name,isSpacer:!!e.isSpacer,isMeasure:t,itemClass:t?"meazure":"dimenzion"}})}},chart:{nameAttr:"fieldname",moveAttr:"fieldname",filter:function(e){return e},group:{validateAdd:function(e,t,n,i){return a.any(e,function(e){return"ItemGroupType"===e.param.type})?(i&&i.push(adhocDesigner.messages.cantAddSet),!1):a.any(e,function(e){return e.param.extra.isMeasure})?(i&&i.push(errorAddTpGroups),!1):!0},validateMove:function(e,t,a,n){return a.hasClass("meazure")?(n&&n.push(errorAddTpGroups),!1):!0}},measures:{},normalizeModel:function(e){return e instanceof Array?a.map(e,function(e){return{name:e.name,title:e.label,isSpacer:!1,isMeasure:e.isMeasure,itemClass:e.isMeasure?"meazure":"dimenzion"}}):e.name?[{name:e.name,title:e.label,isSpacer:!1,isMeasure:!1,itemClass:"dimenzion"}]:[]}},crosstab:{nameAttr:"data-level",moveAttr:"data-dimension",filter:function(e){e=s.basicFilter(this.isOlapMode?e.slice(0,1):e);var t=!this.isOlapMode&&a.any(e,function(e){return e.param.extra&&e.param.extra.isMeasure});return t?e:s.removeDuplicatesFilter(e,this.axesCache,{id:"name",dimensionId:"groupId"})},row:{validateMove:function(e,t){return!(t.isDependent&&1==e.data.length)},validateAdd:function(e,t,n,i){if(a.isEmpty(e))return i&&i.push(adhocDesigner.messages.ADH_1215_FIELD_IN_USE),!1;var s=this,r=e[0].param.extra,l=this.axes.olap_columns.data;return!(a.isEmpty(e)||this.axes.olap_rows.isDependent&&(a.isEmpty(l)||r.hierarchyName&&1===l.length&&l[0].groupId===r.dimensionId)||localContext.showAddHierarchyConfirm(r.hierarchyName,r.dimensionId,function(){s.add(e,t,n)}))}},column:{validateAdd:function(e,t,n,i){if(a.isEmpty(e))return i&&i.push(adhocDesigner.messages.ADH_1215_FIELD_IN_USE),!1;var s=this,r=e[0].param.extra;return!localContext.showAddHierarchyConfirm(r.hierarchyName,r.dimensionId,function(){s.add(e,t,n)})}},normalizeModel:function(e){for(var t=[],n="",i=0;i<e.length;i++){for(var s=e[i],r=s.name,l={groupId:r,levels:[],liClass:"dimension",ulClass:"levels",measureHandle:""},o=0;o<s.levels.length;o++){var u=s.levels[o];if(u.visible&&!(u.recursiveLevelNumber>0))if(a.isEmpty(u.members))l.levels.push({id:a.uniqueId(u.name+"_"),name:u.name,groupId:r,label:u.display?u.display:u.name,depth:u.depth,isMeasure:!1,levelClass:"level"});else{a.extend(l,{isMeasure:!0,liClass:"measure",ulClass:"members",measureHandle:"<span class='handle'>&nbsp;</span>"});for(var d=0;d<u.members.length;d++){var m=u.members[d];m.isSpacer!==!0&&(n=(m.fieldDisplay?m.fieldDisplay:m.name)+(m.aggregateColumnName&&"Sum"!==m["function"]&&m.functionOrDefault?a.sprintf(" (%s)",m.functionOrDefault):""),l.levels.push({id:a.uniqueId(a.underscored(m.name)+"_"),name:m.field.name,groupId:r,label:n,depth:d,isMeasure:!0,levelClass:"member"}))}}}t.push(l)}return t},updateAxesDataCache:function(){this.axesCache=a.chain(this.axes).values().pluck("data").flatten().pluck("levels").flatten().value()}}},n.LayoutManager=LayoutManager}(jQuery,$,_,window);