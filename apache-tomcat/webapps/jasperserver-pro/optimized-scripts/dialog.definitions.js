JRS.ViewQueryDialog=function(e){var t=function(t){this.template=e(t.id),this.selectionContainer=t.selectionContainer,this.updateContent(t.content),this.registerEvents()};return t.fn=t.prototype,t.fn.close=function(){disableSelectionWithoutCursorStyle(this.selectionContainer),dialogs.popup.hide(this.template.get(0))},t.fn.show=function(){enableSelection(this.selectionContainer),dialogs.popup.show(this.template.get(0))},t.fn.updateContent=function(t){e(".content .body textarea",this.template).html(t)},t.fn.registerEvents=function(){e(".button",this.template).on("click",e.proxy(this.close,this))},t}(jQuery),JRS.SaveAsDialog=function(e,t){return function(r){function o(t){var r=e(t.templateMatcher);return c.cloneTemplate&&(r=r.clone()),c.cloneTemplate&&c.elementId&&r.attr("id",t.elementId),e(c.insertAfterMatcher).append(r),r.on("keydown",function(e){c.grabKeydownEvents&&e.stopPropagation(),e.keyCode==Event.KEY_ESC&&p.close()}),r}function i(e,t){var r={};for(inputName in t.inputMatchers)t.inputMatchers.hasOwnProperty(inputName)&&(r[inputName]=e.find(t.inputMatchers[inputName]));return r}function n(e){for(inputName in h)h.hasOwnProperty(inputName)&&(e[inputName]=h[inputName].val());if(m){var t=m.getSelectedNode();t?(e.folder=t.param.uri,e.isFolderWritable=t.param.extra?t.param.extra.isWritable:!0):e.folder=null}g&&(t=g.getSelectedNode(),t?(e.reportFolder=t.param.uri,e.isReportFolderWritable=t.param.extra?t.param.extra.isWritable:!0):e.reportFolder=null)}function a(e){e.stopPropagation(),n(f),c.prepareState&&c.prepareState(f),c.validator(f)&&c.saveHandler(f).then(function(){p.close()})}function s(e){e.stopPropagation(),p.close()}function l(e){var r=e.attr("id"),o=t.createRepositoryTree(r,{providerId:"adhocRepositoryTreeFoldersProvider",rootUri:"/",organizationId:c.organizationId,publicFolderUri:c.publicFolderUri,urlGetNode:"flow.html?_flowId=adhocTreeFlow&method=getNode",urlGetChildren:"flow.html?_flowId=adhocTreeFlow&method=getChildren",treeErrorHandlerFn:function(){}}),i=o.modifyRootObject;return o.modifyRootObject=function(e,t,r,n){for(var a=t?e:e.children,s=0,l=a.length;l>s;s++)a[s].extra.isWritable||(a[s].cssClass="readonly"),a[s].children&&o.modifyRootObject(a[s],!1,a[s],!0);return t?e=a:e.children=a,n?void 0:i.call(this,e,t,r)},o}var d={templateMatcher:"#saveAs",insertAfterMatcher:"#frame",cloneTemplate:!1,elementId:null,okButtonMatcher:".saveButton",cancelButtonMatcher:".cancelButton",inputMatchers:{name:".resourceName",description:".resourceDescription"},foldersTreeMatcher:"#saveDataViewFoldersTree",reportFoldersTreeMatcher:"#saveReportFoldersTree",organizationId:"",publicFolderUri:"/public",grabKeydownEvents:!0,validator:function(){return!0},saveHandler:function(){var t=e.Deferred();return t.resolve(),t}},c=e.extend({},d,r),p=this,u=o(c);this.dialogElement=u;var h=i(u,c);this.inputElements=h;var f={folder:null,isFolderWritable:!1,reportFolder:null,isReportFolderWritable:!1},m=null,g=null,v=u.find(c.foldersTreeMatcher),T=u.find(c.reportFoldersTreeMatcher);this.foldersTree=v,this.reportFoldersTree=T,this.open=function(t){f=t,dialogs.popup.show(u.get(0));for(inputName in h)if(h.hasOwnProperty(inputName)){var r=h[inputName],o=f[inputName];if(r[0]&&"SELECT"==r[0].tagName.toUpperCase()&&_.isArray(o)){r.empty();var i;_.each(o,function(e){i=new Option(e.label,e.id),i.id=e.id,r.append(i)})}else r.val(f[inputName])}u.find(c.okButtonMatcher).click(a),u.find(c.cancelButtonMatcher).click(s);var n=e.Deferred(),d=f.folder&&f.reportFolder?0:1;return f.folder&&(m=l(v),m.showTreePrefetchNodes(f.folder,function(){d++,f.folder&&m.openAndSelectNode(f.folder),2==d&&n.resolve()})),f.reportFolder&&T.length>0&&(g=l(T),g.showTreePrefetchNodes(f.reportFolder,function(){d++,g.openAndSelectNode(f.reportFolder),2==d&&n.resolve()})),n},this.close=function(){u.find(c.okButtonMatcher).unbind("click",a),u.find(c.cancelButtonMatcher).unbind("click",s),dialogs.popup.hide(u.get(0))}}}(jQuery,dynamicTree),JRS.RepositorySelectionDialog=function(e,t){var r={idsPrefix:"repSelDialog_",templateMatcher:"#repositorySelectionDialog",insertAfterMatcher:"#frame",okButtonMatcher:".okButton",cancelButtonMatcher:".cancelButton",repositoryTreeMatcher:"ul.repositoryTree",organizationId:"",publicFolderUri:"/public",treeFlowId:"treeFlow",treeProviderId:"repositoryExplorerTreeFoldersProvider",uriOnCancel:null,selectionValidationMessage:"Item not selected",acceptOnlyLeaf:!0,okHandler:function(){var t=e.Deferred();return t.resolve(),t}};return function(o){function i(t){var r=e(t.templateMatcher).clone();return s.elementId&&r.attr("id",t.elementId),e(s.insertAfterMatcher).append(r),r}function n(e){e.stopPropagation();var t=l._repositoryTree.getSelectedNode();if(!t||s.acceptOnlyLeaf&&t.isParent())return void alert(s.selectionValidationMessage);var r=s.okHandler(t.param.uri);r?r.then(function(){l.close()}):l.close()}function a(e){e.stopPropagation(),l.close(),s.uriOnCancel&&(document.location=s.uriOnCancel)}var s=e.extend({},r,o),l=this;this._createRepositoryTree=function(){var e=s.idsPrefix+"repTree";this.$repositoryTree.attr("id",e);var r=t.createRepositoryTree(e,{providerId:s.treeProviderId,rootUri:"/",organizationId:s.organizationId,publicFolderUri:s.publicFolderUri,urlGetNode:"flow.html?_flowId="+s.treeFlowId+"&method=getNode",urlGetChildren:"flow.html?_flowId="+s.treeFlowId+"&method=getChildren",treeErrorHandlerFn:function(){}});return r},this.init=function(){this.$dialogElement=i(s),this.$repositoryTree=this.$dialogElement.find(s.repositoryTreeMatcher),this.$dialogElement.find(s.okButtonMatcher).click(n),this.$dialogElement.find(s.cancelButtonMatcher).click(a)},this.open=function(){function t(e){if(e.isParent())for(var r=0;r<e.childs.length;r++)t(e.childs[r]);else"com.jaspersoft.ji.adhoc.AdhocDataView"==e.param.type&&(e.param.cssClass="adhocDataView",e.refreshStyle())}dialogs.popup.show(this.$dialogElement.get(0),!0),this._repositoryTree=this._createRepositoryTree();var r=e.Deferred();return this._repositoryTree.observe("children:loaded",function(e){var r=e.memo.nodes;r.each(function(e){t(e)})}),this._repositoryTree.showTreePrefetchNodes("/",function(){l._repositoryTree.openAndSelectNode("/"),r.resolve()}),this._repositoryTree.observe("leaf:dblclick",n),r},this.close=function(){dialogs.popup.hide(this.$dialogElement.get(0))},this.init()}}(jQuery,dynamicTree),JRS.GeneratorPropertiesDialog=function(e,t){function r(e){var t=dynamicTree.createRepositoryTree(e.treeId,{providerId:e.treeProviderId,rootUri:"/",organizationId:e.organizationId,publicFolderUri:e.publicFolderUri,urlGetNode:"flow.html?_flowId="+e.treeFlowId+"&method=getNode",urlGetChildren:"flow.html?_flowId="+e.treeFlowId+"&method=getChildren",treeErrorHandlerFn:function(){}});return t}var o={id:"reportGeneratorProperties",treeId:"advLocationTree",treeFlowId:"adhocTreeFlow",treeProviderId:"adhocDataViewsTreeDataProvider",organizationId:t.organizationId,publicFolderUri:t.publicFolderUri,advUri:void 0,reportGenerators:null,messages:{}},i=function(n){this.opts=jQuery.extend({},o,n),this.template=e("#"+this.opts.id),this.customGenerators=t.commonReportGeneratorsMetadata||[],this.registerEvents(),_.isUndefined(this.opts.advUri)?(e("#advTreePanel").removeClass(layoutModule.HIDDEN_CLASS),e("#reportGeneratorProperties").addClass(i.WITH_TREE_CLASS),this._tree=r(this.opts)):e("#reportGeneratorProperties").removeClass(i.WITH_TREE_CLASS),this._generatorSelect=new JRS.generatorSelect({id:"commonGeneratorSelect",parent:this.template.get(0),reportGenerators:this.customGenerators})};i.WITH_TREE_CLASS="withTree",i.NO_GENERATORS_CLASS=layoutModule.NO_GENERATORS_CLASS,i.fn=i.prototype,i.fn.show=function(){enableSelection(this.selectionContainer),0==this.customGenerators.length&&this.template.addClass(i.NO_GENERATORS_CLASS),dialogs.popup.show(this.template.get(0),!0);var e=n();e&&(e.template?this._generatorSelect.val(e.template,"TEMPLATE"):e.generator&&this._generatorSelect.val(e.generator,"GENERATOR"));var t=e&&e.sourceURI?e.sourceURI:"/",r=this._tree;r&&r.showTreePrefetchNodes(t,function(){e&&r.openAndSelectNode(t)})};var n=i.fn.store=function(e){var t=window.localStorage;if(!t)return null;if(!e){var r=t.getItem("reportGenerator");return r?JSON.parse(r):null}t.setItem("reportGenerator",JSON.stringify(e))},a=i.fn.ok=function(){var e=this.getValue();_.isUndefined(e.sourceURI)?alert(this.getMessage("advNotSelected")):_.isEmpty(e.template)&&"TEMPLATE"===this._generatorSelect.state?alert(this.getMessage("templateNotSelected")):(n(e),this.opts.okHandler&&this.opts.okHandler(e),this.close())},s=i.fn.close=function(){return disableSelectionWithoutCursorStyle(this.selectionContainer),dialogs.popup.hide(this.template.get(0)),this};return i.fn.getMessage=function(e){return this.opts.messages[e]},i.fn.getValue=function(){var e=this.opts.advUri;if(_.isUndefined(e)){var t=this._tree.getSelectedNode(),r=t&&"com.jaspersoft.ji.adhoc.AdhocDataView"==t.param.type;r&&(e=t.param.uri)}var o={sourceURI:e};return"TEMPLATE"===this._generatorSelect.state&&(o.template=this._generatorSelect.val()),"GENERATOR"===this._generatorSelect.state&&(o.generator=this._generatorSelect.val()),o},i.fn.registerEvents=function(){e("#reportGeneratorPropertiesBtnOk",this.template).on("click",e.proxy(a,this)),e("#reportGeneratorPropertiesBtnCancel",this.template).on("click",e.proxy(s,this))},i}(jQuery,__jrsConfigs__),JRS.generatorSelect=function(e,t,r){function o(t){return e("#"+t.options.id)}function i(t){t._radios=e("#"+t.options.id+" input[type="+T+"]").get();var r=t._radios.length;t._inputs=new Array(r);for(var o=0;r>o;o++){var i=t._radios[o].id,n=i.replace(g(T),""),a=e("#"+n);a.length>0&&(t._inputs[o]=a[0])}}function n(e){e.StateContract={},e._states=new Array(e._radios.length);var r=0;for(var o in _.StateContractPrototype){var i=t.clone(_.StateContractPrototype[o],!0);i.index=r,e.StateContract[o]=i,e._states[r]=o,r++}}function a(r,o){var i=r.StateContract.GENERATOR,n=e(r._inputs[i.index]);o&&o.length>0?(n.parents("li").removeClass("hidden"),t.each(o,function(t){n.append(e("<option />").val(t.id).text(t.label))})):n.parents("li").addClass("hidden")}function s(e){e.template.on("click",function(t){l(t.target)?e.refresh():d(t.target)&&m(e)})}function l(e){return e.type?"radio"==e.type:e.control&&"radio"==e.control.type}function d(e){return e.type&&"button"==e.type||"SPAN"==e.tagName&&"button"==e.parentNode.type}function c(t){e(t).attr("checked","checked")}function p(t){t=e(t);var r=t.parent();t.attr("disabled","disabled"),r.find("button").attr("disabled","disabled")}function u(t){t=e(t);var r=t.parent();t.attr("disabled",null),r.find("button").attr("disabled",null)}function h(t,r){e(t).val(r)}function f(t){return e(t).val()}function m(e){var t=e.StateContract[e.state],r=e._inputs[t.index];e._dialog||(e._dialog=new JRS.TemplateDialog({id:e.options.id+"TemplateDialog",parent:e.options.parent,okHandler:function(e){h(r,e)}})),e._dialog&&e._dialog.show(f(r))}function g(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}var v={id:"generatorSelect",defaultRadioIdPrefix:"DefaultTemplateRadio",customTemplateRadioIdPrefix:"CustomTemplateRadio",customGeneratorRadioIdPrefix:"CustomGeneratorRadio",reportGenerators:[{id:"custom",label:"Custom"}],treeId:"templateLocationTree",treeFlowId:"adhocTreeFlow",treeProviderId:"templateTreeDataProvider",organizationId:r.organizationId,publicFolderUri:r.publicFolderUri},T="radio",_=function(e){this.StateContract={},this.options=jQuery.extend({},v,e),this.template=o(this),this.state="DEFAULT",i(this),n(this),a(this,this.options.reportGenerators),s(this),this.refresh()};return _.fn=_.prototype,_.StateContractPrototype={DEFAULT:{index:0},TEMPLATE:{index:1},GENERATOR:{index:2}},_.fn.val=function(e,r){var o=this.StateContract[this.state];return t.isString(e)?(t.isString(r)&&t.has(this.StateContract,r)&&(o=this.StateContract[r]),c(this._radios[o.index]),h(this._inputs[o.index],e),this.refresh(),void 0):f(this._inputs[o.index])},_.fn.refresh=function(){for(var e=0;e<this._radios.length;e++)this._radios[e].checked?(u(this._inputs[e]),this.state=this._states[e]):p(this._inputs[e])},_.fn.hide=function(){this.template.addClass("hidden")},_.fn.show=function(){this.template.removeClass("hidden")},_}(jQuery,window._,__jrsConfigs__),JRS.TemplateDialog=function(e,t){function r(e){var t=dynamicTree.createRepositoryTree(e.treeId,{providerId:e.treeProviderId,rootUri:"/",organizationId:e.organizationId,publicFolderUri:e.publicFolderUri,urlGetNode:"flow.html?_flowId="+e.treeFlowId+"&method=getNode",urlGetChildren:"flow.html?_flowId="+e.treeFlowId+"&method=getChildren",treeErrorHandlerFn:function(){}});return t}var o=function(){return{treeId:"TemplateTree",treeFlowId:"adhocTreeFlow",treeProviderId:"templateTreeDataProvider",organizationId:t.organizationId,publicFolderUri:t.publicFolderUri,defaultTemplateUri:t.defaultTemplateUri}},i=function(t){this.opts=jQuery.extend({},o(),t),this.opts.treeId=this.opts.id+"Tree",this.template=e("#"+this.opts.id),this.registerEvents(),this._tree=r(this.opts)};i.fn=i.prototype,i.fn.show=function(e){dialogs.childPopup.show(this.template.get(0),!0,this.opts.parent);var t=this.opts.defaultTemplateUri||"/",r=this._tree;r.showTreePrefetchNodes(e||t,function(){r.openAndSelectNode(e||t)})};var n=i.fn.ok=function(){var e=this._tree.getSelectedNode(),t=e&&"com.jaspersoft.jasperserver.api.metadata.common.domain.FileResource"==e.param.type;t&&(this.opts.okHandler&&this.opts.okHandler(e.param.uri),this.close())},a=i.fn.close=function(){return disableSelectionWithoutCursorStyle(this.selectionContainer),dialogs.childPopup.hide(this.template.get(0)),this};return i.fn.registerEvents=function(){e("#"+this.opts.id+"OkTemplate",this.template).on("click",e.proxy(n,this)),e("#"+this.opts.id+"CloseTemplate",this.template).on("click",e.proxy(a,this))},i}(jQuery,__jrsConfigs__);