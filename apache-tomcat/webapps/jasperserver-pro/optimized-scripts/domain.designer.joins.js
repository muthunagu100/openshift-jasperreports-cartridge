dd.joins={PAGE:"joins",TREE_TEMPLATE_DOM_ID:"list_responsive_collapsible_type_tables",TREE_DRAG_PATTERN:".draggable",LEFT_TREE_DOM_ID:"leftTree",RIGHT_TREE_DOM_ID:"rightTree",TREE_DATA_PROVIDER:"selectedTreeDataProvider",JOINS_LIST_TEMPLATE_ID:"list_domain_designer_joins",JOINS_LIST_TEMPLATE_ITEM_ID:"list_domain_designer_joins:leaf",JOINS_LIST_DOM_ID:"joinsList",JOINS_DOM_ID:"joinsPanel",LIST_REMOVE_LINK_PATTERN:"a",JOIN_BUTTON_IDS:["inner","left","right","full"],ALL_JOINS_TAB_ID:"allJoins",SELECTED_TABLE_JOINS_TAB_ID:"selectedTableJoins",JOINS_LIST_MODE:{ALL_JOINS:"allJoins",BY_TABLE:"byTable"},TOOLBAR_COPY_TABLE_ID:"copyTable",TOOLBAR_CHANGE_TABLE_ID:"changeID",TOOLBAR_DELETE_TABLE_ID:"delete",REMOVE_JOIN_LINK_PATTERN:"a.launcher",leftTree:null,rightTree:null,joinsList:null,joins:null,usedTablesByItemId:null,usedFieldsByItemId:null,usedJoinedTablesByItemId:null,dataSourceId:null,copyMoveController:new domain.TablesCopyMoveController,joinsListViewMode:null,getValidationPostData:function(){return{selectedModel:this.getSelectedModel(),joinsInput:Object.toJSON(this.joinsList.getItems()),page:this.PAGE}},getSelectedModel:function(){var e=this.leftTree.getRootNode().childs;return Object.toJSON(e)},fillForm:function(){$("selectedModel").writeAttribute("value",this.getSelectedModel()),$("joinsInput").writeAttribute("value",Object.toJSON(this.joinsList.getItems())),$("unsavedChangesPresent").writeAttribute("value",dd.isUnsavedChangesPresent().toString())},initFromOptions:function(e){this.dataSourceId=e.dataSourceId,this.joins=e.jsonJoins,this.usedTablesByItemId=e.usedTablesByItemId,this.usedFieldsByItemId=e.usedFieldsByItemId,this.usedJoinedTablesByItemId=e.usedJoinedTablesByItemId},init:function(e){this.initFromOptions(e),dd.calcFieldsAndFiltersValidator.init(dd.validateForCalcFields.bind(dd),dd.getTablesUsedForFilters.bind(dd,this.usedTablesByItemId[this.dataSourceId])),domain.resetTreeSelectionHandler.init(this.JOIN_BUTTON_IDS.concat([this.LEFT_TREE_DOM_ID,this.RIGHT_TREE_DOM_ID,this.JOINS_DOM_ID,this.TOOLBAR_COPY_TABLE_ID,this.TOOLBAR_CHANGE_TABLE_ID,this.TOOLBAR_DELETE_TABLE_ID]).collect(function(e){return"#"+e}).concat([this.REMOVE_JOIN_LINK_PATTERN]),function(){return[this.leftTree,this.rightTree]}.bind(this),this.updateButtonsState.bind(this)),domain.registerClickHandlers([this.changeJoinsListViewModeClickEventHandler.bind(this),this.createJoinButtonClickEventHandler.bind(this)]),dd_joins.deleteJoinValidator.init(this.validateUnjoinedTableForCalcFields.bind(this),this.buildDataIslands.bind(this),this.getNotJoinedTablesAfterDeleting.bind(this)),this.initTrees(),this.updateButtonsState()},initTrees:function(){this.leftTree=domain.createItemsTree({multiSelectEnabled:!1,treeId:this.LEFT_TREE_DOM_ID,providerId:this.TREE_DATA_PROVIDER,templateDomId:this.TREE_TEMPLATE_DOM_ID,nodeClass:domain.TablesNode}),this.rightTree=domain.createItemsTree({multiSelectEnabled:!1,treeId:this.RIGHT_TREE_DOM_ID,providerId:this.TREE_DATA_PROVIDER,templateDomId:this.TREE_TEMPLATE_DOM_ID,nodeClass:domain.TablesNode});for(var e in this.treeEventFactory)[this.leftTree,this.rightTree].invoke("observe",e,this.treeEventFactory[e].bindAsEventListener(this));this.leftTree.showTree(1,this.afterLeftTreeLoaded.bind(this),domain.treeErrorHandler),this.rightTree.showTree(1,this.buildTreeMap.bind(this,this.rightTree),domain.treeErrorHandler)},afterLeftTreeLoaded:function(){this.buildTreeMap(this.leftTree),this.initJoinsList(),this.makeTreeEditable(this.leftTree)},makeTreeEditable:function(e){$H(e.treeMap).each(function(e){var t=e.value;t.editable=t.param.type===t.Types.Folder.name&&t.param.id!==t.CONSTANT_TABLE_ID})},initJoinsList:function(){this.joinsListViewMode=this.JOINS_LIST_MODE.ALL_JOINS;var e=this.joins.collect(function(e){return this.createJoinsListItem.bind(this)(e.left,e.right,e.type)}.bind(this));this.joinsList=new domain.JoinsList(this.JOINS_LIST_DOM_ID,{listTemplateDomId:this.JOINS_LIST_TEMPLATE_ID,items:e});for(var t in this.listEventFactory)this.joinsList.observe(t,this.listEventFactory[t].bindAsEventListener(this));this.joinsList.show()},buildTreeMap:function(e){e.treeMap={};var t=function(i){e.treeMap[i.param.id]=i,i.isParent()&&i.childs.each(t)};e.getRootNode().childs.each(t)},createJoinsListItem:function(e,t,i){var n=this.leftTree.treeMap[e],a=this.leftTree.treeMap[t],s={left:{id:n.param.id,label:n.param.extra.itemId,table:{id:n.parent.param.id,label:n.parent.param.extra.itemId}},right:{id:a.param.id,label:a.param.extra.itemId,table:{id:a.parent.param.id,label:a.parent.param.extra.itemId}},type:i};return new domain.JoinsListItem({value:s,templateDomId:this.JOINS_LIST_TEMPLATE_ITEM_ID})},removeJoin:function(e){var t=this.joinsList.getItems().collect(function(e){return e.getValue()}),i=e.getValue(),n=function(n){dd.setUnsavedChangesPresent(!0),n&&n.first()&&(dd.deleteNodesFromTreeById(n,this.leftTree,this.copyMoveController),dd.deleteNodesFromTreeById(n,this.rightTree,this.copyMoveController)),this.deleteNotJoinedTablesFromState(t,i),e.remove(),this.updateButtonsState()};dd_joins.deleteJoinValidator.validate(t,i,n.bind(this))},buildDataIslands:function(e){var t=[];return e.each(function(e){var i=e.left.table.label,n=e.right.table.label,a=!1;t.each(function(e){(e.include(i)||e.include(n))&&(e.push(i),e.push(n),a=!0)}),a||t.push([i,n])}),t.collect(function(e){return e.uniq()})},compareJoins:function(e,t,i,n){return e==i&&t==n||t==i&&e==n},getNotJoinedTablesAfterDeleting:function(e,t){var i=[];if(!t||!this.usedJoinedTablesByItemId||!this.usedJoinedTablesByItemId[this.dataSourceId])return i;var n=this.usedJoinedTablesByItemId[this.dataSourceId],a=this.buildDataIslands(e.findAll(function(e){return!this.compareJoins(e.left.id,e.right.id,t.left.id,t.right.id)}.bind(this))),s=[];return n.each(function(e){a.each(function(t){var i=t.indexOf(e[0])>-1,n=t.indexOf(e[1])>-1;i&&n&&s.push([e[0],e[1]])})}),n.each(function(e){var t=!s.find(function(t){return this.compareJoins(e[0],e[1],t[0],t[1])}.bind(this));(!s.first()||t)&&i.push(e)}.bind(this)),i},deleteNotJoinedTablesFromState:function(e,t){var i=this.getNotJoinedTablesAfterDeleting(e,t);if(this.usedJoinedTablesByItemId&&this.usedJoinedTablesByItemId[this.dataSourceId]){var n=this.usedJoinedTablesByItemId[this.dataSourceId],a=[];n.each(function(e,t){i.each(function(i){this.compareJoins(e[0],e[1],i[0],i[1])&&a.push(t)}.bind(this))}.bind(this)),a=a.reverse(),a.each(function(e){n.splice(e,1)})}},updateJoinsByTableListState:function(){if(this.joinsListViewMode===this.JOINS_LIST_MODE.BY_TABLE){var e=this.leftTree.selectedNodes.first(),t=null;e&&(t=e.isParent()?e.param.id:e.parent.param.id),this.joinsList.getItems().each(function(e){var i=t?e.getValue().left.table.id!==t&&e.getValue().right.table.id!==t:!0;e.hide(i)})}},createJoin:function(e,t,i){dd.setUnsavedChangesPresent(!0);var n=this.createJoinsListItem(e,t,i);this.changeJoinTypeForAllCompositeJoins(n),this.joinsList.addItems([n]),this.joinsList.refresh(),this.updateButtonsState()},changeJoinTypeForAllCompositeJoins:function(e){var t=e.getValue(),i=this.findOtherCompositeJoins(t);i&&i.first()&&i.each(function(e,t){t.setJoinType(e.type)}.bind(this,t))},findOtherCompositeJoins:function(e){var t=e.left.table.id,i=e.right.table.id;return this.joinsList.getItems().findAll(function(n){var a=n.getValue();if(e===a)return!1;var s=a.left.table.id===t||a.right.table.id===t,d=a.left.table.id===i||a.right.table.id===i;return s&&d})},removeTable:function(e){if(e){var t=function(t){dd.setUnsavedChangesPresent(!0);var i=e.param.id;t&&t.first()&&(dd.deleteNodesFromTreeById(t,this.leftTree,this.copyMoveController),dd.deleteNodesFromTreeById(t,this.rightTree,this.copyMoveController)),dd.deleteNodesFromTreeById([i],this.leftTree,this.copyMoveController),dd.deleteNodesFromTreeById([i],this.rightTree,this.copyMoveController),this.joinsList.getItems().each(function(e){var t=e.getValue();(t.left.table.id===i||t.right.table.id===i)&&e.remove()}),this.updateButtonsState()};dd.calcFieldsAndFiltersValidator.validate([e],!1,t.bind(this))}},duplicateTableForTree:function(e,t,i){var n=this.copyMoveController.copy([t],e.getRootNode(),!0).first();n.editable=!!i,e.treeMap[n.param.id]=n,n.childs.first()&&n.childs.each(function(t){e.treeMap[t.param.id]=t}.bind(this)),e.resortSubtree(n.parent),e.renderTree()},duplicateTable:function(e){e&&(dd.setUnsavedChangesPresent(!0),this.duplicateTableForTree(this.leftTree,e,!0),this.duplicateTableForTree(this.rightTree,e,!1),sessionManager.resetSession(dd.flowExecutionKey))},editNode:function(e){e&&e.edit(),$(e._getTitle().parentNode).removeClassName(layoutModule.ERROR_CLASS)},nodeEndEdit:function(e){dynamicTree.editaborted&&(dynamicTree.treeNodeEdited=e,dynamicTree.editaborted=!1)},changeNodeId:function(e,t,i){var n=e.param.id,a=dynamicTree.trees[e.getTreeId()];e.isParent()?(e.param.extra.originalId||(e.param.extra.originalId=e.param.extra.itemId),e.param.extra.itemId=t,e.changeName(t),e.param.id=e.param.extra.datasourceId+"."+e.param.extra.itemId,delete a.treeMap[n],a.treeMap[e.param.id]=e):(e.param.extra.originalId||(e.param.extra.originalId=e.parent.param.extra.originalId+"."+e.param.extra.itemId),e.param.id=e.parent.param.id+"."+e.param.extra.itemId,delete a.treeMap[n],a.treeMap[e.param.id]=e,i&&this.joinsList.getItems().each(function(e,t,i){var n=i.getValue();n.left.id===t?(n.left.id=e.param.id,n.left.table.id=e.parent.param.id,n.left.table.label=e.parent.param.extra.itemId,i.refresh()):n.right.id===t&&(n.right.id=e.param.id,n.right.table.id=e.parent.param.id,n.right.table.label=e.parent.param.extra.itemId,i.refresh())}.curry(e,n)))},isNewAliasExists:function(e){var t=$H(this.leftTree.treeMap).values(),i=t.find(function(t){return t.param.extra.itemId===e});return!!i},updateExpressions:function(e){e&&e.first()&&e.each(function(e){for(var t in e)[this.leftTree,this.rightTree].each(function(i){var n=i.treeMap[t];n.param.extra.expression=e[t]})}.bind(this))},changeNodeAlias:function(e,t){if(e.name!==t){if(!dd.nonEmptyItemIdValidator(t).isValid||this.isNewAliasExists(t))return $(e._getTitle().parentNode).addClassName(layoutModule.ERROR_CLASS),void(dynamicTree.editaborted=!0);$(e._getTitle().parentNode).removeClassName(layoutModule.ERROR_CLASS);var i=e.param.id,n=e.param.extra.itemId,a=this.rightTree.treeMap[i],s=function(i){return"error"===i?($(e._getTitle().parentNode).addClassName(layoutModule.ERROR_CLASS),void(dynamicTree.editaborted=!0)):(dd.setUnsavedChangesPresent(!0),this.updateExpressions(i.changesExpressions),void[e,a].each(function(e,i){this.changeNodeId(e,t),e.childs.each(function(e){this.changeNodeId(e,t,0===i)}.bind(this))}.bind(this)))};dd.changeTableAlias(n,t,s.bind(this))}},validateUnjoinedTableForCalcFields:function(e,t){var i={flowExecutionKey:dd.flowExecutionKey,eventId:"validateUnjoinedTableForCalcFields"},n={unjoinedTableItemId:e};domain.sendAjaxRequest(i,n,t)},changeJoinsListViewModeClickEventHandler:function(e){var t=!1;return this.changeJoinsListHandlerMap.each(function(i){if(domain.elementClicked(e,i.key)){if(t=!0,this.joinsListViewMode===i.value)throw $break;throw this.joinsListViewMode=i.value,this.joinsListViewMode===this.JOINS_LIST_MODE.BY_TABLE?this.updateJoinsByTableListState():this.joinsList.getItems().each(function(e){e.hide(!1)}),$break}}.bind(this)),t},treeClickEventHandler:function(e){var t=dynamicTree.trees[e.getTreeId()];t===this.leftTree&&this.updateJoinsByTableListState(),this.updateButtonsState()},createJoinButtonClickEventHandler:function(e){var t=!1;return this.createJoinHandlerMap.each(function(i){if(domain.elementClicked(e,i.key)){var n=this.leftTree.selectedNodes.first(),a=this.rightTree.selectedNodes.first(),s=this.joinsList.getItems().collect(function(e){return e.getValue()});throw dd_joins.createJoinValidator.validate(n,a,s,this.createJoin.bind(this,n.param.id,a.param.id,i.value.type)),sessionManager.resetSession(dd.flowExecutionKey),t=!0,$break}}.bind(this)),t},updateButtonsState:function(){this.updateToolbarButtonsState(),this.updateCreateJoinButtonsState(),this.updateJoinsByTableListState()},updateToolbarButtonsState:function(){[this.TOOLBAR_COPY_TABLE_ID,this.TOOLBAR_CHANGE_TABLE_ID,this.TOOLBAR_DELETE_TABLE_ID].each(function(e){toolbarButtonModule.setButtonState($(e),this.toolbarButtonsEnabled())}.bind(this))},updateCreateJoinButtonsState:function(){var e=this.leftTree.selectedNodes.first(),t=this.rightTree.selectedNodes.first(),i=e&&!e.isParent(),n=t&&!t.isParent(),a=i?e.param.extra.expression:!0,s=n?t.param.extra.expression:!0,d=i&&n?e.parent.param.id===t.parent.param.id:!0,r=!d&&!a&&!s;r&&(r=!this.joinsList.getItems().find(function(i){var n=i.getValue();return this.compareJoins(e.param.id,t.param.id,n.left.id,n.right.id)}.bind(this))),this.createJoinHandlerMap.each(function(e){domain.enableButton(e.value.domId,r)})}};var dd_joins=dd.joins;dd_joins.toolbarActionMap={copyTable:"dd_joins.copyTable",changeID:"dd_joins.changeTableId","delete":"dd_joins.deleteTable"},dd_joins.copyTable=function(){var e=dd_joins.leftTree.selectedNodes.first();dd_joins.duplicateTable.bind(dd_joins,e)()},dd_joins.changeTableId=function(){dd_joins.editNode(dd_joins.leftTree.selectedNodes.first())},dd_joins.deleteTable=function(){var e=dd_joins.leftTree.selectedNodes.first();dd_joins.removeTable.bind(dd_joins,e)()},dd_joins.toolbarButtonsEnabled=function(){var e=dd_joins.leftTree.selectedNodes.first();return e&&e.isParent()&&e.param.id!==e.CONSTANT_TABLE_ID&&e.param.id!==e.CROSSTABLES_FIELDS_TABLE_ID},dd_joins.treeEventFactory={"leaf:mouseup":function(e){this.treeClickEventHandler(e.memo.node),Event.stop(e)},"node:mouseup":function(e){this.treeClickEventHandler(e.memo.node),Event.stop(e)},"node:dblclick":function(e){this.editNode(e.memo.node),Event.stop(e)},"node:edit":function(e){this.changeNodeAlias(e.memo.node,e.memo.newValue),Event.stop(e)},"node:endEdit":function(e){this.nodeEndEdit(e.memo.node),Event.stop(e)}},dd_joins.listEventFactory={"item:change":function(e){var t=e.memo.item;t.getValue().type=e.memo.targetEvent.currentTarget.value,this.changeJoinTypeForAllCompositeJoins(t),Event.stop(e)},"item:click":function(e){var t=e.memo.targetEvent.element(),i=e.memo.item;t.match(this.LIST_REMOVE_LINK_PATTERN)&&this.removeJoin(i),Event.stop(e)}},dd_joins.changeJoinsListHandlerMap=$H({"#allJoins":dd_joins.JOINS_LIST_MODE.ALL_JOINS,"#selectedTableJoins":dd_joins.JOINS_LIST_MODE.BY_TABLE}),dd_joins.createJoinHandlerMap=$H({"#inner":{type:"inner",domId:"inner"},"#left":{type:"leftOuter",domId:"left"},"#right":{type:"rightOuter",domId:"right"},"#full":{type:"fullOuter",domId:"full"}}),"undefined"==typeof require&&document.observe("dom:loaded",dd.initialize.bind(dd));