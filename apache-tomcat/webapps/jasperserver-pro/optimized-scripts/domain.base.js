var domain={PROPAGATE_EVENT:"propagateEvent",_messages:{},disabledFolderTooltip:"disabledFolderTooltip",getMessage:function(e,r){var n=this._messages[e];return n?new Template(n).evaluate(r?r:{}):""},setMessage:function(e,r){this._messages[e]=r},treeErrorHandler:function(){throw"exception while loading tree"},submitForm:function(e,r,n){if(r){var t=buildActionUrl(r);n&&n(),$(e).writeAttribute("method","post").writeAttribute("action",t),$(e).submit()}},sendAjaxRequest:function(e,r,n,t){var o=buildActionUrl(e),d={postData:Object.toQueryString(r),callback:n,errorHandler:this._serverErrorHandler,mode:AjaxRequester.prototype.EVAL_JSON};t&&Object.extend(d,t),ajaxTargettedUpdate(o,d)},_serverErrorHandler:function(e){return baseErrorHandler(e)},elementClicked:function(e,r){return e&&r?matchAny(e,[r],!0):!1},basicClickHandler:function(e,r,n){var t=null;return r.any(function(r){return t=domain.elementClicked(e,r.key),t?(Object.isFunction(r.value)?r.value(t):Object.isFunction(n)&&n(r.value),!0):void 0})},registerClickHandlers:function(e,r,n){if(domain._bodyClickEventHandlers)return void(n?Array.prototype.unshift:Array.prototype.push).apply(domain._bodyClickEventHandlers,e);domain._bodyClickEventHandlers=e;var t=r?r:"body";$$(t)[0].observe(isSupportsTouch()?"touchstart":"click",function(e){var r=e.element();domain._bodyClickEventHandlers&&domain._bodyClickEventHandlers.each(function(n){var t=n(r);if(t)throw t!==domain.PROPAGATE_EVENT&&Event.stop(e),$break})})},enableButton:function(e,r){"string"==typeof e&&(e=$(e)),e.disabled=r,r?buttonManager.enable(e):buttonManager.disable(e)},setOptionsToSelect:function(e,r){return e&&(e.update(""),r)?(r.each(function(r){var n={value:r.value,title:r.label};r.selected&&(n.selected="selected");var t=new Element("option",n);t.appendChild(document.createTextNode(r.label)),e.appendChild(t)}),e):void 0},getDataIslandId:function(e,r){var n=dynamicTree.trees[e.getTreeId()].getRootNode(),t=function o(e,r){return null===e.parent||e.parent===n?e.param.extra[r]:o(e.parent,r)};return t(e,r)},areNodesFromSameIsland:function(e,r){var n=e.any(function(e){return e.param.extra.isConstant});if(n)return!0;var t=1===e.pluck("parent").uniq().length;return t?!0:1===e.map(function(e){return domain.getDataIslandId(e,r||"itemId")}).uniq().length},NumberFormat:function(e,r){var n="."===e,t=new RegExp("["+e.gsub(/\s/,"\\s")+"]+"),o=new RegExp("["+r.gsub(/\s/,"\\s")+"]+"),d=new RegExp("^-|\\"+r+"?\\d+|\\"+r+"$|\\"+e+"+","g");return{toNumber:function(e){return!e||!n&&/[.]/.test(e)?0/0:Number(e.gsub(o,"").gsub(t,"."))},normalizeNumberEntry:function(n){var t=n.strip().match(d);if(!t)return"";for(var o=!1,i=0;i<t.length;i++)t[i].startsWith(e)?o?delete t[i]:(t[i]=e,o=!0):t[i].startsWith(r)&&o&&(t[i]=t[i].substring(1));var a=t.join("");return a},isInteger:function(e){return t.test(e)}}},baseValidator:function(e,r){var n=!0,t="";return e()&&(t=r,n=!1),{isValid:n,errorMessage:t}},maxLengthValidator:function(e,r,n){return domain.baseValidator(function(e,r){return e.length>r}.curry(e,r),n)},minLengthValidator:function(e,r,n){return domain.baseValidator(function(e,r){return e.length<r}.curry(e,r),n)},valueNotEmptyValidator:function(e,r){return domain.baseValidator(function(e){return Object.isArray(e)&&0===e.length||!e||!String(e).strip()}.curry(e),r)},stringIdValidator:function(e,r){return domain.baseValidator(function(e){return!/^[^0-9() .,'"=!+-/><//:][^() .,'"=!+-/><//:]*$/.test(e)}.curry(e),r)},numberValidator:function(e,r,n){return domain.baseValidator(isNaN.curry(r.toNumber(e)),n)},numberBoundsValidator:function(e,r,n){return domain.baseValidator(function(e,r){return 1/0===e||e===-1/0?!0:!(e<=r.max&&e>=r.min)}.curry(e,r),n)},rangeValidator:function(e,r,n){return domain.baseValidator(function(e,r){return!(r>e)}.curry(e,r),n)},dateValidator:function(e,r,n){return domain.baseValidator(function(e,r){return 0===getDateFromFormat(r,e)}.curry(r,e),n)}};domain.NodeCopyMoveController=function(){},domain.NodeCopyMoveController.addMethod("copy",function(e,r,n){if(e&&e.length>0&&r){var t=dynamicTree.trees[r.getTreeId()],o=e.collect(function(e){var o=e.param.id,d=this._copyParentStructure(e,t);return d?this._mergeToDestTree(d,r,o,n):null}.bind(this));return r.isloaded=!0,o.without(null)}}),domain.NodeCopyMoveController.addMethod("copySelected",function(e,r){return sourceTree&&r?this.copy(sourceTree.selectedNodes,r):void 0}),domain.NodeCopyMoveController.addMethod("move",function(e,r){if(e&&r){var n=this.copy(e,r);return this.hide(e),n}}),domain.NodeCopyMoveController.addMethod("moveSelected",function(e,r){return e&&r?this.move(e.selectedNodes,r):void 0}),domain.NodeCopyMoveController.addMethod("hide",function(e,r,n){if(e&&e.length>0){r||(r=this._getVisibleChildrenCount),n||(n=function(e,r){e.hide(r)});var t=dynamicTree.trees[e[0].getTreeId()];e.collect(function(e){return e.id}).each(function(e){var o=dynamicTree.nodes[e];n(o,!0);for(var d=o.parent;d&&d!=t.getRootNode()&&!(r(d)>0);)n(d,!1),d.refreshStyle(),d=d.parent}.bind(this))}}),domain.NodeCopyMoveController.addMethod("_handleDuplicatedNode",function(e){return e.param.id}),domain.NodeCopyMoveController.addMethod("_markAsLoaded",function(e){e.isloaded=!0,e.isParent()&&e.childs.each(function(e){this._markAsLoaded(e)}.bind(this))}),domain.NodeCopyMoveController.addMethod("_mergeToDestTree",function(e,r,n,t){if(r){var o=dynamicTree.trees[r.getTreeId()];if(t)return n=this._handleDuplicatedNode(e,r),o.findNodeById(n,e);var d=o.findNodeChildByMetaName(r,e.param.id);return null!=d?(d.isHidden()&&d.show(),e.hasChilds()&&(d.disabled&&d.enable(e.tooltip),e.childs.each(function(e){this._mergeToDestTree(e,d)}.bind(this))),o.findNodeById(n,d)):(r.addChild(e),this._markAsLoaded(e),o.findNodeById(n,e))}}),domain.NodeCopyMoveController.addMethod("_copyParentStructure",function(e,r){if(e&&r){var n=dynamicTree.trees[e.getTreeId()];if(e.disabled)return null;for(var t=this._copyNode(e,r,!0),o=e.parent,d=null;o&&o!=n.getRootNode();)d=this._copyNode(o,r,!1),d.addChild(t),t=d,o=o.parent;return t}}),domain.NodeCopyMoveController.addMethod("_buildMetanode",function(e){return deepClone(e.param)}),domain.NodeCopyMoveController.addMethod("_copyNode",function(e,r,n){if(e&&r){var t=r.processNode(this._buildMetanode(e));n&&(e.hasChilds()?e.childs.each(function(e){if(!e.disabled){var e=this._copyNode(e,r,n);e&&t.addChild(e)}}.bind(this)):t.setHasChilds(!1));var o=e.childs.findAll(function(e){return e.disabled});return e.childs.length>0&&o.length==e.childs.length?null:t}}),domain.NodeCopyMoveController.addMethod("_delete",function(e){e&&e.collect(function(e){return e.id}).each(function(e){var r=dynamicTree.nodes[e];r&&r.parent.removeChild(r)})}),domain.NodeCopyMoveController.addMethod("_getVisibleChildrenCount",function(e){var r=e.childs.findAll(function(e){return e.isHidden()});return e.childs.length-r.length}),domain.resetTreeSelectionHandler={_COMMON_ELEMENTS_TO_SAVE_SELECTION:["#pageDimmer","#detail","#standardConfirm"],_getTrees:null,_elementIds:null,_callback:null,_validator:null,init:function(e,r,n,t){domain.resetTreeSelectionHandler._init.bind(domain.resetTreeSelectionHandler,e,r,n,t)()},_init:function(e,r,n,t){this._getTrees=r,this._callback=n,this._validator=t,this._elementIds=this._COMMON_ELEMENTS_TO_SAVE_SELECTION.concat(e),domain.registerClickHandlers([this._removeTreeSelectionClickEventHandler.bind(this)],null,!0)},_removeTreeSelectionClickEventHandler:function(e){if(!matchAny(e,this._elementIds,!0)){var r=!1;return this._getTrees().each(function(e){if(e.selectedNodes&&e.selectedNodes.first())throw r=!0,$break}),r?this._validator&&!this._validator()?!0:(this._getTrees().each(function(e){e._deselectAllNodes()}),this._callback&&this._callback(),!1):!1}}},domain.NodeChangeOrderController=function(){},domain.NodeChangeOrderController.addMethod("findNodeWithSpecificOrder",function(e,r,n){for(var t=e.length-1;t>=0;t--)if(e[t].isSelected()==n&&e[t].orderNumber===r)return e[t];return null}),domain.NodeChangeOrderController.addMethod("findMaxSiblingNode",function(e,r,n){var t=null,o=null;return e.each(function(e){e.isSelected()==r&&(null===t||n==e.orderNumber<t)&&(t=e.orderNumber,o=e)}),o}),domain.NodeChangeOrderController.addMethod("moveNode",function(e,r,n,t){var o=e.orderNumber,d=e.parent.childs,i=null,a=null;n?(i=this.findMaxSiblingNode(d,!1,r,e.param.type),a=i?i.orderNumber:-1,d.each(function(n){n.param.id!==e.param.id&&(r==n.orderNumber>a&&r==n.orderNumber<o||n.orderNumber==a)&&(n.orderNumber=r?n.orderNumber+1:n.orderNumber-1,t&&t(n,n.orderNumber))}),t&&t(e,a),e.orderNumber=a):(a=r?e.orderNumber-1:e.orderNumber+1,i=this.findNodeWithSpecificOrder(d,a,!1),i&&(t&&t(e,a),t&&t(i,o),e.orderNumber=a,i.orderNumber=o))}),domain.NodeChangeOrderController.addMethod("nodeAscSorter",function(e,r){return e.orderNumber-r.orderNumber}),domain.NodeChangeOrderController.addMethod("nodeDescSorter",function(e,r){return r.orderNumber-e.orderNumber}),domain.DisplayNodeChangeOrderController=function(){domain.NodeChangeOrderController.call()},domain.DisplayNodeChangeOrderController.prototype=deepClone(domain.NodeChangeOrderController.prototype),domain.DisplayNodeChangeOrderController.addMethod("findMaxSiblingNode",function(e,r,n,t){var o=null,d=null;return e.each(function(e){e.isSelected()==r&&(null!==o&&n!=e.orderNumber<o||(t?e.param.type!==t:0)||(o=e.orderNumber,d=e))}),d});