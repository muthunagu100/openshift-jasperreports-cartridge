define(["require","exports","module","jquery","underscore","highcharts","adhoc/chart/adhocToHighchartsAdapter","adhoc/chart/adhocDataProcessor","adhoc/chart/highchartsDataMapper","adhoc/chart/formattingDialog/model/FormattingDialogModel","adhoc/chart/formattingDialog/view/FormattingDialogView","logger","jquery.ui","prototype","utils.common","designer.base"],function(e,t,r){var n=e("jquery"),i=e("underscore"),a=e("highcharts"),s=e("adhoc/chart/adhocToHighchartsAdapter"),o=e("adhoc/chart/adhocDataProcessor"),l=e("adhoc/chart/highchartsDataMapper"),c=e("adhoc/chart/formattingDialog/model/FormattingDialogModel"),d=e("adhoc/chart/formattingDialog/view/FormattingDialogView"),u=e("logger").register(r);e("jquery.ui"),e("prototype"),e("utils.common"),e("designer.base");var h={},m=h;return i.extend(m,{debug:!1,mode:null,controller:"ich",state:{},cache:[],initd:!1,hasAllData:!1,groupLevel:{column:0,row:0},firstRendering:!0,chartContainerSelector:"#chartContainer",reset:function(){m.isDesignerInitialized=!1},setMode:function(e){this.mode=e},getMode:function(){return this.mode},flush:function(){this.hasAllData=!1,this.cache=[]},setUp:function(){},isOLAP:function(){return this.getMode()===designerBase.OLAP_ICHART},isOlapMode:function(){return this.getMode()===designerBase.OLAP_ICHART},isNonOlapMode:function(){return this.getMode()===designerBase.ICHART},update:function(e){try{m.setUp(),i.extend(this.state,e)}catch(t){m.debug&&console.log("AIC.update:   caught error "+t+" restore state to previous"),adhocDesigner.undo(),dialogs.systemConfirm.show("The previous request encountered an error '"+t+"' restoring chart to previous state")}return this},render:function(){var e=m.state.queryData.data.length>0;return n("#nothingToDisplayMessage").html(adhocDesigner.getMessage("ADH_1214_ICHARTS_NO_DATA")),adhocDesigner.setNothingToDisplayVisibility(!e),m.chart&&m.state.isRedrawRequired===!0&&(m.chart.destroy(),m.chart=void 0),m.ui.update(m.state),m.ui.render(),e=m.renderChart(e),m.isDesignerInitialized=!0,n("[action='chart-format']").removeClass("disabled"),e},renderChart:function(e){if(!m.firstRendering&&m.state.queryData.data.length)if(m.debug&&console.info(m.state),m.state.queryData.metadata.canRender===!1){var t,r=m.state.chartState.chartType;t=m._isTimeSeries()&&!l.isHeatMapTimeSeriesChart(r)?adhocDesigner.getMessage("ADH_1214_ICHARTS_NO_TIME_SERIES_DATA"):l.isDualOrMultiAxisChart(r)||l.isScatterChart(r)||l.isBubbleChart(r)?adhocDesigner.messages["ADH_1214_ICHARTS_NO_DATA_"+r.toUpperCase()]:l.isDualLevelPieChart(r)?adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_DUAL_LEVEL_PIE:l.isHeatMapChart(r)&&!adhocDesigner.isOlapMode()?adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_HEAT_MAP_NON_OLAP:l.isHeatMapChart(r)&&adhocDesigner.isOlapMode()?adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_HEAT_MAP_OLAP:l.isHeatMapTimeSeriesChart(r)?adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_TIME_SERIES_HEAT_MAP:l.isSpeedometerChart(r)?adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_SPEEDOMETER:l.isArcGaugeChart(r)?adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_GAUGE:"Unknown chart type group.",n("#nothingToDisplayMessage").html(t),adhocDesigner.setNothingToDisplayVisibility(!0),m.chart&&(m.chart.destroy(),m.chart=void 0)}else{var c=n(m.chartContainerSelector);m.ichWidth=c.width(),m.ichHeight=c.height();var d=s.generateOptions(m.state.queryData,m.state.chartState,{width:m.ichWidth,height:m.ichHeight,messages:adhocDesigner.messages});if(m._checkHasData(d)){if(e=!0,m.state.isRedrawRequired===!0||!m.chart){m._setAutoScaleFonts();try{m.chart=new a.Chart(d)}catch(h){u.error(h),t=/\#19/.test(h)?adhocDesigner.messages.ADH_1214_ICHARTS_ERROR_TOO_MANY_VALUES:adhocDesigner.messages.ADH_1214_ICHARTS_ERROR_UNCAUGHT,i.each(a.charts,function(e){e&&e.destroy()}),m.state.canSave=!1,adhocDesigner.enableRunAndSave(!1),n("#nothingToDisplayMessage").html(t),adhocDesigner.setNothingToDisplayVisibility(!0),m.chart&&(m.chart.destroy(),m.chart=void 0),e=!1}}}else e=!1,n("#nothingToDisplayMessage").html(adhocDesigner.getMessage("ADH_1214_ICHARTS_NO_CHART_DATA")),adhocDesigner.setNothingToDisplayVisibility(!e);m.isOLAP()&&(m.state.olapDimensionInfo=o.getOLAPDimensionInfo()),isDesignView&&m._renderDataLevelSelector()}return e},redraw:function(){var e=n(m.chartContainerSelector);if(m.ichWidth!=e.width()||m.ichHeight!=e.height()){var t=m.ichHeight==e.height();m.ichWidth=e.width(),m.ichHeight=e.height(),m._setAutoScaleFonts()?m.render():m.chart.setSize(m.ichWidth,m.ichHeight,t)}},_setAutoScaleFonts:function(){var e=n(m.chartContainerSelector);if(!m.state.chartState.autoScaleFonts)return"undefined"!=typeof m.autoScaleFontsSize&&e.css("font-size",m.autoScaleFontsSize),!1;"undefined"==typeof m.autoScaleFontsSize&&(m.autoScaleFontsSize=parseInt(e.css("font-size")));var t=1;return m.ichWidth<=100?t=.4:m.ichWidth>100&&m.ichWidth<=200?t=.5:m.ichWidth>200&&m.ichWidth<=300?t=.6:m.ichWidth>300&&m.ichWidth<=400?t=.7:m.ichWidth>400&&m.ichWidth<=500?t=.8:m.ichWidth>500&&m.ichWidth<=600&&(t=.9),parseInt(e.css("font-size"))!==Math.round(m.autoScaleFontsSize*t)?(e.css("font-size",m.autoScaleFontsSize*t),!0):!1},_isTimeSeries:function(){return-1!=m.state.chartState.chartType.indexOf("time_series")},_isTimeSeriesHeatMap:function(){return l.isHeatMapTimeSeriesChart(m.state.chartState.chartType)},cleanupOnSwitch:function(){m.ui.controls.chartTypeSelector.hide(),m.ui.dialogs.groupSelector.hide()},resize:function(){("pie"==m.state.chartState.chartType||l.isHeatMapTimeSeriesChart(m.state.chartState.chartType))&&m.render()},fixFirstRendering:function(){m.firstRendering&&(m.firstRendering=!1,m.renderChart())},initAll:function(){},_checkHasData:function(e){if(!e)return!1;if(!e.series)return!1;if(e.series.length<=0)return!1;for(var t=!1,r=0;r<e.series.length;r++)if(null!=e.series[r].data&&e.series[r].data.length>0){t=!0;break}return t},_isPivotAllowed:function(){var e=m;return e.getDimensions("row").length>0||e.isOLAP()&&e.getDimensions("column").length>0},_renderDataLevelSelector:function(){var e=m.ui.controls.dataLevelSelector;e.render(),m._isTimeSeries()&&e.hideRowsSlider()}}),i.extend(m,{serviceBus:{_listenersMap:{},_allEventsListeners:[],_incorrectEventTypeMsg:"Service bus supports only string events. Received event is not a string.",fireEvent:function(e){var t=m.serviceBus;if("string"!=typeof e)throw t._incorrectEventTypeMsg;var r=t._listenersMap,n=r[e];n&&i.each(n,function(t){t(e)}),i.each(t._allEventsListeners,function(t){t(e)})},registerListener:function(e,t){var r=m.serviceBus;if("string"!=typeof e)throw r._incorrectEventTypeMsg;var n=r._listenersMap,i=n[e];i||(i=[],n[e]=i),i.push(t)},registerAllEventsListener:function(e){m.serviceBus._allEventsListeners.push(e)}}}),i.extend(m,{mediator:{_isListenerRegistered:!1,eventToAction:{"chart:typeChanged":function(){m.state.chartState.chartType=m.ui.controls.chartTypeSelector.getType(),m.updateChartState()},"chart:levelChanged":function(){m.state.chartState.columnsSelectedLevels=m.ui.controls.dataLevelSelector.getColumnSelectedLevels(),m.state.chartState.rowsSelectedLevels=m.ui.controls.dataLevelSelector.getRowsSelectedLevels(),m.updateChartState()}},listener:function(e){if("string"!=typeof e)throw"Mediator supports only string events. Received event is not a string.";var t=m.mediator.eventToAction[e];t&&t()},register:function(){m.serviceBus._isListenerRegistered||(m.serviceBus.registerAllEventsListener(m.mediator.listener),m.serviceBus._isListenerRegistered=!0)}}}),i.extend(m,{ui:{controls:{dataLevelSelector:{_container:null,_column:null,_row:null,init:function(){var e=m.ui.controls.dataLevelSelector;e._container=n("#dataLevelSelector")},render:function(){if(l.isDualLevelPieChart(m.state.chartState.chartType))return void m.ui.controls.dataLevelSelector.hide();var e=m.ui.controls.dataLevelSelector;m.ui.selectorTables.column.show().find("td.select-header").parent().siblings().remove(),m.ui.selectorTables.row.show().find("td.select-header").parent().siblings().remove(),m.isOLAP()?e._renderOlapSlider():e._renderNonOlapSliders(),adhocDesigner.resetFilterPanelState()},_renderOlapSlider:function(){var e=m.ui.controls.dataLevelSelector;e._column=[],e._row=[],n.each(["row","column"],function(t,r){m.state.olapDimensionInfo[t].length?(n.each(m.state.olapDimensionInfo[t],function(t,n){var i=m.state.chartState[r+"sSelectedLevels"][t];e["_"+r].push(m.ui.create.slider(m.ui.selectorTables[r],n.levels,n.dimension,{max:n.levels.length-1,value:e._levelToLevelPosition(i,n),stop:function(){m.serviceBus.fireEvent("chart:levelChanged")}}))}),m.ui.selectorTables[r].show()):m.ui.selectorTables[r].hide()})},_renderNonOlapSliders:function(){var e=m.ui.controls.dataLevelSelector;e._row=e._renderNonOlapSlider(0),e._column=e._renderNonOlapSlider(1)},_renderNonOlapSlider:function(e){var t=m.ui.controls.dataLevelSelector,r=[];n.each(m.state.queryData.metadata.axes[e],function(e,t){"Measures"!=t.name&&r.push(t.label)});var i=0==e?m.ui.selectorTables.row:m.ui.selectorTables.column,a=0==e?o.getRowSliderLevelCount():o.getColumnSliderLevelCount(),s=0==e?m.state.chartState.rowsSelectedLevels:m.state.chartState.columnsSelectedLevels;return i.find("td.select-header").parent().siblings().remove(),1==a?i.hide():i.show(),m.ui.create.slider(i,r,"",{max:a-1,value:t._getSliderPositionForNonOlap(s,e),stop:function(){m.serviceBus.fireEvent("chart:levelChanged")}})},hide:function(){m.ui.selectorTables.column.hide(),m.ui.selectorTables.row.hide()},hideRowsSlider:function(){m.ui.selectorTables.row.hide()},hideColumnsSlider:function(){m.ui.selectorTables.column.hide()},_levelToLevelPosition:function(e,t){for(var r=0;r<t.levels.length;r++)if(t.levels[r].levelName===e.name)return r;throw"No OLAP level info found for specified level = "+e},getRowsSelectedLevels:function(){var e=m.ui.controls.dataLevelSelector;return e._getSelectedLevels(e._row,e._row,0)},getColumnSelectedLevels:function(){var e=m.ui.controls.dataLevelSelector;return e._getSelectedLevels(e._column,e._column,1)},_getSelectedLevels:function(e,t,r){var n=m.ui.controls.dataLevelSelector;return m.isOLAP()?n._extractOlapSelectedLevels(t,r):n._extractNonOlapSelectedLevels(e,r)},_extractOlapSelectedLevels:function(e,t){var r=m.ui.controls.dataLevelSelector,i=[];return n(e).each(function(e){var a=r._extractSliderPosition(n(this)),s=m.state.olapDimensionInfo[t][e],o=s.levels[a];i.push({name:o.levelName,label:o.label,dimension:s.dimension})}),i},_extractNonOlapSelectedLevels:function(e,t){var r=m.ui.controls.dataLevelSelector,n=r._extractSliderPosition(e);if(0===n)return[];var i=o.getLevelsWithoutMeasures(m.state.queryData.metadata.axes[t]);return[i[n-1]]},_getSliderPositionForNonOlap:function(e,t){if(0==e)return 0;var r=o.getLevelsWithoutMeasures(m.state.queryData.metadata.axes[t]);return o.getLevelIndex(r,e[0])+1},_extractSliderPosition:function(e){return e.slider("option","value")},dock:function(){var e=m.ui.controls.dataLevelSelector;e._container.find("div.pod-body").eq(0).appendTo(n("#level-container")),dialogs.popup.hide(e._container[0])},undock:function(){var e=m.ui.controls.dataLevelSelector;n("#level-container").children("div.pod-body").eq(0).appendTo(e._container.find("div.body").eq(0)),dialogs.popup.show(e._container[0])}},chartTypeSelector:{_type:null,_container:null,_DISABLED_CLASS:"disabled",_patternsDisabledForOlap:["[name$='_time_series']"],init:function(){var e=m.ui.controls.chartTypeSelector;if(e._container=n("#chartTypeSelector"),e._container.on("click","div.cell",e._typeSelectedHandler),m.isOLAP())for(var t=0;t<e._patternsDisabledForOlap.length;t++)n(e._patternsDisabledForOlap[t]).addClass(e._DISABLED_CLASS)},update:function(e){var t=m.ui.controls.chartTypeSelector;t._type=e},render:function(){var e=m.ui.controls.chartTypeSelector;e._container.find("div.cell").removeClass("selected"),e._container.find('div.cell[name="'+e._type+'"]').eq(0).addClass("selected")},hide:function(){var e=m.ui.controls.chartTypeSelector;dialogs.popup.hide(e._container[0])},_typeSelectedHandler:function(){var e=m.ui.controls.chartTypeSelector;n(this).hasClass(e._DISABLED_CLASS)||(e._type=this.getAttribute("name"),e.render(),m.serviceBus.fireEvent("chart:typeChanged"))},getType:function(){var e=m.ui.controls.chartTypeSelector;return e._type}}},update:function(e){m.ui.controls.chartTypeSelector.update(e.chartState.chartType)},render:function(){var e=n("#titleCaption");m.state.titleBarShowing?e.show():e.hide(),e.html(m.state.title),adhocDesigner.enableXtabPivot(m._isPivotAllowed()),m.ui.controls.chartTypeSelector.render(),m.ui.dialogs.formatDialog.model.set(m.state.chartState),m.ui.controls.dataLevelSelector.hide()},create:{sliderTable:function(e){var t=n("#level-container").show().children(".pod-body").eq(0),r=Mustache.to_html(n("#levelSelectorTemplate").html(),{id:(e?"row":"column")+"LevelSelector",colspan:m.isOLAP()?2:1,name:e?layoutManagerLabels.row[m.mode]:layoutManagerLabels.column[m.mode]}),i=n(r).appendTo(t);return i.on("mouseover","div.tickOverlay",function(){var e=n(this).parent();m.dataLevelTooltip.html(e.attr("level-name")),m.dataLevelTooltip.show().position({of:e,at:"center top",my:"center bottom",offset:"0 -6",collision:"fit"}),"block"==m.ui.selectorTables.column.css("display")&&m.ui.selectorTables.column.hide().show(),"block"==m.ui.selectorTables.row.css("display")&&m.ui.selectorTables.row.hide().show()}),i.on("mouseover","a.ui-slider-handle",function(){var e=n(this).parent(),t=e.children("div.sliderTick").eq(e.slider("option","value"));m.dataLevelTooltip.html(t.attr("level-name")),m.dataLevelTooltip.show().position({of:t,at:"center top",my:"center bottom",offset:"0 -6",collision:"fit"}),"block"==m.ui.selectorTables.column.css("display")&&m.ui.selectorTables.column.hide().show(),"block"==m.ui.selectorTables.row.css("display")&&m.ui.selectorTables.row.hide().show()}),i.on("mouseout","a.ui-slider-handle, div.tickOverlay",function(){m.dataLevelTooltip.hide(),"block"==m.ui.selectorTables.column.css("display")&&m.ui.selectorTables.column.hide().show(),"block"==m.ui.selectorTables.row.css("display")&&m.ui.selectorTables.row.hide().show()}),i},slider:function(e,t,r,i){var a={label:m.isOLAP()?{name:r}:!1,marginLeft:m.isOLAP()?"24px":0};e.find("tbody").eq(0).append(Mustache.to_html(n("#dataLevelSelectorTemplate").html(),a));var s=e.find("div.jrs-slider").last();s.slider({value:i.value,min:0,max:i.max,step:1,range:"min",stop:i.stop,slide:function(e,t){var r=n(t.handle).parent().children("div.sliderTick").eq(t.value);m.dataLevelTooltip.html(r.attr("level-name")),m.dataLevelTooltip.show().position({of:r,at:"center top",my:"center bottom",offset:"0 -6",collision:"fit"}),"block"==m.ui.selectorTables.column.css("display")&&m.ui.selectorTables.column.hide().show(),"block"==m.ui.selectorTables.row.css("display")&&m.ui.selectorTables.row.hide().show()}});var o=i.max>0?100/i.max:0;m.isOLAP()||(t.unshift("All"),i.max++);for(var l=0;l<i.max+1;l++)if(t[l]){var a={label:t[l].label||t[l],width:l*o};"All"==a.label&&(a.label="Total");var c=Mustache.to_html(n("#sliderTickTemplate").html(),a);s.append(c)}return s}}},init:function(){if(m.mediator.register(),m.dataLevelTooltip=n("#dataLevelTooltip"),n("#chartOptions").appendTo(adhocDesigner.ui.canvas).show(),n("#chartMenu").appendTo(adhocDesigner.ui.canvas),n(Mustache.to_html(n("#titleCaptionTemplate").html()),{}).appendTo(adhocDesigner.ui.canvas).show(),n("#chartContainer").appendTo(adhocDesigner.ui.canvas).show(),!m.initd&&(n("#chartOptions").on("mouseenter",function(){n(this).addClass("over"),n("#chartMenu").show().position({of:n("#chartOptions"),at:"left bottom",my:"left top",offset:"0 -1"})}),n("#chartMenu").on("mouseleave",function(){n("#chartOptions").removeClass("over"),n("#chartMenu").hide()}),n("#chartMenu").on("mouseenter","p.wrap",function(){n(this).addClass("over")}),n("#chartMenu").on("mouseleave","p.wrap",function(){n(this).removeClass("over")}),n("#chartMenu").on("click","li",function(){if(n(this).is('[action="chart-types"]'))dialogs.popup.show(m.ui.dialogs.typeSelector[0]),m.ui.controls.chartTypeSelector.render();else if(n(this).is('[action="chart-format"]')){if(n(this).hasClass("disabled"))return;m.ui.dialogs.formatDialog.model.set(m.state.chartState),dialogs.popup.show(m.ui.dialogs.formatDialog.el),adhocDesigner.initEnableBrowserSelection($("designer"))}}),n("#chartTypeSelector .closeIcon").on(isIPad()?"touchstart":"click",function(){m.ui.dialogs.typeSelector.hide()}),n("#dataLevelSelector .closeIcon").on(isIPad()?"touchstart":"click",function(){m.ui.dialogs.groupSelector.hide()}),m.ui.dialogs={typeSelector:n("#chartTypeSelector"),groupSelector:n("#dataLevelSelector")},m.ui.selectorTables={column:m.ui.create.sliderTable(!1),row:m.ui.create.sliderTable(!0)},m.ui.controls.chartTypeSelector.init(),m.ui.controls.dataLevelSelector.init(),!m.ui.dialogs.formatDialog)){var e=new c(m.state.chartState,{parse:!0,updateState:i.bind(m.updateChartState,m)});m.ui.dialogs.formatDialog=new d({model:e})}m.ui.dialogs.typeSelector.hide(),m.ui.dialogs.groupSelector.hide(),n("#level-container").show(),m.initd=!0},hide:function(){n("#chartOptions").appendTo("#highChartsRepo").hide(),n("#chartMenu").appendTo("#highChartsRepo").hide(),n("#titleCaption").remove(),n("#chartContainer").appendTo("#highChartsRepo").hide()}}),i.extend(m,{mouseUpHandler:function(){},mouseDownHandler:function(){},mouseOverHandler:function(){},mouseOutHandler:function(){},mouseClickHandler:function(){},treeMenuHandler:function(e){var t,r=e.memo.node;"dimensionsTree"===r.treeId?t=r.isParent()?adhocDesigner.DIMENSION_TREE_DIMENSION_CONTEXT:adhocDesigner.DIMENSION_TREE_LEVEL_CONTEXT:"measuresTree"===r.treeId&&(t=r.isParent()?adhocDesigner.MEASURE_TREE_GROUP_CONTEXT:adhocDesigner.MEASURE_TREE_CONTEXT),adhocDesigner.showDynamicMenu(e.memo.targetEvent,t,null)},lmHandlersMap:{addItems:function(e,t,r){var n=i.map(e,function(e){return e.extra.dimensionId});m.insertDimensionInAxisWithChild({dim:e[0].extra.isMeasure?n.slice(0,1):n,axis:r,pos:t,child:i.pluck(e,"id"),hierarchyName:e[0].extra.hierarchyName})},measureReorder:function(e,t){m.moveMeasure(e,t)},column:{addItem:function(e,t,r,n,i,a,s){m.insertDimensionInAxisWithChild({dim:e,axis:"column",pos:t,child:r,measure_pos:n,isMeasure:i,uri:a,hierarchyName:s})},removeItem:function(e,t){e.isMeasure?m.removeMeasure(t):m.hideColumnLevel(e.dimensionId,e.level)},moveItem:function(e,t,r){m.moveDimension(e,"column",r)},switchItem:function(e,t,r){m.moveDimension(e,"column",r)},contextMenu:function(e,t){m.selectFromDisplayManager(t.targetEvent,t.extra,designerBase.COLUMN_GROUP_MENU_LEVEL),actionModel.setSelected([t.extra]),m.showMenu(t.targetEvent,"displayManagerColumn")}},row:{addItem:function(e,t,r,n,i,a,s){m.insertDimensionInAxisWithChild({dim:e,axis:"row",pos:t,child:r,measure_pos:n,isMeasure:i,uri:a,hierarchyName:s})},removeItem:function(e,t){e.isMeasure?m.removeMeasure(t):m.hideRowLevel(e.dimensionId,e.level)},moveItem:function(e,t,r){m.moveDimension(e,"row",r)},switchItem:function(e,t,r){m.moveDimension(e,"row",r)},contextMenu:function(e,t){m.selectFromDisplayManager(t.targetEvent,t.extra,designerBase.ROW_GROUP_MENU_LEVEL),actionModel.setSelected([t.extra]),m.showMenu(t.targetEvent,"displayManagerRow")}}}}),i.extend(m,{insertDimensionInAxisWithChild:function(e){m.flush(),designerBase.sendRequest("ich_insertDimensionInAxisWithChild",e,adhocDesigner.render,{bPost:!0})},removeMeasure:function(e){designerBase.sendRequest("ich_removeMeasure",new Array("i="+e),adhocDesigner.render,null)},moveDimension:function(e,t,r){designerBase.sendRequest("ich_moveDimension",new Array("dim="+encodeText(e),"axis="+t,"pos="+r),adhocDesigner.render,null)},hideRowLevel:function(e,t){designerBase.sendRequest("ich_hideRowLevel",new Array("f="+encodeText(e),"level="+encodeText(t)),adhocDesigner.render,null)},hideColumnLevel:function(e,t){var r=function(r){adhocDesigner.render(r);var n=m.getLevelObject(t,e,"column");n&&n.propertyMap&&"true"==n.propertyMap.lastFilteredLevel&&dialogs.systemConfirm.show(adhocDesigner.getMessage("ADH_CROSSTAB_LAST_FILTERED_LEVEL"),5e3)};designerBase.sendRequest("ich_hideColumnLevel",new Array("f="+encodeText(e),"level="+encodeText(t)),r,null)},expandAllLevels:function(){m.debug&&console.log("AIC.expandAllLevels:  sending expandAll query, this may take some time"),m.cache=[],m.hasAllData=!0,designerBase.sendRequest("ich_expandAllLevels",null,adhocDesigner.render,null)},switchToColumnGroup:function(e){var t=adhocDesigner.getSelectedColumnOrGroup(),r=i.isNumber(e)?e:t.groupIndex;designerBase.sendRequest("ich_switchToColumnGroup",new Array("i="+r),adhocDesigner.render,null)},switchToRowGroup:function(e){var t=adhocDesigner.getSelectedColumnOrGroup(),r=i.isNumber(e)?e:t.groupIndex;designerBase.sendRequest("ich_switchToRowGroup",new Array("i="+r),adhocDesigner.render,null)},moveRowGroup:function(e,t,r){var n=function(e){adhocDesigner.render(e),r&&r()};designerBase.sendRequest("ich_moveRowGroup",new Array("f="+e,"t="+t),n,null)},moveColumnGroup:function(e,t,r){var n=function(e){adhocDesigner.render(e),r&&r()};designerBase.sendRequest("ich_moveColumnGroup",new Array("f="+e,"t="+t),n,null)},moveMeasure:function(e,t){designerBase.sendRequest("ich_moveMeasureByName",["measure="+e,"to="+t],adhocDesigner.render,null)},updateChartState:function(e){n.extend(m.state.chartState,e);var t=function(e){if(!e)throw"No response received on save chart state request";adhocDesigner.render(e)};designerBase.sendRequest("ich_updateChartState",["chartState="+encodeURI(Object.toJSON(m.state.chartState))],t,null)},setCategoryForRowGroup:function(e,t){var r=function(e){adhocDesigner.render(e)};designerBase.sendRequest("ich_setRowGroupCategorizer",new Array("cat="+encodeText(e),"i="+t),r,null)},setCategoryForColumnGroup:function(e,t){var r=function(e){adhocDesigner.render(e)};designerBase.sendRequest("ich_setColumnGroupCategorizer",new Array("cat="+encodeText(e),"i="+t),r,null)},setSummaryFunction:function(e,t){designerBase.sendRequest("ich_setSummaryFunction",new Array("f="+e,"i="+t),m.standardIChartOpCallback,null)},setSummaryFunctionAndMask:function(e,t,r){designerBase.sendRequest("cr_setSummaryFunctionAndDataMask",new Array("f="+e,"m="+encodeText(t),"i="+r),m.standardIChartOpCallback,null)},setHideEmptyRows:function(){designerBase.sendRequest("ich_setProperty",new Array("name=hideEmptyRows","value=true"),m.standardIChartOpCallback,null)},setUnhideEmptyRows:function(){designerBase.sendRequest("ich_setProperty",new Array("name=hideEmptyRows","value=false"),m.standardIChartOpCallback,null)},updateViewCallback:function(e){localContext.standardIChartOpCallback(e)}}),i.extend(m,{canSaveReport:function(){return m.state.canSave},hideEmptyRowsEquals:function(e){return m.state.crosstabState.hideEmptyRows===e},canAddFilter:function(e,t){var r=localContext.isOlapMode()&&(isNotNullORUndefined(e.isMeasure)?e.isMeasure:e.param.extra&&e.param.extra.isMeasure),n=isNotNullORUndefined(e.param)?e.param.extra&&e.param.extra.id==localContext.ALL_LEVEL_NAME:e.level==localContext.ALL_LEVEL_NAME,i=localContext.isOlapMode()&&localContext._isAddingFilterDuplicate(e);return r?(t&&t.push(addFilterErrorMessageMeasureAdd),!1):n?(t&&t.push(addFilterErrorMessageAllLevelAdd),!1):e.isParent&&e.isParent()?(t&&t.push(addFilterErrorMessageGroupAdd),!1):adhocDesigner.isSpacerSelected(e)?(t&&t.push(addFilterErrorMessageSpacerAdd),!1):adhocDesigner.isPercentOfParentCalcSelected(e)?(t&&t.push(addFilterErrorMessagePercentOfParentCalcFieldAdd),!1):adhocDesigner.isConstantSelected(e)?(t&&t.push(addFilterErrorMessageConstantAdd),!1):i?(t&&t.push(addFilterErrorMessage),!1):!0},canAddSliceFilter:function(){var e=selObjects.find(function(e){return!e.isSliceable});return selObjects.first()&&!e},_isAddingFilterDuplicate:function(e){var t;return t=e.param?"["+e.param.extra.dimensionId+"].["+e.param.extra.id+"]":"["+e.dimensionId+"].["+e.level+"]",adhocDesigner.filtersController.hasFilterForField(t)},isDateType:function(){return m.isDateTimeType("date")},isTimestampType:function(){return m.isDateTimeType("timestamp")},isTimeType:function(){return m.isDateTimeType("time")},isDateTimeType:function(e){var t=adhocDesigner.getSelectedColumnOrGroup();if(t){var r=m.isGroupSelected(t),n=AdHocCrosstab.getSelectedGroup(t);if(n){var i=n.canReBucket===!0,a=n.type===e;return r&&i&&a}}return!1},isGroupSelected:function(e){return!e.isMeasure},isCurrentDateType:function(e){var t=AdHocCrosstab.getSelectedGroup(adhocDesigner.getSelectedColumnOrGroup());return t?t.categorizerName==e:!1},canMoveUpOrLeft:function(){var e=adhocDesigner.getSelectedColumnOrGroup(),t=m.getSelectedDimensionIndex(e);return t>0},canMoveDownOrRight:function(){var e=adhocDesigner.getSelectedColumnOrGroup(),t=m.getSelectedDimensionIndex(e);return t<m.getDimensions(e.axis).length-1},canAddSiblingLevels:function(){return!0},canSwitchToRow:function(){var e=adhocDesigner.getSelectedColumnOrGroup();return!m.isOLAP()||m.getDimensions(e.axis).length>1},canAddDimensionAsRowGroup:function(){var e=selObjects.first();if(e.hasChilds()||(e=e.parent),m.isOLAP()){if(0===m.getDimensions("column").length)return!1;var t=e.param.id,r=e.param.extra.isHierarchy&&e.param.extra.id,n=m.getLevelsFromDimension(t,"column"),a=m.getLevelsFromDimension(t,"row"),s=a.length>0&&a[0].indexOf("["+r+"]")>-1;return 0===n.length&&(e.param.extra.isHierarchy&&!s||a.length<e.getChildCount())}var o=dynamicTree.trees[e.getTreeId()],l=adhocDesigner.getAllLeaves(e,o),c=adhocDesigner.getAllLeaves(e,o).collect(function(e){return e.param.extra.id});if(l[0].param.extra.isMeasure){var d=m.getFilteredMeasureList("column");return 0===d.length}var u=i.pluck(m.getFilteredList(),"name");return i.difference(c,u).length>0},canAddDimensionAsColumnGroup:function(){var e=selObjects.first();if(e.hasChilds()||(e=e.parent),m.isOLAP()){var t=e.param.id,r=e.param.extra.isHierarchy&&e.param.extra.id,n=m.getLevelsFromDimension(t,"column"),a=m.getLevelsFromDimension(t,"row"),s=n.length>0&&n[0].indexOf("["+r+"]")>-1;return 0===a.length&&(e.param.extra.isHierarchy&&!s||n.length<e.getChildCount())}var o=dynamicTree.trees[e.getTreeId()],l=adhocDesigner.getAllLeaves(e,o),c=adhocDesigner.getAllLeaves(e,o).collect(function(e){return e.param.extra.id});if(l[0].param.extra.isMeasure){var d=m.getFilteredMeasureList("row");return 0===d.length}var u=i.pluck(m.getFilteredList(),"name");return i.difference(c,u).length>0},canAddLevelAsColumnGroup:function(){var e=selObjects.first(),t=m.isOLAP()?[e.param.extra.dimensionId]:adhocDesigner.getAllLeaves(e).map(function(e){return e.param.extra.dimensionId}),r=t.inject([],function(e,t){return e.concat(m.getLevelsFromDimension(t,"column")||[])}),n=t.inject([],function(e,t){return e.concat(m.getLevelsFromDimension(t,"row")||[])});return 0===n.length&&(0===r.length||!m.isOLAP()&&e.param.extra.isMeasure||!r.find(function(e){return i.contains(i.map(designerBase.getSelectedObjects(),function(e){return e.param.extra.id}),e)}))},canAddLevelAsRowGroup:function(){if(0===m.getDimensions("column").length&&m.isOLAP())return!1;var e=selObjects.first(),t=m.isOLAP()?[e.param.extra.dimensionId]:adhocDesigner.getAllLeaves(e).map(function(e){return e.param.extra.dimensionId}),r=t.inject([],function(e,t){return e.concat(m.getLevelsFromDimension(t,"column")||[])}),n=t.inject([],function(e,t){return e.concat(m.getLevelsFromDimension(t,"row")||[])});return 0===r.length&&(0===n.length||!m.isOLAP()&&e.param.extra.isMeasure||!n.find(function(t){return e.param.extra.id===t}))},isRowGroupSelected:function(e){return"row"===e.axis&&!e.isMeasure},isColumnGroupSelected:function(e){return"column"===e.axis&&!e.isMeasure},showAddHierarchyConfirm:function(e,t,r){return m.fromSiblingHierarchy(e,t)?(adhocDesigner.addConfirmDialog.show({ok:function(){return m.isFiltersApplied(t)?void dialogs.systemConfirm.show(adhocDesigner.getMessage("ADH_CROSSTAB_LAST_FILTERED_LEVEL"),5e3):void r()}}),!0):!1},isFiltersApplied:function(e,t){var r=i.pluck(m.getLevelObjectsFromDimension(e,t),"levelUniqueName"),n=i.pluck(m.state.existingFilters,"name");return!i.isEmpty(i.intersection(r,n))}}),i.extend(m,{removeLevelFromColumn:function(){var e=selObjects.first();n("#"+adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:removeItem",{axis:"column",index:e.index,item:{level:e.level,dimensionId:e.dimensionId,isMeasure:e.isMeasure}})},removeLevelFromRow:function(){var e=selObjects.first();n("#"+adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:removeItem",{axis:"row",index:e.index,item:{level:e.level,dimensionId:e.dimensionId,isMeasure:e.isMeasure}})},moveRowGroupLeft:function(e){var t=adhocDesigner.getSelectedColumnOrGroup(),r=m.getSelectedDimensionIndex(t),n=r-1;m.moveRowGroup(r,n,e)},moveRowGroupRight:function(e){var t=adhocDesigner.getSelectedColumnOrGroup(),r=m.getSelectedDimensionIndex(t),n=r+1;m.moveRowGroup(r,n,e)},moveColumnGroupLeft:function(e){var t=adhocDesigner.getSelectedColumnOrGroup(),r=m.getSelectedDimensionIndex(t),n=r-1;m.moveColumnGroup(r,n,e)},moveColumnGroupRight:function(e){var t=adhocDesigner.getSelectedColumnOrGroup(),r=m.getSelectedDimensionIndex(t),n=r+1;m.moveColumnGroup(r,n,e)},appendDimensionWithLevel:function(e,t){var r=e?m.getAvailableFieldsNodeBySelection(e.id,e.groupId):m.getAvailableFieldsNodeBySelection();r.axis=t,m.showAddHierarchyConfirm(r.hierarchyName,r.dimensionId,function(){n("#"+adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:addItem",r)})||n("#"+adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:addItem",r)},appendDimensionToRowAxisWithLevel:function(e){m.appendDimensionWithLevel(e,"row")},appendDimensionToColumnAxisWithLevel:function(e){m.appendDimensionWithLevel(e,"column")},appendMeasureToRow:function(e){var t=e?m.getAvailableFieldsNodesBySelection(e):m.getAvailableFieldsNodesBySelection();n("#"+adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:addItems",{axis:"row",levels:t,index:t[0].index})},appendMeasureToColumn:function(e){var t=e?m.getAvailableFieldsNodesBySelection(e):m.getAvailableFieldsNodesBySelection();n("#"+adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:addItems",{axis:"column",levels:t,index:t[0].index})},showMenu:function(e,t){var r,n=null;switch(t){case"displayManagerRow":r="displayManagerRow",n=m.generateAvailableSummaryCalculationsMenu;break;case"displayManagerColumn":r="displayManagerColumn",n=m.generateAvailableSummaryCalculationsMenu;break;case"groupMember":r=designerBase.MEMBER_GROUP_MENU_LEVEL,n=m.updateContextMenuWithSiblingLevels;break;case"measuresDimensionRow":r="measuresDimensionInRows";break;case"measuresDimensionColumn":r="measuresDimensionInColumns";break;case"rowGroup":r=designerBase.ROW_GROUP_MENU_LEVEL;break;case"columnGroup":r=designerBase.COLUMN_GROUP_MENU_LEVEL;break;case"measureRow":r="measureRow";break;case"measureColumn":r="measureColumn"}adhocDesigner.showDynamicMenu(e,r,null,n)},generateAvailableSummaryCalculationsMenu:function(e,t){if(!actionModel.selObjects[0].isMeasure)return t;var r=i.find(t,function(e){return"AdHocCrosstab.selectedMeasureShowsSummaryOptions"===e.clientTest});if(r){var n=actionModel.selObjects[0],a=i.findWhere(m.state.measures,{name:n.name});a&&adhocDesigner.generateAvailableSummaryCalculationsMenu(a.fieldName,r,{action:h.selectFunction,isSelectedTest:AdHocCrosstab.isSelectedSummaryFunction})}return t},setCatForColumnGroup:function(e){var t=adhocDesigner.getSelectedColumnOrGroup();t&&m.isColumnGroupSelected(t)&&m.setCategoryForColumnGroup(e,t.groupIndex)},setCatForRowGroup:function(e){var t=adhocDesigner.getSelectedColumnOrGroup();t&&m.isRowGroupSelected(t)&&m.setCategoryForRowGroup(e,t.groupIndex)},selectFunction:function(e){var t=AdHocCrosstab.getSelectedMeasure();if(t){var r=selObjects.first().index,n=adhocDesigner.getSuperType(t.type),i=AdHocCrosstab.getMeasureTypeByFunction(e);n!==i?m.setSummaryFunctionAndMask(e,defaultMasks[i],r):m.setSummaryFunction(e,r)}}}),i.extend(m,{getDimensions:function(e){var t=m.state.crosstabState;return e?t[e+"Groups"]:i.chain(t).filter(function(e,t){return t.search(/Groups$/)>=0}).flatten().value()},getLevelsFromDimension:function(e,t){return i.pluck(this.getLevelObjectsFromDimension(e,t),"name")
},getLevelObjectsFromDimension:function(e,t){var r=this.getDimensions(t);return e=i.find(r,function(t){return t.name===e}),e?i.chain(e.levels).filter(function(e){return e.visible}).map(function(e){return i.isEmpty(e.members)?e:e.members}).flatten().filter(function(e){return!e.isSpacer}).value():[]},getLevelObject:function(e,t,r){function n(e,t){return i.find(e,function(e){return e.name==t})}var a=this.getDimensions(r),s=n(a,t);return s?n(s.levels,e):null},getFilteredList:function(e,t){var r=e||null,n=t||{};return 1===arguments.length&&i.isObject(e)&&(n=e,r=null),n.visible=!0,i.chain(m.getDimensions(r)).pluck("levels").flatten().map(function(e){return i.isEmpty(e.members)?e:e.members}).flatten().filter(function(e){return i.all(n,function(t,r){return void 0===e[r]||e[r]===t})}).value()},getFilteredMeasureList:function(e,t){var r=e||null,n=t||{};return 1===arguments.length&&i.isObject(e)&&(n=e,r=null),m.getFilteredList(r,i.extend(n,{measure:!0,measuresLevel:!0}))},fromSiblingHierarchy:function(e,t,r){if(!e)return!1;var n=this.getLevelsFromDimension(t,r);return n.length>0&&-1===n[0].indexOf("["+e+"]")},getHierarchy:function(e){var t=e.param.extra;return e.hasChilds()?(e.getFirstChild().hasChilds()&&(t=e.getFirstChild().param.extra),t&&t.isHierarchy?t.id:void 0):t.hierarchyName},getAvailableFieldsNodeBySelection:function(e,t,r){var n={};if(r||(r=selObjects.first()),selectionCategory.area==designerBase.AVAILABLE_FIELDS_AREA)r.hasChilds()?(n.isMeasure="measuresTree"===r.treeId,n.dimensionId=n.isMeasure?r.treeId:r.param.id,n.uri=localContext.isNonOlapMode()?r.param.uri:void 0,n.level=null):(n.isMeasure=!!r.param.extra.isMeasure,n.level=r.param.extra.dimensionId&&r.param.id,n.dimensionId=r.param.extra.dimensionId||r.param.extra.id),n.hierarchyName=this.getHierarchy(r),n.index=-1;else if(selectionCategory.area==designerBase.ROW_GROUP_MENU_LEVEL||selectionCategory.area==designerBase.COLUMN_GROUP_MENU_LEVEL)if(e||t){var i=/.*\[(.*)\]/.exec(e),a=i&&i[1];n.isMeasure=!t,n.level=e,n.dimensionId=n.isMeasure?adhocDesigner.MEASURES:t,n.index=-1,n.hierarchyName=a}else{if(!r.axis)return void alert("Need a way to get dimension name for clicked level from crosstab");n=r}return n},getAvailableFieldsNodesBySelection:function(e,t){for(var r=[],n=0;n<selObjects.length;n++)r.push(m.getAvailableFieldsNodeBySelection(e,t,selObjects[n])),r[n].extra=r[n],r[n].dimensionId=r[n].dimensionId,r[n].id=r[n].level;return r},updateContextMenuWithSiblingLevels:function(e,t){if(!adhocDesigner.ui.display_manager)return t;var r=t.find(function(e){return"AdHocCrosstab.canAddSiblingLevels"===e.clientTest});if(!r)return t;var n=null,a=null,s=null,o=selObjects[0],l=/.*\[(.*)\]/.exec(o.level),c=l&&l[1];if(selObjects.first().isMeasure)a=adhocDesigner.measuresTree.getRootNode(),s="row"===selObjects.first().axis?"AdHocCrosstab.appendMeasureToRow":"AdHocCrosstab.appendMeasureToColumn";else{if(!m.isOLAP())return selObjects.first().index=0,t;a=adhocDesigner.dimensionsTree.getRootNode().childs.find(function(e){return e.param.extra.id===selObjects.first().dimensionId}),a.childs[0].param.extra.isHierarchy&&(a=i.find(a.childs,function(e){return e.param.extra.id===c})),s="row"===selObjects.first().axis?"AdHocCrosstab.appendDimensionToRowAxisWithLevel":"AdHocCrosstab.appendDimensionToColumnAxisWithLevel"}if(void 0===selObjects.first().allLevels){var d=selObjects.first();d.allLevels=AdHocCrosstab.state.getLevelsFromDimension(selObjects.first().dimensionId,d.axis),d.index=d.allLevels.indexOf(d.level)}return selObjects.first().allLevels&&(n=m.isOLAP()?a.childs.findAll(function(e){return!selObjects.first().allLevels.include(e.param.extra.id)}):adhocDesigner.getAllLeaves(a,adhocDesigner.measuresTree).findAll(function(e){return!selObjects.first().allLevels.include(e.param.extra.id)})),n&&0!=n.length?(r.text=adhocDesigner.getMessage(selObjects.first().isMeasure?"addMeasures":"addLevels"),r.children=n.collect(function(e){return actionModel.createMenuElement("optionAction",{text:e.name,action:s,actionArgs:selObjects.first().isMeasure?[e.param.extra.id]:[{id:e.param.extra.id,groupId:e.param.extra.dimensionId,isMeasure:!1}]})}),t):t},getSelectedDimensionIndex:function(e){if(e){var t=e.isMeasure?adhocDesigner.MEASURES:e.dimensionId,r=-1;i.find(m.getDimensions(e.axis),function(e,n){return e.name===t?(r=n,!0):void 0})}return r}}),i.extend(m,{selectFromDisplayManager:function(e,t,r){designerBase.unSelectAll();var n=adhocDesigner.isMultiSelect(e,r);selectionCategory.area=r;var i=adhocDesigner.isAlreadySelected(t);adhocDesigner.addSelectedObject(e,t,n,i),Event.stop(e)},deselectAllSelectedOverlays:function(){}}),i.extend(m,{standardOpCallback:function(e){e?localContext.standardIChartOpCallback(e):window.console&&console.log("Internal server error occurred")},standardIChartOpCallback:function(e){adhocDesigner.render(e)}}),n(window).on("resizeEnd",function(){(localContext.getMode()==designerBase.ICHART||localContext.getMode()==designerBase.OLAP_ICHART)&&localContext.resize()}),n("#designer").bind({"rendering:done":function(){(localContext.getMode()==designerBase.ICHART||localContext.getMode()==designerBase.OLAP_ICHART)&&m.fixFirstRendering()}}),window.AdhocIntelligentChart=h,window.AIC=h,h});