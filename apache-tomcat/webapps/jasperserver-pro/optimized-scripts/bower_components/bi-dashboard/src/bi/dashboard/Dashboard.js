define(["require","exports","module","underscore","jquery","json3","logger","common/bi/component/util/biComponentUtil","common/bi/error/biComponentErrorFactory","common/bi/component/BiComponent","./model/DashboardBiComponentStateModel","dashboard/collection/filterManager/WiringProducerViewModelCollection","dashboard/dashboardSettings","dashboard/view/base/CanvasView","common/enum/httpStatusCodes","dashboard/enum/dashboardComponentTypes","dashboard/model/DashboardModel","dashboard/factory/sandboxFactory","text!./schema/Dashboard.json"],function(e,r,o){function t(e,r){var o=u(r).first();if(!o.length||"1"!=o[0].nodeType){var t=v.containerNotFoundError(r);return h.error(t.toString()),e.reject(t),!1}return o}function n(e,r,o,n){var a=t(e,r.properties.container);if(a){var i=o.$el;!a.height()&&i.height(C.DASHBOARD_CONTAINER_HEIGHT),a.html(i),n&&e.resolve(n)}}function a(e,r,o,a,i){var s,d=this.validate(),c=this;if(d)return s=v.validationError(d),h.error(s.toString()),void e.reject(s);if(i.get("_fetched")){var m=i.changedAttributes();if(m&&"params"in m){var b=r.data.parameters,g={};l.each(b,function(e){g[e.id]=e.id in r.properties.params?r.properties.params[e.id]:g[e.id]=void 0});for(var D in g){var A=o.currentFoundation.components.get(D);A&&A.set("value",g[D])}o.currentFoundation.components.getDashboardPropertiesComponent().applyParameters()}if(m&&"container"in m&&n(e,r,a),m&&"linkOptions"in m){var E=o.cid,O=a.componentViews.filter(function(e){return e.model.isVisualization()&&e.model.get("type")!==w.WEB_PAGE_VIEW});p(r.properties.linkOptions,E);var F=l.map(O,function(e){return e.component.run()});return u.when.apply(this,F||[]).done(l.partial(e.resolve,c.data())),e}return e.resolve(c.data())}(!r.properties.container||t(e,r.properties.container))&&(C.CONTEXT_PATH=r.properties.server,o.set("uri",r.properties.resource),o.contextPath=r.properties.server,f.createReadOnlyProperty(this,"server",r,!0,i),f.createReadOnlyProperty(this,"resource",r,!0,i),o.once("resourcesDataFetched",function(){var e=l.findWhere(o.get("foundations"),{id:o.get("defaultFoundation")}),t=o.resources.get(e.components).resource.content;for(var n in r.properties.params)if(r.properties.params.hasOwnProperty(n)){var a=l.findWhere(t,{id:n});a&&(a.value=r.properties.params[n])}}),o.fetch().done(function(){i.set("_fetched",!0),a.componentViews.length&&u.when.apply(u,l.pluck(a.componentViews,"ready")).then(function(){a.ready.resolve()}),a.enableAutoRefresh();var t=y.createFromDashboardWiringCollection(o.currentFoundation.wiring,o.currentFoundation.components);r.data.parameters=t.map(function(e){return{id:e.component.get("id")}}),r.properties.linkOptions&&p(r.properties.linkOptions,o.cid),r.properties.container?n(e,r,a,c.data()):e.resolve(c.data())}).fail(function(r){s=v.requestError(r),h.error(s.toString()),e.reject(s)}))}function i(e,r,o){n(e,r,o,o.$el[0])}function s(e,r,o,t){o.remove(),E.get(r).set("linkOptions",null),t.set("_destroyed",!0),C.VISUALIZE_MODE=!1,e.resolve()}function d(e,r,o,t,n){var i=n.get("_fetched")?t.refresh():a.call(this,e,r,o,t,n);i.done(e.resolve).fail(e.reject)}function c(e,r,o){o.get("_fetched")?r.cancel().done(e.resolve).fail(e.reject):e.resolve()}function p(e,r){e&&E.get(r).set("linkOptions",e)}var l=e("underscore"),u=e("jquery"),m=e("json3"),h=e("logger").register(o),f=e("common/bi/component/util/biComponentUtil"),v=e("common/bi/error/biComponentErrorFactory"),b=e("common/bi/component/BiComponent"),g=e("./model/DashboardBiComponentStateModel"),y=e("dashboard/collection/filterManager/WiringProducerViewModelCollection"),C=e("dashboard/dashboardSettings"),D=e("dashboard/view/base/CanvasView"),w=(e("common/enum/httpStatusCodes"),e("dashboard/enum/dashboardComponentTypes")),A=e("dashboard/model/DashboardModel"),E=e("dashboard/factory/sandboxFactory"),O=m.parse(e("text!./schema/Dashboard.json")),F=l.keys(O.properties),S=["properties"],V=["data"],_=function(e){e||(e={}),C.VISUALIZE_MODE=!0;var r={properties:l.cloneDeep(e),data:{parameters:[]}},o=new g(l.cloneDeep(e)),t=new A,n=t.cid,p=new D({model:t,dashboardId:n});f.createInstancePropertiesAndFields(this,r,F,S,V,o),l.extend(this,{validate:f.createValidateAction(r,O,o),run:f.createDeferredAction(a,o,r,t,p,o),render:f.createDeferredAction(i,o,r,p),refresh:f.createDeferredAction(d,o,r,t,p,o),cancel:f.createDeferredAction(c,o,p,o),destroy:f.createDeferredAction(s,o,n,p,o)})};return _.prototype=new b,_});