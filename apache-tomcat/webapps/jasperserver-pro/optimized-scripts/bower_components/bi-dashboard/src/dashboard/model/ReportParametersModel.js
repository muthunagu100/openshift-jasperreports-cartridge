define(["require","backbone","../dashboardSettings","jquery","json3","underscore"],function(t){function e(t,e){var r;return t?(r=t,r.push.apply(r,i.filter(e,function(e){return!i.findWhere(t,{id:e.id})}))):r=e,r}var r=t("backbone"),s=t("../dashboardSettings"),n=t("jquery"),a=t("json3"),i=t("underscore");return r.Model.extend({idAttribute:"reportUri",defaults:{all:!1},initialize:function(t,e){var r=this;this.stateDfds={},e&&(e.knownIds&&i.each(e.knownIds,function(t){r.stateDfds[t]=new n.Deferred}),e.full?(this.allParamsDfd=new n.Deferred,this.fetch({full:!0}).fail(i.bind(this.allParamsDfd.reject,this.allParamsDfd))):e.knownIds&&e.knownIds.length&&this.fetch({preload:e.knownIds}).fail(function(){var t=arguments;i.each(e.knownIds,function(e){r.stateDfds[e].reject.apply(r.stateDfds[e],t)})})),this.on("change:all",function(){r.allParamsDfd.resolve(r.get("inputControl"))})},url:function(){return s.CONTEXT_PATH+"/rest_v2/reports"+this.get("reportUri")+"/inputControls"},parse:function(t){var r=this;if(t&&t.inputControl){var s=!0;i.each(t.inputControl,function(t){"repo:"===t.uri.substr(0,5)&&(t.uri=t.uri.substr(5)),t.state&&(r.stateDfds[t.id]||(r.stateDfds[t.id]=new n.Deferred),r.stateDfds[t.id].resolve(t),s=!1)}),t.all=s||this.get("full")||this.get("all"),t.inputControl=e(this.get("inputControl"),t.inputControl)}else t={inputControl:[],all:!0};return t},sync:function(t,e,s){return"read"==t&&(s.url=this.url(),s.full?e.set("full",!0,{silent:!0}):s.url+=s.preload?"/"+s.preload.join(";"):"?exclude=state",s.data&&(i.isObject(s.data)&&(s.data=a.stringify(s.data)),s.type="POST",s.processData=!1,s.headers={"Content-Type":"application/json"})),r.Model.prototype.sync.call(this,t,e,s)},getReportParameters:function(t){return(!this.allParamsDfd||t&&t.force)&&(this.allParamsDfd=new n.Deferred,this.stateDfds={},this.unset("inputControl",{silent:!0}),this.set("all",!1,{silent:!0}),this.fetch().fail(i.bind(this.allParamsDfd.reject,this.allParamsDfd))),this.allParamsDfd.promise()},getInputControlAsParameter:function(t,e){var r=this.stateDfds[t];return(!r||e&&e.force)&&(r=this.stateDfds[t]=new n.Deferred,this.fetch({preload:[t],data:e&&e.params,full:e&&e.full}).fail(i.bind(this.stateDfds[t].reject,this.stateDfds[t]))),r.promise()}})});