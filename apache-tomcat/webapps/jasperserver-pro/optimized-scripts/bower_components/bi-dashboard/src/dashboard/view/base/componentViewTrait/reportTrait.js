define(["require","exports","module","underscore","jquery","json3","backbone","bundle!DashboardBundle","logger","bi/report/Report","common/component/pagination/Pagination","dashboard/enum/dashboardWiringStandardIds","../../../dashboardSettings","./dashletTrait","bi/report/enum/scaleStrategies","common/extension/rivetsExtension","dashboard/hyperlink/linkOptions","dashboard/factory/sandboxFactory"],function(e,n,t){function o(e,n,t,o,i){var r;if(e===b.WIDTH)r=o/n;else if(e===b.HEIGHT)r=i/t;else{var a=o/n,s=i/t;r=i>a*t?a:s}return r}function i(e){var n=this;this.component&&this.component["export"]({outputFormat:"html",pages:2}).done(function(){var t=n.component.data().totalPages;n.paginationView||0===t?t>1&&n._refreshPagination(t,e):(n._initPagination({total:t,silent:!0,validate:!1}),n.paginationView.$el.find(".next, .prev, .first").prop("disabled",!1))}).fail(function(e){u.debug(e)})}function r(e){return e.$("> .dashletContent > .content > ._jr_report_container_ > .highcharts_parent_container").length>0}function a(e){e.name===f.REFRESH_SLOT?(this.paramsModel.paramsChanged&&(this.paramsModel.paramsChanged=!1,this.component.params(h.clone(this.paramsModel.attributes))),this.refresh()):e.name===f.APPLY_SLOT?this.paramsModel.paramsChanged&&(this.paramsModel.paramsChanged=!1,this.component.params(h.clone(this.paramsModel.attributes)),this.paginationView&&this.paginationView.model.set("current",this.paginationView.model.defaults.current),this.refresh()):h.isUndefined(e.value)?this.paramsModel.unset(e.name):this.paramsModel.set(e.name,e.value)}function s(e){var n;try{n=l.parse(e.responseText)}catch(t){n={message:"Can't parse server response",errorCode:"unexpected.error",parameters:[]}}return n}var h=e("underscore"),d=e("jquery"),l=e("json3"),c=e("backbone"),p=e("bundle!DashboardBundle"),u=e("logger").register(t),m=e("bi/report/Report"),g=e("common/component/pagination/Pagination"),f=e("dashboard/enum/dashboardWiringStandardIds"),v=e("../../../dashboardSettings"),b=(e("./dashletTrait"),e("bi/report/enum/scaleStrategies")),w=e("common/extension/rivetsExtension"),_=e("dashboard/hyperlink/linkOptions"),C=e("dashboard/factory/sandboxFactory");w.formatters.scaleStrategy={publish:function(e){var n=Number(e);return isNaN(n)?e:n}};var R=function(){var e={};return e["input.controls.validation.error"]=function(e){return[p["dashboard.dashlet.error."+e.errorCode]].concat(e.parameters).join("<br/>")},function(n){var t=e[n.errorCode];return t?t(n):p["dashboard.dashlet.error."+n.errorCode]||p["dashboard.dashlet.error.unexpected.error"]}}();return{_onViewInitialize:function(){var e=this;this.paramsModel=new c.Model,this.paramsModel.on("change",function(){this.paramsChanged=!0}),this.listenTo(this.model,"signal",h.bind(a,this)),this.model.lastPayload&&a.call(this,this.model.lastPayload,this.model.lastSender),this.model.paramsDfd.fail(function(n){e.showMessage(s(n))})},_onChangeLinkOptions:function(){var e=this.dashboardId?C.get(this.dashboardId).get("linkOptions"):{};this.component&&this.component.linkOptions(_(this.component,e))},_initComponent:function(){var e=this;h.bindAll(this,"_onChangeLinkOptions"),this.dashboardId&&C.get(this.dashboardId).on("linkOptions",this._onChangeLinkOptions),this.model.getReportResourceUri().done(function(n){e.component=new m({resource:n,container:e.$content,server:v.CONTEXT_PATH,scale:e.model.get("scaleToFit"),events:{changeTotalPages:function(n){n>1?e.paginationView?e._refreshPagination(n):e._initPagination({total:n}):e.paginationView&&e.paginationView.hide()}}}),e._onChangeLinkOptions()})},_removeComponent:function(e){var n=e?e.sessionExpired:!1;!n&&this.isReportRan&&this.component.destroy(),this.component=null,this.isReportRan=!1,this.dashboardId&&C.get(this.dashboardId).off("linkOptions",this._onChangeLinkOptions),this._removePagination()},_renderComponent:function(){this.isReportRan&&(this.component.render(h.bind(this.trigger,this,"componentRendered",this)),!r(this)&&this._resetContentOverflow(this._calculateContentOverflow()))},_resizeComponent:function(){this.component&&this._renderComponent()},refresh:function(){var e=this,n=new d.Deferred,t=this.cancel();return t.always(function(){e.isReportRan?e.ready.done(function(){e.isReportRunning=!0,e.component.refresh().fail(n.reject).done(function(){i.call(e,{resetCurrent:!0}),!r(e)&&e._resetContentOverflow(e._calculateContentOverflow(e)),n.resolve(),!e.$content.find(".jrPage").length&&e.showMessage({errorCode:"report.empty.error"})})}):(e.isReportRunning=!0,e.component.run().fail(n.reject).done(function(){e.isReportRan=!0,e.trigger("componentRendered",e),i.call(e),!r(e)&&e._resetContentOverflow(e._calculateContentOverflow(e)),n.resolve();var t=e.$content.find(".jrPage");!t.length&&e.showMessage({errorCode:"report.empty.error"})}))}),n.done(h.bind(this.hideMessage,this)).fail(function(n){"report.execution.cancelled"!==n.errorCode&&(e.$content.empty(),e.showMessage(n))}).always(h.bind(this._onReportRunFinished,this)),n},cancel:function(){return this.isReportRunning?this.component.cancel():(new d.Deferred).resolve()},_initPagination:function(e){var n=this.component,t=this.paginationView=new g(e);this.listenTo(t,"pagination:change",function(e){n.pages(e).run().done(h.bind(function(){t.options.silent&&t.$el.find(".current").val(e)},this)).fail(h.bind(function(){t.model.set("current",t.model.defaults.current)},this)).always(h.bind(this._onReportRunFinished,this))}),this.$content.before(t.render().$el)},_refreshPagination:function(e,n){var t={total:e};n&&n.resetCurrent&&(t.current=this.paginationView.model.defaults.current),this.paginationView.resetSetOptions(),this.paginationView.model.set(t),this.paginationView.show()},_resetContentOverflow:function(e){var e=e||{};this.$content.css({"overflow-x":e.overflowX||"auto","overflow-y":e.overflowY||"auto"})},_calculateContentOverflow:function(){var e="auto",n="auto",t=this.$content.find(".jrPage"),i=t.outerWidth(),r=t.outerHeight(),a=this.$content.outerWidth(),s=this.$content.outerHeight(),h=this.model.get("scaleToFit"),d=1!==h?o(h,i,r,a,s):1;return a>=Math.floor(i*d)&&(e="hidden"),s>=Math.floor(r*d)&&(n="hidden"),{overflowX:e,overflowY:n}},_removePagination:function(){this.paginationView&&(this.stopListening(this.paginationView),this.paginationView.remove(),this.paginationView=null)},_onComponentRendered:function(){var e=r(this);this.model.set("isAdhocChart",e),e&&this.model.set("scaleToFit",b.CONTAINER,{silent:!0})},_onReportRunFinished:function(){this.isReportRunning=!1},_onComponentPropertiesChange:function(){this.model.hasChanged("scaleToFit")&&(this.component.scale(this.model.get("scaleToFit")),this._renderComponent(),this._resetContentOverflow(this._calculateContentOverflow()))},_errorMessageFactory:R}});