define(["require","exports","module","underscore","jquery","bundle!DashboardBundle","logger","text!../../../template/dashletTemplate.htm","../../../enum/dashboardComponentTypes","common/component/option/OptionContainer","text!../../../template/dashletToolbarButtonTemplate.htm","text!../../../template/dashletToolbarTemplate.htm"],function(t,e,o){var i=t("underscore"),s=t("jquery"),n=t("bundle!DashboardBundle"),a=t("logger").register(o),h=t("text!../../../template/dashletTemplate.htm"),r=(t("../../../enum/dashboardComponentTypes"),t("common/component/option/OptionContainer")),l=t("text!../../../template/dashletToolbarButtonTemplate.htm"),d=t("text!../../../template/dashletToolbarTemplate.htm");return{template:i.template(h),_onViewInitialize:function(){this.$dashlet=this.$("> .dashletContent"),this.$content=this.$("> .dashletContent > .content"),this.on("componentRendered",i.bind(this._toggleDashletToolbarButtons,this)),this.on("componentRendered",function(){this.ready.resolve()},this)},_onViewRender:function(){i.defer(i.bind(this.resize,this)),this._setDashletVisualAppearance(),this.model.isVisualization()&&(this._initToolbar(),this._setDashletToolbarVisualAppearance())},_onViewResize:function(){this.$content.height(this.$dashlet.height()-2*this.dashboardProperties.get("dashletPadding")-(this.toolbar&&this.toolbar.$el.is(":visible")?this.toolbar.$el.outerHeight(!0):0)-(this.paginationView&&this.paginationView.$el.is(":visible")?this.paginationView.$el.outerHeight(!0):0)-(this.component&&this.component.$footer&&this.component.$footer.is(":visible")?this.component.$footer.hasClass("fixed")?0:this.component.$footer.outerHeight(!0):0))},refresh:function(){return s.Deferred().resolve()},cancel:function(){return s.Deferred().resolve()},_initToolbar:function(){this.toolbar&&this.toolbar.remove(),this.toolbar=new r({options:[{cssClass:"maximizeDashletButton",action:"maximize",title:n["dashlet.toolbar.button.maximize"],text:"",disabled:!0,hidden:!1},{cssClass:"text cancelDashletButton",action:"cancel",title:n["dashlet.toolbar.button.cancel"],text:n["dashlet.toolbar.button.cancel"],hidden:!0},{cssClass:"refreshDashletButton",action:"refresh",title:n["dashlet.toolbar.button.refresh"],text:"",disabled:!0,hidden:!1}],contextName:"button",contentContainer:".buttons",mainTemplate:d,optionTemplate:l}),this.toolbar.$(".innerLabel > p").text(this.model.get("name")),this.listenTo(this.toolbar,"button:refresh",this._onRefreshClick),this.listenTo(this.toolbar,"button:maximize",this._onMaximizeClick),this.listenTo(this.toolbar,"button:cancel",this._onCancelClick),this.listenTo(this.model,"change:name",i.bind(function(){this.toolbar.$(".innerLabel > p").text(this.model.get("name"))},this)),this.$dashlet.prepend(this.toolbar.$el)},_setDashletToolbarVisualAppearance:function(t){this.toolbar&&(this.toolbar[this.model.get("showTitleBar")?"show":"hide"](),this.toolbar.getOptionView("refresh")[this.model.get("showRefreshButton")?"show":"hide"](),this.toolbar.getOptionView("maximize")[this.model.get("showMaximizeButton")?"show":"hide"](),t&&"showTitleBar"in t&&this.resize())},_setDashletVisualAppearance:function(){this.dashboardProperties.get("showDashletBorders")?this.$dashlet.removeAttr("style"):this.$dashlet.css("border-color",s(".dashboardCanvas").css("background-color"));var t=this.dashboardProperties.get("dashletMargin");if(!this.dashboardProperties.get("showDashletBorders"))try{var e=parseInt(this.$dashlet.css("border-width"),10);t-=isNaN(e)?0:e}catch(o){}this.$el.css("padding",t+"px"),this.$content.css("padding",this.dashboardProperties.get("dashletPadding")+"px")},_onMaximizeClick:function(){this.model.isVisualization()&&this.trigger("maximize")},_toggleDashletToolbarButtons:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").enable(),this.toolbar.getOptionView("maximize").enable())},_onRefreshClick:function(){this._hideRefreshButton(),this.refresh().always(i.bind(this._showRefreshButton,this))},_onCancelClick:function(){var t=this;this.cancel().done(function(){a.debug("canceled dashlet refresh"),t._showRefreshButton()})},_enableRefreshButton:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").enable(),this.toolbar.getOptionView("cancel").hide())},_disableRefreshButton:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").disable(),this.toolbar.getOptionView("cancel").show())},_hideRefreshButton:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").hide(),this.toolbar.getOptionView("cancel").show())},_showRefreshButton:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").show(),this.toolbar.getOptionView("cancel").hide())},_errorMessageFactory:function(t){return n["dashboard.dashlet.error."+t.errorCode]},showMessage:function(t){if(t&&t.errorCode){var e=this._errorMessageFactory(t);e?this.$(".nothingToDisplay").removeClass("hidden").show().find(".message").html(e):a.warn("Unhandled message: "+t.toString())}},hideMessage:function(){this.$(".nothingToDisplay").addClass("hidden").hide()},_onViewRemove:function(){this.toolbar&&this.toolbar.remove()}}});