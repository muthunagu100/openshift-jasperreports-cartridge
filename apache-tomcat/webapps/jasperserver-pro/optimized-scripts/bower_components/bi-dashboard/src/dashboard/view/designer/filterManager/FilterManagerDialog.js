define(["require","exports","module","./CollectionView","common/component/dialog/Dialog","common/component/tooltip/Tooltip","../../../collection/filterManager/WiringProducerViewModelCollection","../../../model/filterManager/WiringProducerViewModel","./WiringProducerView","../../../model/component/ValueDashboardComponentModel","../../../enum/dashboardComponentTypes","../../../enum/dashboardComponentTypes","../../../enum/dashboardWiringStandardIds","underscore","common/view/trait/viewRivetsTrait","text!../../../template/filterManager/filterManagerTemplate.htm","bundle!DashboardBundle","bundle!CommonBundle"],function(e){function n(e){var n=e.filter(function(e){return u.contains([s.REPORT,s.ADHOC_VIEW,s.CROSSTAB,s.CHART,s.TABLE],e.get("type"))&&e.has("parameters")&&e.get("parameters").length>0});return u.map(n,function(e){return{name:e.get("name"),id:e.get("id"),parameters:e.get("parameters")}})}var t=e("./CollectionView"),o=e("common/component/dialog/Dialog"),i=e("common/component/tooltip/Tooltip"),r=e("../../../collection/filterManager/WiringProducerViewModelCollection"),a=e("../../../model/filterManager/WiringProducerViewModel"),c=e("./WiringProducerView"),l=e("../../../model/component/ValueDashboardComponentModel"),s=e("../../../enum/dashboardComponentTypes"),d=e("../../../enum/dashboardComponentTypes"),m=e("../../../enum/dashboardWiringStandardIds"),u=e("underscore"),p=(e("common/view/trait/viewRivetsTrait"),e("text!../../../template/filterManager/filterManagerTemplate.htm")),g=e("bundle!DashboardBundle"),h=e("bundle!CommonBundle");return o.extend({events:u.extend({"click a.addNewFilter":"addNewFilter"},o.prototype.events),constructor:function(e){this.foundation=e.model,o.prototype.constructor.call(this,{buttons:[{label:h["button.ok"],action:"ok",primary:!0},{label:h["button.cancel"],action:"cancel",primary:!1}],title:g["dashboard.filter.manager.title"],additionalCssClasses:"filterManagerDialog",modal:!0,resizable:!1,content:new t({template:p,templateOptions:{i18n:g},modelView:c,modelViewOptions:{consumers:n(this.foundation.components)},contentContainer:"tbody",collection:new r})}),this.on("button:ok",this.applyWiringChanges),this.on("button:cancel",this.close)},applyWiringChanges:function(){if(this.content.collection.isValid(!0)){var e=this,n=u.pluck(e.content.collection.models,"component"),t=this.foundation.components.filter(function(e){return e.get("type")!==d.INPUT_CONTROL&&e.get("type")!==d.VALUE});this.foundation.components.set(n.concat(t)),this.foundation.wiring.each(function(n){(n.component.get("type")===d.INPUT_CONTROL||n.component.get("type")===d.VALUE)&&n.consumers.set(e.content.collection.get(n.get("component")).consumers.map(function(e){return{consumer:e.get("id")+":"+e.get("parameter")}}))});var o=this.foundation.wiring.findWhere({name:m.REFRESH_SIGNAL}),i=[];o&&(e.content.collection.each(function(n){n.component.getParent()&&n.consumers.each(function(n){var t=e.foundation.components.get(n.get("id"));t.isVisualization()&&t.get("type")!==d.WEB_PAGE_VIEW&&i.push(n.get("id"))})}),o.consumers.set(u.map(u.uniq(i),function(e){return{consumer:e+":"+m.APPLY_SLOT}}))),u.invoke(this.foundation.components.where({type:d.FILTER_GROUP}),"notify",!0),this.close()}},render:function(){return o.prototype.render.apply(this,arguments),i.attachTo(this.$el),this},open:function(){this.content.collection.reset(r.createFromDashboardWiringCollection(this.foundation.wiring,this.foundation.components).models),this.content._modelViewOptions={consumers:n(this.foundation.components)},o.prototype.open.call(this,{renderContent:!0})},close:function(){this.content.collection.reset(),o.prototype.close.apply(this,arguments)},addNewFilter:function(e){e.stopPropagation(),e.preventDefault();var n=new a,t=new l;t.collection=this.foundation.components,t.unset("id"),t.unset("name"),t.unset("label"),n.component=t,this.content.collection.add(n)}})});