define(["require","exports","module","jquery","underscore","./view/designer/SidebarView","./DashboardViewer","./view/designer/DesignerCanvasView","common/enum/httpStatusCodes","./view/designer/DesignerToolbarView","./view/viewer/ViewerCanvasView","./model/DashboardModel","common/model/RepositoryResourceModel","./model/component/PropertiesDashboardComponentModel","./collection/DashboardStateCollection","./layout/GridLayoutStrategy","./dashboardMessageBus","./enum/dashboardMessageBusEvents","./enum/dashboardWiringStandardIds","text!dashboard/template/welcomeTextTemplate.htm","bundle!DashboardBundle","css!dashboard/designer.css"],function(e){var s=e("jquery"),i=e("underscore"),t=e("./view/designer/SidebarView"),o=e("./DashboardViewer"),n=e("./view/designer/DesignerCanvasView"),a=(e("common/enum/httpStatusCodes"),e("./view/designer/DesignerToolbarView")),d=e("./view/viewer/ViewerCanvasView"),r=(e("./model/DashboardModel"),e("common/model/RepositoryResourceModel"),e("./model/component/PropertiesDashboardComponentModel"),e("./collection/DashboardStateCollection")),h=e("./layout/GridLayoutStrategy"),l=e("./dashboardMessageBus"),u=e("./enum/dashboardMessageBusEvents"),v=(e("./enum/dashboardWiringStandardIds"),e("text!dashboard/template/welcomeTextTemplate.htm")),c=e("bundle!DashboardBundle");return e("css!dashboard/designer.css"),o.extend({initialize:function(){i.bindAll(this,"_onPageLeave","_onSessionExpired","_onUnload"),this.state=new r([],{model:this.model}),this.strategy=new h(this.model),this.sidebar=new t({model:this.model,strategy:this.strategy}),this.designerCanvas=new n({model:this.model,strategy:this.strategy,state:this.state}),this.toolbar=new a({model:this.model,state:this.state}),this.canvas=new d({model:this.model,dashboardId:this.dashboardId}),this.canvas.stopListening(),this.canvas.$el.hide(),this.canvas.model=void 0,this.listenTo(this.toolbar,"preview:on",i.bind(function(){this.enterPreviewMode()},this)),this.listenTo(this.toolbar,"preview:off",i.bind(function(){this.exitPreviewMode()},this)),this.listenTo(this.toolbar,"grid:on",i.bind(function(){this.showLayoutGrid()},this)),this.listenTo(this.toolbar,"grid:off",i.bind(function(){this.hideLayoutGrid()},this)),this.listenTo(this.toolbar,"dashboard:save",this._onDashboardSave),this.listenTo(this.model,"error:all",this._onAllModelErrors),this.listenTo(this.sidebar,"open",i.bind(this._onSidebarToggle,this,!1)),this.listenTo(this.sidebar,"close",i.bind(this._onSidebarToggle,this,!0)),this.listenTo(this.sidebar,"resize",i.bind(this._onSidebarResize,this)),this.listenTo(this.sidebar,"resizeStop",i.bind(this._resizeComponents,this)),this.listenTo(l,u.SAVE_DASHBOARD_STATE,i.bind(this.state.saveState,this.state)),this.listenTo(l,u.SESSION_EXPIRED,this._onSessionExpired),this.render(),this._startHistory(),this._initPreventTextSelection("#banner","#frame"),window.onpagehide||null===window.onpagehide?s(window).on("pagehide",this._onUnload):s(window).on("unload",this._onUnload),s(window).on("beforeunload",this._onPageLeave),s(window).on(u.SESSION_EXPIRED,this._onSessionExpired)},showInitialMessage:function(){this.designerCanvas.showMessage(i.template(v,{i18n:c}))},hideMessageBox:function(){this.designerCanvas.hideMessage()},enterPreviewMode:function(){this.$el.removeClass("twoColumn").addClass("oneColumn"),this.sidebar.$el.hide(),this.designerCanvas.$el.hide(),this.canvas.$el.show(),this.canvas.model=this.model.clone(),this.canvas.render(),this.canvas.$el.addClass("previewMode"),this.canvas.model.currentFoundation.startLoadingSequence()},exitPreviewMode:function(){this.$el.removeClass("oneColumn").addClass("twoColumn"),this.canvas.$el.removeClass("previewMode"),this.canvas.$el.hide(),this.canvas.disableAutoRefresh(),this.canvas.removeAllComponentViews(),this.sidebar.$el.show(),this.designerCanvas.$el.show(),delete this.canvas.model,this._resizeComponents(),this.sidebar.accordion.fit()},showLayoutGrid:function(){this.designerCanvas.$el.find(".grid").show()},hideLayoutGrid:function(){this.designerCanvas.$el.find(".grid").hide()},_onPageLeave:function(e){return this.sessionExpired?void 0:!this.model.isNew()&&this.state.hasPreviousState()||this.model.isNew()&&this.model.currentFoundation.hasVisualComponents()?((e||window.event).returnValue=c["dashboard.dialog.unsaved.changes"],c["dashboard.dialog.unsaved.changes"]):void 0},_onDashboardSave:function(){this.state.init(),this._updateLocationHash()},_updateLocationHash:function(){this.model.has("uri")&&this.history.navigate(this.model.get("uri"),{trigger:!1,replace:!1})},_onLocationHashChange:function(e){!this.model.isNew()&&this.state.hasPreviousState()||this.model.isNew()&&this.model.currentFoundation.hasVisualComponents()?window.confirm(c["dashboard.dialog.unsaved.changes"])?this._loadModelByUri(e):this.history.navigate(this.model.get("uri"),{trigger:!1,replace:!0}):this._loadModelByUri(e)},_onAllModelErrors:function(e,s,i){this.model.unset("uri");var t=c["dashboard.canvas.error."+s.errorCode]||c[404===i.status?"dashboard.canvas.error.not.found":"dashboard.canvas.error.unexpected.error"];this.designerCanvas.showMessage(t)},_onSidebarToggle:function(e){var s=this.designerCanvas.$el,i=this.sidebar.$contentContainer[e?"outerWidth":"width"]()-(e?parseInt(s.css("marginLeft"))/2:0);s.css({left:i}),this.toolbar.$el.css({left:i}),this._resizeComponents()},_onSidebarResize:function(e,s){var i=s.size.width;this.designerCanvas.$el.css({left:i}),this.toolbar.$el.css({left:i})},_onSessionExpired:function(){this.sessionExpired=!0,window.location.reload()},_onUnload:function(){var e=i.pick(this,"sessionExpired");this.designerCanvas.remove(e),this.canvas.remove(e)},_resizeComponents:function(){i.invoke(this.designerCanvas.componentViews,"resize")},render:function(){return this.$el.empty(),this.$el.append(this.toolbar.render().$el),this.$el.append(this.canvas.$el),this.$el.append(this.designerCanvas.render().$el),this.$el.append(this.sidebar.render().$el),this},remove:function(){this.sidebar.remove(),this.strategy.remove(),this.designerCanvas.remove(),s(window).off(u.SESSION_EXPIRED,this._onSessionExpired),s(window).off("beforeunload",this._onPageLeave),s(window).off("pagehide unload"),o.prototype.remove.apply(this,arguments)}})});