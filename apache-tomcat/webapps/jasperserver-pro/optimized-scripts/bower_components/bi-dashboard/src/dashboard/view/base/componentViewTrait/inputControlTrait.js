define(["require","backbone","underscore","bi/control/collection/InputControlCollection","bi/control/view/InputControlCollectionView","../../../collection/ReportsParametersCollection","bi/control/model/InputControlPropertiesModel","text!dashboard/template/inputControlWrapperTemplate.htm","dashboard/dashboardSettings"],function(e){function t(e){return e.options?n.reduce(e.options,function(e,t){return t.selected&&e.push(t.value),e},[]):e.value}var o=e("backbone"),n=e("underscore"),i=e("bi/control/collection/InputControlCollection"),r=e("bi/control/view/InputControlCollectionView"),l=e("../../../collection/ReportsParametersCollection").instance,s=e("bi/control/model/InputControlPropertiesModel"),a=e("text!dashboard/template/inputControlWrapperTemplate.htm"),c=e("dashboard/dashboardSettings");return{template:n.template(a),_onViewInitialize:function(){this.paramsModel=new o.Model(this.model.get("params")),n.bindAll("notify"),this.listenTo(this.model,"signal",function(e){n.isUndefined(e.value)?this.paramsModel.unset(e.name,{trigger:!0}):this.paramsModel.set(e.name,e.value)}),this.listenTo(this.paramsModel,"change",function(e,t){this.model.set("params",this.paramsModel.attributes),t&&t.trigger&&this.model.collection.trigger("changedControlProperties",this.model);var o=n.keys(e.changed);if(n.intersection(o,this.getDirectParameters()).length===o.length){var i=n.difference([this.model.getOwnerParameterName()].concat(this.model.get("masterDependencies")),n.keys(this.paramsModel.attributes));this.inputControlCollection.updateState({params:this.paramsModel.attributes},i)}})},_initComponent:function(){this.inputControlPropertiesModel=new s({resource:this.model.getOwnerUri(),server:c.CONTEXT_PATH}),this.inputControlCollection=new i([],{stateModel:this.inputControlPropertiesModel}),this.component=new r({collection:this.inputControlCollection,stateModel:this.inputControlPropertiesModel}),this.component.setContainer(this.$el),this.listenTo(this.inputControlCollection,"changeState change:state",this.notify);var e=this.inputControlCollection._parseState,t=this.model.getOwnerParameterName();this.inputControlCollection._parseState=function(o){o.id===t&&e.call(this,o)}},_renderComponent:function(){this.reset()},_removeComponent:function(){this.component.remove()},reset:function(){var e=this.inputControlCollection,o=this,i=this.model;l.getInputControlAsParameter(this.model.getOwnerUri(),this.model.getOwnerParameterName(),{full:this.model.get("fullCollectionRequired")}).done(function(r){var l=e.findWhere({id:r.id}),s=e.models&&e.models.length>0,a=l&&r.type===l.get("type");if(s&&a){var c=e.models[0];!(c.state.isValue=!r.state.options)&&c.state.options.models&&c.state.options.models.length!==r.state.options.length&&c.state.set("options",r.state.options),c.changeState(t(r.state))}else{var d=n.extend({},r,{label:i.get("label")||r.label,slaveDependencies:[]});delete d.state.error,e.reset([d])}o.ready.resolve()})},getDirectParameters:function(){var e=[].concat(this.model.get("masterDependencies")),t=this.model.getOwnerUri(),o=this.model.collection.filter(function(e){return e.getOwnerUri&&e.getOwnerUri()===t});return n.each(this.model.get("masterDependencies"),function(t){var i=o.find(function(e){return e.getOwnerParameterName()===t});i&&(e=n.difference(e,i.get("masterDependencies")))}),e},notify:function(){this.model.notify(this.inputControlCollection.models[0].state)}}});