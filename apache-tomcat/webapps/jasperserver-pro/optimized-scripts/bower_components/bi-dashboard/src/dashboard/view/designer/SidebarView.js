define(["require","underscore","jquery","bundle!DashboardBundle","bundle!CommonBundle","json3","backbone","../../collection/ReportsParametersCollection","common/component/tree/Tree","common/component/tree/TreeDataLayer","common/component/tree/plugin/TooltipPlugin","common/component/tree/plugin/InfiniteScrollPlugin","common/component/menu/ContextMenu","common/component/tree/plugin/ContextMenuTreePlugin","common/component/tree/plugin/DragAndDropPlugin","common/component/tree/plugin/SearchPlugin","common/component/tree/plugin/HideEmptyNodesPlugin","common/component/panel/Panel","common/component/panel/trait/collapsiblePanelTrait","common/component/panel/trait/tabbedPanelTrait","common/component/panel/trait/menuPanelTrait","common/component/panel/trait/resizablePanelTrait","dashboard/factory/dashboardComponentModelFactory","dashboard/model/DashboardResourceModel","common/component/accordion/Accordion","dashboard/enum/dashboardComponentTypes","common/enum/repositoryResourceTypes","dashboard/dashboardSettings","text!dashboard/template/sidebarTemplate.htm","text!dashboard/template/sidebarTreeLeafTemplate.htm"],function(e){function t(e){return e.i18n=u,e}function n(e){switch(e.cssClass="dashboard-existingContent-",e.value.resourceType){case A.REPORT_UNIT:e.cssClass+="report";break;case A.ADHOC_DATA_VIEW:e.cssClass+="adhoc";break;case A.INPUT_CONTROL:e.cssClass+="filter"}return e}function o(){var e=this.libraryPanel,t=e.$("> .subcontainer").height(),n=e.$(".searchLockup").filter(":visible").outerHeight(!0);e.$("> .subcontainer").css("overflow","hidden");var o=e.$(".viewPortChunk").closest(".hideRoot"),r=e.$(".viewPortChunk").parent();if(e.selectedTab===M.FOLDERS)r.css({"max-height":""}),o.css({"max-height":t-n+"px",overflow:"auto"});else{o.css({"max-height":""}),r.css({"max-height":t-n+"px",overflow:"auto"});var i=this;l.defer(function(){i.libraryView.recalcConstraints(),i.libraryView.fetchVisibleData()})}}function r(e){if(l.contains([E.ADHOC_VIEW,E.REPORT,E.CROSSTAB,E.CHART,E.TABLE],e.get("type"))&&-1===l.indexOf(this.addedParameterContainers,e.resource.resource.get("uri"))){this.reportParametersContentPanel.content.addItem("/",{id:e.resource.resource.get("uri"),i18n:d,cssClass:"dashboard-existingContent-"+(e.get("type")===E.ADHOC_VIEW?"adhoc":"report"),value:{label:e.get("name"),uri:e.resource.resource.get("uri")},_node:!0});var t=this.reportParametersTree.getLevel(e.resource.resource.get("uri"));t.hasItems()&&this.accordion.expand(this.reportParametersContentPanel),this.listenToOnce(t,"ready",function(e){e.hasItems()&&this.accordion.expand(this.reportParametersContentPanel)},this),this.addedParameterContainers.push(e.resource.resource.get("uri"))}}function i(e){this.reportParametersContentPanel.content.getLevel(e.resource.resource.get("uri")).refresh()}function a(e){if(e.resource){var t=l.indexOf(this.addedParameterContainers,e.resource.resource.get("uri")),n=this;if(-1===t&&(t=l.indexOf(this.addedParameterContainers,e.get("resource"))),t>-1){var o=this.model.currentFoundation.components.findWhere({resource:e.resource.resource.get("uri")});if(o||(o=this.model.currentFoundation.components.findWhere({resource:e.get("resource")})),!o){this.addedParameterContainers.splice(t,1),(!this.addedParameterContainers.length||l.all(this.addedParameterContainers,function(e){return!n.reportParametersTree.getLevel(e).hasItems()}))&&this.accordion.collapse(this.reportParametersContentPanel);var r=this.reportParametersContentPanel.content.getLevel(e.resource.resource.get("uri"));r&&r.remove()}}}}function s(e){var t=new c.Deferred,n=this;return this.predefinedData&&this.predefinedData[e.id]?t.resolve({total:this.predefinedData[e.id].length,data:this.predefinedData[e.id]}):p.getReportParameters(e.id).done(function(){t.resolve({total:n.getDataSize.apply(n,arguments),data:n._process.call(n,n.getDataArray.apply(n,arguments),e)})}).fail(l.bind(t.reject,t)),t}var l=e("underscore"),c=e("jquery"),d=e("bundle!DashboardBundle"),u=e("bundle!CommonBundle"),h=e("json3"),m=e("backbone"),p=e("../../collection/ReportsParametersCollection").instance,b=e("common/component/tree/Tree"),g=e("common/component/tree/TreeDataLayer"),f=e("common/component/tree/plugin/TooltipPlugin"),P=e("common/component/tree/plugin/InfiniteScrollPlugin"),T=e("common/component/menu/ContextMenu"),C=e("common/component/tree/plugin/ContextMenuTreePlugin"),y=e("common/component/tree/plugin/DragAndDropPlugin"),D=e("common/component/tree/plugin/SearchPlugin"),v=e("common/component/tree/plugin/HideEmptyNodesPlugin"),I=e("common/component/panel/Panel"),w=e("common/component/panel/trait/collapsiblePanelTrait"),R=e("common/component/panel/trait/tabbedPanelTrait"),S=e("common/component/panel/trait/menuPanelTrait"),x=e("common/component/panel/trait/resizablePanelTrait"),O=e("dashboard/factory/dashboardComponentModelFactory"),_=e("dashboard/model/DashboardResourceModel"),L=e("common/component/accordion/Accordion"),E=e("dashboard/enum/dashboardComponentTypes"),A=e("common/enum/repositoryResourceTypes"),H=e("dashboard/dashboardSettings"),z=e("text!dashboard/template/sidebarTemplate.htm"),F=e("text!dashboard/template/sidebarTreeLeafTemplate.htm"),V=22,M={FOLDERS:"folders",LIST:"list"},U={VIEW:"view",VISUALIZATION:"visualization"},N={folders:{bufferSize:5e3},list:{bufferSize:100,cache:{searchKey:"searchString",pageSize:100}}};return I.extend({constructor:function(e){I.call(this,l.extend({title:d["dashboard.sidebar.title"],collapserSelector:"> .button.minimize",template:z,traits:[w,x],collapsed:!1,contentContainer:".content",closedClass:"minimized",handles:"e",minWidth:H.SIDEBAR_MIN_WIDTH,maxWidth:H.SIDEBAR_MAX_WIDTH},e))},initialize:function(e){function u(){k&&W&&this.accordion.fit()}var m=this;I.prototype.initialize.apply(this,arguments),e||(e={}),e.strategy||(e.strategy={onDashletDragStart:function(){},onDashletDrag:function(){},onDashletDragStop:function(){}}),this.addedParameterContainers=[],this.filterContextMenu=new T([{label:d["dashboard.context.menu.option.add.to.filter.manager"],action:"add"},{label:d["dashboard.context.menu.option.remove.from.filter.manager"],action:"remove","default":!0}],{toggle:!0}),this.listenTo(this.filterContextMenu,"option:add",function(){var e=this.filterContextMenu.treeItem.value,t=_.createDashboardResource(e),n=this.model.currentFoundation.components,o=O(e,{resource:t,collection:n},{createComponentObj:!0});o.set({ownerResourceId:e.ownerResourceId,ownerResourceParameterName:e.ownerResourceParameterName,masterDependencies:e.masterDependencies,fullCollectionRequired:e.mandatory&&!!e.masterDependencies.length}),!n.findWhere({resource:e.uri})&&n.add(o)}),this.listenTo(this.filterContextMenu,"option:remove",function(){var e=this.filterContextMenu.treeItem.value,t=this.model.currentFoundation.components,n=t.findWhere({resource:e.uri});n&&t.remove(n)});var p=b.use(f).use(C,{contextMenu:this.filterContextMenu,defaultSelectedItems:function(e,t){var n=l.find(m.model.currentFoundation.wiring.models,function(t){return t.component.get("resource")===e.value.uri});return n?t[0]:void 0},showContextMenuCondition:function(e){return"dashboard-existingContent-filter-invisible"===e.cssClass?this.contextMenu:void 0}}).use(v).use(y,{onDragStart:l.bind(e.strategy.onDashletDragStart,e.strategy),onDrag:l.bind(e.strategy.onDashletDrag,e.strategy),onDragStop:l.bind(e.strategy.onDashletDragStop,e.strategy)}).create(),E=b.use(f).use(P).use(D,{additionalParams:{type:[A.REPORT_UNIT,A.ADHOC_DATA_VIEW]}}).use(y,{onDragStart:l.bind(e.strategy.onDashletDragStart,e.strategy),onDrag:l.bind(e.strategy.onDashletDrag,e.strategy),onDragStop:l.bind(e.strategy.onDashletDragStop,e.strategy)}).create(),m=this;this.reportParametersTree=p.instance({itemsTemplate:F,listItemHeight:V,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,predefinedData:{"/":[]},processors:[{processItem:function(e,t){return e.value.ownerResourceId=t.id,e.value.ownerResourceParameterName=e.value.id,e.value.resourceType=A.INPUT_CONTROL,e}},{processItem:n},{processItem:t},{processItem:function(e){return e.value.visible||(e.dragDisabled=e.cssClass+="-invisible"),e}}],getDataArray:function(e){return l.clone(e)}}),this.reportParametersTree.defaultDataLayer.obtainData=s,this.newContentTree=p.instance({itemsTemplate:F,dataUriTemplate:this.model.contextPath+"/rest_v2/settings/dashboardSettings",selection:{allowed:!0,multiple:!1},listItemHeight:V,lazyLoad:!1,rootless:!0,processors:[{processItem:t},{processItem:function(e){return e.cssClass="dashboard-newContent-"+e.value.id,e}}],getDataArray:function(e){return l.map(e.newItemsRegistry,function(e){return e.label=d[e.label]?d[e.label]:e.label,e.description=d[e.description]?d[e.description]:e.description,e})}});var z=[{processItem:function(e){return e._node=e.value.resourceType===A.FOLDER,e}},{processItem:function(e){return"folder"!==e.value.resourceType||""!==e.value._links.content?(delete e.value._links,e):void 0}},{processItem:n},{processItem:t}];this.existingContentTreeView=b.use(f).use(P).use(y,{onDragStart:l.bind(e.strategy.onDashletDragStart,e.strategy),onDrag:l.bind(e.strategy.onDashletDrag,e.strategy),onDragStop:l.bind(e.strategy.onDashletDragStop,e.strategy)}).use(D,{additionalParams:{type:[A.REPORT_UNIT,A.ADHOC_DATA_VIEW]}}).create().instance(l.extend({},N[M.FOLDERS],{itemsTemplate:F,listItemHeight:V,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,additionalCssClasses:"folders",dataUriTemplate:e.model.contextPath+"/rest_v2/api/resources?{{= id != '@fakeRoot' ? 'folderUri=' + id : ''}}&recursive=false&containerType="+A.FOLDER+"&excludeFolder=/temp&offset={{= offset }}&limit={{= limit }}&forceFullPage=true",levelDataId:"uri",customDataLayers:{"/":l.extend(new g({dataUriTemplate:e.contextPath+"/flow.html?_flowId=searchFlow&method=getNode&provider=repositoryExplorerTreeFoldersProvider&uri=/&depth=1",processors:z,getDataArray:function(e){e=h.parse(c(e).text());var t=l.find(e.children,function(e){return"/public"===e.uri});return[{id:"@fakeRoot",label:e.label,uri:"/",resourceType:"folder",_links:{content:"@fakeContentLink"}},{id:"/public",label:t.label,uri:"/public",resourceType:"folder",_links:{content:"@fakeContentLink"}}]}}),{accept:"text/html",dataType:"text"})},processors:[{processItem:function(e){return"/public"!==e.value.uri?e:void 0}}].concat(z),getDataArray:function(e){return e&&e[A.RESOURCE_LOOKUP]?e[A.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,n){return+n.getResponseHeader("Total-Count")}})),this.libraryView=E.instance(l.extend({},N[M.LIST],{itemsTemplate:F,listItemHeight:V,selection:{allowed:!0,multiple:!1},rootless:!0,dataUriTemplate:e.model.contextPath+"/rest_v2/resources?offset={{= offset }}&limit={{= limit }}&forceTotalCount=true&excludeFolder=/temp&forceFullPage=true",levelDataId:"uri",processors:[{processItem:n},{processItem:t}],getDataArray:function(e){return e&&e[A.RESOURCE_LOOKUP]?e[A.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,n){return+n.getResponseHeader("Total-Count")}})),this.libraryPanel=new I({title:d["dashboard.sidebar.existing.content.library"],traits:[w,S,R,x],collapsed:!1,handles:"s",additionalCssClasses:"libraryPanel",resizableEl:".subcontainer",overflow:"hidden",tabs:[{action:M.LIST,content:this.libraryView,primary:!0,label:M.LIST,hidden:!0},{action:M.FOLDERS,content:this.existingContentTreeView,label:M.FOLDERS,hidden:!0}],menuOptionSelectable:!0,menuOptions:[{label:d["dashboard.sidebar.existing.content.list.view"],groupId:U.VIEW,action:M.LIST,"default":!0},{label:d["dashboard.sidebar.existing.content.folder.view"],groupId:U.VIEW,action:M.FOLDERS},{label:d["dashboard.sidebar.existing.content.all"],groupId:U.VISUALIZATION,action:"all","default":!0},{label:d["dashboard.sidebar.existing.content.reports"],groupId:U.VISUALIZATION,action:"report"},{label:d["dashboard.sidebar.existing.content.adhoc.views"],groupId:U.VISUALIZATION,action:"adhoc"}],onCollapseControlPressed:function(){m._resetHeights(),m.accordion.toggle(m.libraryPanel)}}),this.newContentPanel=new I({title:d["dashboard.sidebar.new.content"],traits:[w,x],collapsed:!1,fixedHeight:!0,content:this.newContentTree,handles:"s",additionalCssClasses:"newContentPanel",resizableEl:".subcontainer",minHeight:H.PANELS_MIN_HEIGHT,onCollapseControlPressed:function(){m._resetHeights(),m.accordion.toggle(m.newContentPanel)}}),this.reportParametersContentPanel=new I({title:d["dashboard.sidebar.report.parameters"],traits:[w],collapsed:!0,additionalCssClasses:"reportParametersContentPanel",silent:!1,content:this.reportParametersTree,onCollapseControlPressed:function(){m._resetHeights(),m.accordion.toggle(m.reportParametersContentPanel)}}),this.accordion=new L({container:this.$("> .content > .body"),panels:[this.newContentPanel,this.libraryPanel,this.reportParametersContentPanel],allowMultiplePanelsOpen:!0}),this.windowHeight=c(window).height();var W=!1,k=!1;this.listenToOnce(this.newContentTree.getLevel("/"),"ready",function(){W=!0,u.call(this),this.newContentPanelDefaultHeight=this.newContentPanel.$el.outerHeight(!0)},this),this.listenToOnce(this.libraryView.getLevel("/"),"ready",function(){k=!0,u.call(this)},this),this.listenTo(this.accordion,"fit",l.bind(o,this)),this.listenTo(this.model.foundations,"addComponent",function(e,t){t===m.model.currentFoundation&&r.call(m,e)}),this.listenTo(this.model.foundations,"removeComponent",function(e,t){t===m.model.currentFoundation&&a.call(m,e)}),this.listenTo(this.model.foundations,"editComponent",function(e,t){t===m.model.currentFoundation&&i.call(m,e)}),this.listenTo(this.libraryPanel,"option:all",l.bind(function(){this.libraryView.clearCache(),this._filterByResource()},this)),this.listenTo(this.libraryPanel,"option:report",l.bind(function(){this.libraryView.clearCache(),this._filterByResource({type:[A.REPORT_UNIT]},"report")},this)),this.listenTo(this.libraryPanel,"option:adhoc",l.bind(function(){this.libraryView.clearCache(),this._filterByResource({type:[A.ADHOC_DATA_VIEW]},"adhoc")},this)),this.listenTo(this.libraryPanel,"option:folders",l.bind(function(){this.libraryPanel.openTab(M.FOLDERS),this._filterByResource(this.activeResourceFilterOptions),this.accordion.fit()},this)),this.listenTo(this.libraryPanel,"option:list",l.bind(function(){this.libraryPanel.openTab(M.LIST),this._filterByResource(this.activeResourceFilterOptions),this.accordion.fit()},this)),this.listenTo(this.libraryPanel.tabs[M.FOLDERS].searchForm,"search",l.bind(function(e){var t=this.libraryPanel.tabs[M.LIST].searchForm,n=[{action:M.LIST,groupId:U.VIEW}];this.activeVisualization&&n.push({action:this.activeVisualization,groupId:"visualization"}),t.setSearchString(e.searchString),t.search(e),this.libraryPanel.filterMenu.resetSelection(n,!0)},this)),this.listenTo(this.libraryPanel.tabs[M.LIST].searchForm,"clear",l.bind(function(){this.libraryPanel.tabs[M.FOLDERS].searchForm.clear()},this)),this.listenTo(this.newContentPanel,"resize",l.bind(this._onPanelResize,this,this.newContentPanel)),this.listenTo(this.libraryPanel,"resize",l.bind(this._onPanelResize,this,this.libraryPanel)),l.bindAll(this,"_onWindowResize"),c(window).on("resize",this._onWindowResize)},_onPanelResize:function(e){var t=l.isEqual(e,this.libraryPanel);this.reportParametersContentPanel.fixedHeight=!t,this.libraryPanel.fixedHeight=t,this.accordion.fit()},_filterByResource:function(e,t){t&&this._setActiveVisualization(t),l.isEqual(e,this.activeResourceFilterOptions)&&this.selectedTabId===this.libraryPanel.selectedTab||(this.selectedTabId=this.libraryPanel.selectedTab,this.selectedTab=this.libraryPanel.tabs[this.selectedTabId],this.activeResourceFilterOptions=e||{},this.selectedTab.searchForm.search(this.activeResourceFilterOptions))},_setActiveVisualization:function(e){this.activeVisualization=e},_resetHeights:function(){this.libraryPanel.fixedHeight=!1,this.reportParametersContentPanel.fixedHeight=!1,this.newContentPanel.setHeight(this.newContentPanelDefaultHeight)},_onWindowResize:function(e){var t=c(window).height();e.target.tagName||this.windowHeight===t||(this.windowHeight=t,this._resetHeights(),this.resizeTimer&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(l.bind(function(){this.accordion.fit()},this),100))},render:function(){return this.$("> .content > .body").append(this.newContentPanel.$el).append(this.libraryPanel.$el).append(this.reportParametersContentPanel.$el),this.reportParametersContentPanel.content.expand("/",{depth:0,silent:!0}),this},remove:function(){c(window).off("resize",this._onWindowResize),this.newContentPanel.remove(),this.libraryPanel.remove(),this.reportParametersContentPanel.remove(),this.filterContextMenu.remove(),m.View.prototype.remove.apply(this,arguments)}})});