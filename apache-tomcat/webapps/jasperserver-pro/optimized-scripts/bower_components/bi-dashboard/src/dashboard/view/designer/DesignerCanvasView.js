define(["require","exports","module","jquery","underscore","bundle!CommonBundle","./DashboardOverlayDialog","../viewer/ViewerCanvasView","./AdhocDesignerIframeView","dashboard/model/DashboardResourceModel","common/model/RepositoryResourceModel","dashboard/model/component/DashletModel","dashboard/factory/dashboardComponentModelFactory","dashboard/view/designer/AddDashboardComponentDialogController","../../factory/dashboardComponentViewFactory","dashboard/enum/dashboardComponentTypes","dashboard/dashboardSettings","dashboard/enum/dashboardResourceReferenceTypes","common/enum/repositoryResourceTypes","../../dashboardMessageBus","../../enum/dashboardMessageBusEvents","dashboard/mapper/adHocToDashboardTypeMapper","logger","jquery.ui"],function(e,o,t){function n(e){function o(e){delete e.version,s.each(s.keys(e),function(t){s.isObject(e[t])&&o(e[t])})}e.unset("version"),o(e.attributes)}function r(e,o,t){if(!s.isObject(e))return e;var n=s.keys(e)[0],r=e[n];return a(r,o)||(r=e[t]=s.pick(r,"uri"),delete e[n]),r}function a(e,o){return 0===(e.uri||"").indexOf(o)}var i=e("jquery"),s=e("underscore"),d=e("bundle!CommonBundle"),l=e("./DashboardOverlayDialog"),c=e("../viewer/ViewerCanvasView"),u=e("./AdhocDesignerIframeView"),h=e("dashboard/model/DashboardResourceModel"),p=e("common/model/RepositoryResourceModel"),m=(e("dashboard/model/component/DashletModel"),e("dashboard/factory/dashboardComponentModelFactory")),g=e("dashboard/view/designer/AddDashboardComponentDialogController"),f=(e("../../factory/dashboardComponentViewFactory"),e("dashboard/enum/dashboardComponentTypes")),C=e("dashboard/dashboardSettings"),D=e("dashboard/enum/dashboardResourceReferenceTypes"),y=e("common/enum/repositoryResourceTypes"),v=e("../../dashboardMessageBus"),b=e("../../enum/dashboardMessageBusEvents"),_=e("dashboard/mapper/adHocToDashboardTypeMapper"),T=e("logger").register(t);return e("jquery.ui"),c.extend({isDesigner:!0,addComponentByTypeHandlerMap:function(){var e={};return e[f.WEB_PAGE_VIEW]=this._addWebPageView,e[f.FREE_TEXT]=this._addFreeText,e[f.CHART]=this._addNewVisualization,e[f.CROSSTAB]=this._addNewVisualization,e[f.TABLE]=this._addNewVisualization,e[f.FILTER_GROUP]=this._addInputControl,e},initialize:function(e){s.bindAll(this,"_addWebPageView","_addFreeText","_addNewVisualization","_addDefaultComponentType","_addInputControl"),c.prototype.initialize.apply(this,arguments),this.strategy=e.strategy,this._initGrid(),this.strategy.initVisualHelpers(this.$el),this.$el.droppable({accept:".draggable",activeClass:"ui-dropping",tolerance:"pointer",drop:s.bind(this._onCanvasDrop,this)}),s.bindAll(this,"_onGlobalMousedown","_onGlobalKeydown"),i(document).on("mousedown",this._onGlobalMousedown),i(document).on("keydown",this._onGlobalKeydown),this.$overlay=new l({content:d["dialog.overlay.loading"]})},enableAutoRefresh:function(){},addComponentView:function(e){var o=c.prototype.addComponentView.call(this,e);return o&&this.listenTo(o,"delete",this.removeComponent),o},_onCanvasDrop:function(e,o){var t=i(e.originalEvent.target);if(t.hasClass("dashboardCanvas")||t.parents(".dashboardCanvas").length){var n=this,r=o.helper.data("data");if(r.componentId){var a=this.model.currentFoundation.components.get(r.componentId),d=a.getPositionObject();this.strategy.onDashletDrop(a,e,o,this.$el),s.isEqual(a.getPositionObject(),d)||v.trigger(b.SAVE_DASHBOARD_STATE)}else{if(r.resourceType===y.INPUT_CONTROL&&(this.model.currentFoundation.components.findWhere({resource:r.uri})||this.model.currentFoundation.components.find(function(e){return e.get("type")===y.INPUT_CONTROL&&e.getOwnerUri()===r.ownerResourceId&&e.getOwnerParameterName()===r.id})))return;this.$overlay.open(),this.addComponent(r).done(function(t){t.get("type")===f.FILTER_GROUP&&t.getChildren().length>=2||n.strategy.onDashletDrop(t,e,o,n.$el),i.when(t.paramsDfd||{}).always(function(){n.$overlay.close()}).done(function(){v.trigger(b.SAVE_DASHBOARD_STATE)})})}}},_onGlobalMousedown:function(e){var o,t=this.model.currentFoundation.components,n=t.getSelectedComponent();if(n&&(o=n.get("id"))&&n.isVisible()){var r=this.getComponentViewByComponentId(o).$el,a=r.offset(),s=e.pageX-a.left,d=e.pageY-a.top;s>0&&s<r.width()&&d>0&&d<r.height()||i(e.target).closest("."+C.DASHLET_PROPERTIES_DIALOG_CLASS).length||i(e.target).closest("."+C.DELETE_CONFIRMATION_DIALOG_CLASS).length||i(e.target).closest("."+C.CONTEXT_MENU_CLASS).length||t.selectComponent(void 0)}},_onGlobalKeydown:function(e){46!==e.which||i(e.target).closest("."+C.DASHLET_PROPERTIES_DIALOG_CLASS).length||i(e.target).closest("."+C.SAVE_AS_DIALOG_CLASS).length||i(e.target).find("."+C.SAVE_AS_DIALOG_CLASS+":visible").length||this.removeComponent(this.model.currentFoundation.components.getSelectedComponent())},_initAddComponentDialogEvents:function(e,o,t){var n=this;this.listenTo(this.addComponentDialogController.dialog,"button:ok",function(){t&&t.call(n,e),n.closeAddComponentDialog(),n.model.currentFoundation.components.add(e),n.model.currentFoundation.components.selectComponent(e),o.resolve(e)}),this.listenTo(this.addComponentDialogController.dialog,"button:cancel",function(){n.closeAddComponentDialog(),o.reject(e)})},addComponent:function(e){var o,t,n=this.model.contextPath,r=this.model.currentFoundation.components,a=i.Deferred();if(e.resourceType===y.INPUT_CONTROL){var s=r.findWhere({type:f.FILTER_GROUP});t=s||m({type:f.FILTER_GROUP,name:"Filter Group"},{collection:r})}else e.uri&&e.resourceType&&(o=this.model.resources.get(e.uri),o||(o=h.createDashboardResource(e,n))),t=m(e,{resource:o,collection:r},{createComponentObj:!0});var d=this.addComponentByTypeHandlerMap()[t.get("type")]||this._addDefaultComponentType;return d(t,a,e),a.promise()},addInputControlToFilterGroup:function(e,o){var t=this.model.currentFoundation.components;if(!t.findWhere({resource:e.uri})){var n;e.uri&&e.resourceType&&(this.model.resources.get(e.ownerResourceId)||this.model.resources.each(function(o){o.resource.get("uri")===e.ownerResourceId&&(e.ownerResourceId=o.get("name"))}),n=this.model.resources.get(e.uri),n||(n=h.createDashboardResource(e,this.model.contextPath)));var r=t.get(o),a=r.getChildren(),i=a.length?Math.max.apply(null,s.map(a,function(e){return e.get("position")}))||0:0,d=m(e,{resource:n,collection:t},{createComponentObj:!0});return d.set({ownerResourceId:e.ownerResourceId,ownerResourceParameterName:e.ownerResourceParameterName,masterDependencies:e.masterDependencies,fullCollectionRequired:e.mandatory&&!!e.masterDependencies.length,parentId:o,position:i+1}),t.add(d)}},openAddComponentDialog:function(e){this.$overlay.close(),this.addComponentDialogController=new g(e),this.addComponentDialogController.dialog.open()},closeAddComponentDialog:function(){this.stopListening(this.addComponentDialogController.dialog),this.addComponentDialogController.dialog.close(),this.addComponentDialogController.remove()},openAdhocDesignerIframe:function(e){this.adhocDesigner&&this.removeAdhocDesignerIframe(),this.adhocDesigner=new u({model:e}),this.adhocDesigner.render()},removeAdhocDesignerIframe:function(){this.stopListening(this.adhocDesigner),this.adhocDesigner.remove()},hideAdhocDesignerIframe:function(){this.stopListening(this.adhocDesigner),this.adhocDesigner.hide(),this.adhocDesigner.removeSubComponents(),this.adhocDesigner.detachEvents()},remove:function(){try{this.$el.droppable("destroy"),this.addComponentDialogController&&this.addComponentDialogController.remove(),this.adhocDesigner&&this.adhocDesigner.remove()}catch(e){T.debug(e)}this.$overlay.remove(),i(document).off("mousedown",this._onGlobalMousedown),i(document).off("keydown",this._onGlobalKeydown),c.prototype.remove.apply(this,arguments)},removeComponent:function(e){if(e&&(this.model.currentFoundation.components.selectComponent(void 0),this.model.currentFoundation.components.remove(e),v.trigger(b.SAVE_DASHBOARD_STATE),e.get("type")===f.INPUT_CONTROL)){var o=this.getComponentViewByComponentId(e.get("parentId"));o&&o.refreshFilterGroup();var t=this.model.currentFoundation.components.findWhere({resource:e.get("ownerResourceId")});this.getComponentViewByComponentId(t.id).render()}},_initGrid:function(){var e,o,t=i("<div>").addClass("grid").hide();for(e=1;e<C.GRID_WIDTH;e++)o=this.strategy.cellToCoord(e,0),i("<div>").appendTo(t).css({width:"1px",height:"100%",left:o.x+"%"});for(e=1;e<C.GRID_HEIGHT;e++)o=this.strategy.cellToCoord(0,e),i("<div>").appendTo(t).css({width:"100%",height:"1px",top:o.y+"%"});this.$el.append(t)},_addWebPageView:function(e,o){this.openAddComponentDialog(e),this.addComponentDialogController.dialog.disableButton("ok"),this._initAddComponentDialogEvents(e,o,function(e){e.set("name",e.generateName(e.get("url")))})},_addFreeText:function(e,o){this.openAddComponentDialog(e),this._initAddComponentDialogEvents(e,o)},_addNewVisualization:function(e,o){var t=this,n=this.model.contextPath,r=this.model.currentFoundation.components;this.$overlay.close(),this.openAdhocDesignerIframe(e),this.listenTo(this.adhocDesigner,"close",function(){t.removeAdhocDesignerIframe(),o.reject(e)}),this.listenTo(this.adhocDesigner,"save",function(e,a){t.hideAdhocDesignerIframe(),a.type=_(a.type),a.resourceType=y.ADHOC_DATA_VIEW;var i=h.createDashboardResource(a,n);i.temporary=!0;var s=m(a,{resource:i,collection:r},{createComponentObj:!0});r.add(s),r.selectComponent(s),o.resolve(s)})},_addInputControl:function(e,o,t){var a=this,i=this.model.currentFoundation.components,d=function(){var n=a.addInputControlToFilterGroup(t,e.get("id"));n&&i.selectComponent(n),n&&n.set("label",n.get("name")),o.resolve(e)};if(-1===i.indexOf(e)&&i.add(e),t.ownerResourceId+"_files/"+t.ownerResourceParameterName==t.uri){var l=new p({uri:t.uri},{contextPath:a.model.contextPath});l.fetch({expanded:!0}).done(function(){var e=new h({},{contextPath:a.model.contextPath}),o={},i=l.get("uri");l.unset("uri"),l.set("label",a._generateControlId(t.id)),r(l.get("dataType"),i,"dataTypeReference"),r(l.get("listOfValues"),i,"listOfValuesReference");var s=r(l.get("query"),i,"queryReference");s&&r(s.dataSource,i,"dataSourceReference"),n(l),o[D.INPUT_CONTROL]=l.attributes,e.set({name:i,type:f.INPUT_CONTROL,resource:o}),e.resource.resource=l,a.model.resources.add(e),d()}).fail(s.bind(o.reject,o))}else d()},_addDefaultComponentType:function(e,o){var t=this.model.currentFoundation.components;-1===t.indexOf(e)&&t.add(e),t.selectComponent(e),o.resolve(e)},_generateControlId:function(e){function o(e){return!r.model.currentFoundation.components.find(function(o){return o.resource&&o.resource.resource.get("label")===e})}function t(e,n){var r=e+"_"+n;return o(r)?r:t(e,n+1)}var n=2,r=this;if(o(e))return e;if(/.*_\d+$/.match(e)){var a=e.lastIndexOf("_");n=+e.substring(a+1)+1,e=e.substring(0,a)}return t(e,n)}})});