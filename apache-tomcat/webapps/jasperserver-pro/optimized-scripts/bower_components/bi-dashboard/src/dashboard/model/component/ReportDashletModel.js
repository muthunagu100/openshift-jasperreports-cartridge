define(["require","exports","module","jquery","underscore","logger","common/transport/request","bundle!DashboardBundle","../../enum/dashboardComponentTypes","../../enum/dashboardWiringStandardIds","./DashletModel","common/validation/ValidationErrorMessage","../../collection/ReportsParametersCollection","dashboard/dashboardSettings","bi/report/enum/scaleStrategies"],function(e,r,t){function a(e,r){var t={signals:[],slots:{}};return s.each(r.concat([{id:h.APPLY_SLOT},{id:h.REFRESH_SLOT}]),function(r){t.slots[r.id]=function(r){return function(t,a){e.lastPayload={name:r,value:t},e.lastSender=a,e.trigger("signal",e.lastPayload,a)}}(r.id)}),t}var o=e("jquery"),s=e("underscore"),n=e("logger").register(t),i=(e("common/transport/request"),e("bundle!DashboardBundle")),d=e("../../enum/dashboardComponentTypes"),h=e("../../enum/dashboardWiringStandardIds"),l=e("./DashletModel"),u=e("common/validation/ValidationErrorMessage"),f=e("../../collection/ReportsParametersCollection").instance,c=e("dashboard/dashboardSettings"),p=e("bi/report/enum/scaleStrategies");return l.extend({componentName:i["dashboard.component.report.component.name"],defaults:s.extend({},l.prototype.defaults,{type:d.REPORT,scaleToFit:c.DASHLET_SCALE_TO_FIT,autoRefresh:c.DASHLET_AUTO_REFRESH,refreshInterval:c.DASHLET_REFRESH_INTERVAL_TIME_UNIT_DEFAULT_MINUTES,refreshIntervalUnit:c.DASHBOARD_REFRESH_INTERVAL_UNIT,showTitleBar:c.DASHLET_SHOW_TITLE_BAR,showRefreshButton:c.DASHLET_SHOW_REFRESH_BUTTON,showMaximizeButton:c.DASHLET_SHOW_MAXIMIZE_BUTTON}),validation:s.extend({},l.prototype.validation,{scaleToFit:[{required:!0,msg:new u("dashboard.component.error.scale.to.fit.required")},{oneOf:[1,p.HEIGHT,p.WIDTH,p.CONTAINER],msg:new u("dashboard.component.error.scale.to.fit.oneOf",i["dashboard.component.dialog.properties.scale.to.fit.no"],i["dashboard.component.dialog.properties.scale.to.fit.width"],i["dashboard.component.dialog.properties.scale.to.fit.height"],i["dashboard.component.dialog.properties.scale.to.fit.page"])}],refreshInterval:[{required:!0,msg:new u("dashboard.error.report.refreshInterval.required")},{integerNumber:!0,msg:new u("dashboard.error.report.refreshInterval.integer")},{fn:function(e,r,t){var a=t.refreshIntervalUnit,o={second:c.DASHLET_REFRESH_INTERVAL_TIME_UNIT_SECONDS,minute:c.DASHLET_REFRESH_INTERVAL_TIME_UNIT_MINUTES};return e<o[a]?"Value must be bigger than "+o[a]:void 0},msg:new u("dashboard.error.report.refreshInterval.min",c.DASHLET_REFRESH_INTERVAL_TIME_UNIT_MINUTES,c.DASHLET_REFRESH_INTERVAL_TIME_UNIT_SECONDS)}],refreshIntervalUnit:[{required:!0,msg:new u("dashboard.error.report.refreshIntervalUnit.required")},{oneOf:["second","minute"],msg:new u("dashboard.error.report.refreshIntervalUnit.oneOf",i["dashboard.dialog.properties.refresh.interval.second"],i["dashboard.dialog.properties.refresh.interval.minute"])}]}),initialize:function(){this.paramsDfd=new o.Deferred,this.componentInitializedDfd=new o.Deferred,l.prototype.initialize.apply(this,arguments),this.set("dataSourceUri",this._getDataSourceUri()),this.on("change:autoRefresh",function(){this.get("autoRefresh")||this.isValid(["refreshInterval","refreshIntervalUnit"])||this.set({refreshInterval:this.defaults.refreshInterval,refreshIntervalUnit:this.defaults.refreshIntervalUnit})},this)},getReportResourceUri:function(){return this.componentInitializedDfd.resolve(this.resource.resource.get("uri")).promise()},_getDataSourceUri:function(){return this.resource&&this.resource.resource&&this.resource.resource.get("uri")||this.get("dataSourceUri")},_getWiringMetadata:function(){var e=this;if("pending"===this.paramsDfd.state()&&!this.paramsDfd._running)if(this.get("parameters"))n.debug("Loaded parameters from previous loaded state for "+this.resource.get("name")),this.paramsDfd.resolve(this,a(this,this.get("parameters")));else{this.paramsDfd._running=!0,n.debug("Started loading of parameters for "+e.resource.get("name"));var r=this.getReportResourceUri().fail(s.bind(this.paramsDfd.reject,this.paramsDfd)),t=f.getReportParameters(this.resource.resource.get("uri")).fail(s.bind(this.paramsDfd.reject,this.paramsDfd)).done(function(r){n.debug("Finished loading of parameters for "+e.resource.get("name")),e.set("parameters",s.map(r,function(e){return{id:e.id,uri:e.uri,label:e.label}}))});o.when(r,t).then(function(r,t){e.paramsDfd.resolve(e,a(e,t))})}return this.paramsDfd.promise()}})});