define(["require","common/model/RepositoryResourceModel","dashboard/collection/DashboardFoundationCollection","dashboard/collection/DashboardResourceCollection","./DashboardResourceModel","./DashboardWiringModel","dashboard/model/DashboardFoundationModel","../factory/dashboardComponentModelFactory","./component/PropertiesDashboardComponentModel","../collection/DashboardComponentCollection","../collection/ReportsParametersCollection","dashboard/enum/dashboardResourceTypes","dashboard/enum/dashboardComponentTypes","common/enum/repositoryResourceTypes","common/enum/errorCodes","dashboard/enum/dashboardResourceReferenceTypes","common/validation/ValidationErrorMessage","bundle!DashboardBundle","json3","jquery","underscore"],function(e){function o(e,o){var t=v.where(e,{type:l.INPUT_CONTROL}),n=v.reduce(t,function(e,o){return(e[o.ownerResourceId]||(e[o.ownerResourceId]=[])).push(o),e},{});v.each(v.keys(n),function(e){d.add({reportUri:o[e]},{full:!!v.findWhere(n[e],{fullCollectionRequired:!0}),knownIds:v.pluck(n[e],"ownerResourceParameterName")})})}var t=e("common/model/RepositoryResourceModel"),n=e("dashboard/collection/DashboardFoundationCollection"),r=e("dashboard/collection/DashboardResourceCollection"),s=e("./DashboardResourceModel"),a=e("./DashboardWiringModel"),i=(e("dashboard/model/DashboardFoundationModel"),e("../factory/dashboardComponentModelFactory")),u=e("./component/PropertiesDashboardComponentModel"),c=e("../collection/DashboardComponentCollection"),d=e("../collection/ReportsParametersCollection").instance,h=e("dashboard/enum/dashboardResourceTypes"),l=e("dashboard/enum/dashboardComponentTypes"),m=e("common/enum/repositoryResourceTypes"),p=e("common/enum/errorCodes"),g=e("dashboard/enum/dashboardResourceReferenceTypes"),f=e("common/validation/ValidationErrorMessage"),C=e("bundle!DashboardBundle"),b=e("json3"),y=e("jquery"),v=e("underscore");return t.extend({type:m.DASHBOARD,defaults:v.extend({},t.prototype.defaults,{label:C["dashboard.new.dashboard"],defaultFoundation:void 0,resources:void 0,foundations:void 0}),validation:v.extend({},t.prototype.validation,{label:[{required:!0,msg:new f("dashboard.error.label.required")},{maxLength:t.LABEL_MAX_LENGTH,msg:new f("dashboard.error.label.maxLength",t.LABEL_MAX_LENGTH)},{doesNotContainSymbols:t.LABEL_NOT_SUPPORTED_SYMBOLS,msg:new f("dashboard.error.label.doesNotContainSymbols",t.LABEL_NOT_SUPPORTED_SYMBOLS)}],description:[{required:!1},{maxLength:t.DESCRIPTION_MAX_LENGTH,msg:new f("dashboard.error.description.maxLength",t.DESCRIPTION_MAX_LENGTH)},{doesNotContainSymbols:t.DESCRIPTION_NOT_SUPPORTED_SYMBOLS,msg:new f("dashboard.error.description.doesNotContainSymbols",t.DESCRIPTION_NOT_SUPPORTED_SYMBOLS)}],parentFolderUri:[{required:!0,msg:new f("dashboard.error.parentFolderUri.required")}]}),initialize:function(){t.prototype.initialize.apply(this,arguments),this.resources=new r,this.foundations=new n,this.listenTo(this.foundations,"add",this._onFoundationAdd),this.listenTo(this.foundations,"addComponent",this._onComponentAdd),this.listenTo(this.foundations,"removeComponent",this._onComponentRemove),this.listenTo(this.foundations,"addComponent removeComponent moveComponent resizeComponent",this._onLayoutChange),this.listenTo(this.foundations,"changeProperties changedControlProperties",this._onComponentChange),this.listenTo(this.foundations,"changeWiring",this._onWiringChange),this.on("change:defaultFoundation",this._onDefaultFoundationChange),this._initDefaultFoundation()},resetToInitialCondition:function(){var e=this.currentFoundation;this.set(v.omit(this.defaults,"defaultFoundation")),e.wiring.set([]),e.wiring.handlers={},e.components.set([]),e.components.add(new u),this.resources.set([this.resources.get(e.get("wiring")),this.resources.get(e.get("layout")),this.resources.get(e.get("components"))])},fetch:function(e){e||(e={}),v.defaults(e,{expanded:!0});var o=t.prototype.fetch.call(this,e),n=new y.Deferred,r=this;return o.done(function(){if(r.type!==m.DASHBOARD){var e={status:400,responseText:b.stringify({message:"Resource '"+r.get("uri")+"' is not of type '"+m.DASHBOARD+"'",errorCode:p.INVALID_RESOURCE_TYPE,parameters:[r.type]})};return r.set(v.omit(r.defaults,"defaultFoundation","foundations","resources")),r.trigger("error",r,e),void n.reject(e)}r.trigger("rawDataFetched",r),r.updateResourceCollection();var o=r.resources.chain().filter(function(e){return e.resource&&e.resource.fetchContent}).map(function(e){return e.resource.fetchContent()}).value();y.when.apply(y,o).done(function(){r.trigger("resourcesDataFetched",r),r.updateFoundationCollection(),r.currentFoundation.startLoadingSequence(),n.resolve()})}).fail(n.reject),n},toJSON:function(e){this.foundations.map(v.bind(this._onWiringChange,this,null));var o=t.prototype.toJSON.apply(this,arguments);return o.foundations=this.foundations.toJSON(),o.resources=this.resources.toJSON(e),o},_initDefaultFoundation:function(){var e=this.foundations.addDefaultFoundation();e.components.add(new u),this.set("defaultFoundation",this.foundations.getDefaultFoundation().get("id"))},_onDefaultFoundationChange:function(){this.currentFoundation!==this.foundations.get(this.get("defaultFoundation"))&&(this.currentFoundation=this.foundations.get(this.get("defaultFoundation")))},_onComponentAdd:function(e,o){var t=this.resources.get(o.get("components"));t.resource.setContent(o.components.toJSON());var n=e.resource;n&&!this.resources.get(n.id)&&this.resources.add(n)},_onComponentChange:function(e,o){var t=this.resources.get(o.get("components"));t.resource.setContent(o.components.toJSON())},_onComponentRemove:function(e,o){var t=this.resources.get(o.get("components"));t.resource.setContent(o.components.toJSON());var n=e.resource,r=!1;n&&(this.foundations.forEach(function(o){o.components.forEach(function(o){o!==e&&o.resource===n&&(r=!0)})}),r||this.resources.remove(n))},_onLayoutChange:function(e,o){var t=this.resources.get(o.get("layout"));t.resource.setContent(o.components.toHTML())},_onWiringChange:function(e,o){var t=this.resources.get(o.get("wiring"));t.resource.setContent(o.wiring.toJSON())},_onFoundationAdd:function(e){var o={};o[g.FILE]={label:e.get("components")};var t={};t[g.FILE]={label:e.get("layout")};var n={};n[g.FILE]={label:e.get("wiring")};var r=this.resources.add(new s({name:e.get("components"),type:h.COMPONENTS,resource:o},{contextPath:this.contextPath}));r.resource.setContent(e.components.toJSON());var a=this.resources.add(new s({name:e.get("layout"),type:h.LAYOUT,resource:t},{contextPath:this.contextPath}));a.resource.setContent(e.components.toHTML());var i=this.resources.add(new s({name:e.get("wiring"),type:h.WIRING,resource:n},{contextPath:this.contextPath}));i.resource.setContent(e.wiring.toJSON())},updateResourceCollection:function(){this.resources.set(this.get("resources"),{merge:!0,remove:!0,add:!0})},updateFoundationCollection:function(){var e=this;this.foundations.set(this.get("foundations"),{merge:!0,remove:!0,add:!0}),this.foundations.forEach(function(t){var n,r=e.resources.get(t.get("components")),s=e.resources.get(t.get("layout")),u=e.resources.get(t.get("wiring")),d=new c;u&&u.resource&&u.resource.content&&v.isArray(u.resource.content)&&(n=v.clone(u.resource.content)),r&&r.resource&&r.resource.content&&v.isArray(r.resource.content)&&(o(r.resource.content,e.resources.reduce(function(e,o){return e[o.id]=o.resource.get("uri"),e},{})),v.forEach(r.resource.content,function(o){d.add(i(o,{resource:e.resources.get(o.resource),collection:t.components}))}),s&&s.resource&&d.setPositionFromHtml(s.resource.content),t.components.set(d.models,{merge:!0,remove:!0,add:!0})),n&&(t.wiring.set(v.map(n,function(e){return new a(v.omit(e,"consumers"),{component:t.components.get(e.component),consumers:e.consumers})})),v.each(n,function(e){t.wiring.get(e.producer).consumers.set(e.consumers)}))})},clone:function(){var e=new this.constructor;return e.applyJsonState(this.toJSON(!0)),e},applyJsonState:function(e){var o={};v.each(e.resources,function(e){"file"in e.resource&&(o[e.name]=e.resource.file.content,delete e.resource.file.content)}),this.set(e),v.each(e.resources,function(e){e.name in o&&(e.resource.file.content=o[e.name])}),this.updateResourceCollection(),this.resources.forEach(function(e){e.get("name")in o&&e.resource.set("content",o[e.get("name")])}),this.updateFoundationCollection()}})});