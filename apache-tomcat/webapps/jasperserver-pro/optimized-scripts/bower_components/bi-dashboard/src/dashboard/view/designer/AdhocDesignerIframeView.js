define(["require","exports","module","underscore","backbone","jquery","../../dashboardSettings","dashboard/model/component/DashboardComponentModel","text!dashboard/template/adhocDesignerIframeTemplate.htm","dashboard/enum/dashboardComponentTypes","common/model/RepositoryResourceModel","dashboard/factory/addDashboardComponentDialogTemplateFactory","common/component/dialog/Dialog","common/view/ViewWithRivets","dashboard/view/designer/AddDashboardComponentDialogController","../../dashboardMessageBus","../../enum/dashboardMessageBusEvents","common/component/notification/Notification","logger"],function(e,o,i){var t=e("underscore"),n=e("backbone"),s=e("jquery"),a=e("../../dashboardSettings"),r=e("dashboard/model/component/DashboardComponentModel"),d=e("text!dashboard/template/adhocDesignerIframeTemplate.htm"),h=e("dashboard/enum/dashboardComponentTypes"),l=e("common/model/RepositoryResourceModel"),m=(e("dashboard/factory/addDashboardComponentDialogTemplateFactory"),e("common/component/dialog/Dialog"),e("common/view/ViewWithRivets"),e("dashboard/view/designer/AddDashboardComponentDialogController")),c=e("../../dashboardMessageBus"),g=e("../../enum/dashboardMessageBusEvents"),p=e("common/component/notification/Notification"),D=(e("logger").register(i),l.extend({initialize:function(e,o){o||(o={}),this.constructor.__super__.initialize.apply(this,arguments),this.set("label",""),"ichart"===this.get("type")||"olap_ichart"===this.get("type")?this.set("type",h.CHART):"olap_crosstab"===this.get("type")&&this.set("type",h.CROSSTAB),this.collection=o.dashletCollection,this.validation.label=r.prototype.validation.name}}));return n.View.extend({el:t.template(d),events:{load:"_onIframeLoad"},initialize:function(){t.bindAll(this,"_onWindowResize","_onDesignerCancel","_onDesignerSave"),s(window).on("resize",this._onWindowResize)},render:function(){var e=s("body"),o=e.find("> #banner").outerHeight(!0);return this._addDimmer(),e.append(this.$el),this.$el.attr("src",this.model.getDesignerUri()).css({top:o+"px",height:e.find("> #frame").height()-o+"px",width:e.width()-2*a.DASHBOARD_ADHOC_IFRAME_MARGIN,"background-color":e.css("background-color"),"z-index":a.DASHBOARD_ADHOC_IFRAME_Z_INDEX}).show(),this},_onIframeLoad:function(){var e=this._getFrame();if(e.location.href.indexOf("login.html")>-1)c.trigger(g.SESSION_EXPIRED);else if(e&&e.jQuery){var o=e.jQuery(e.document);o.off("adhocDesigner:cancel errorPage:close").on("adhocDesigner:cancel errorPage:close",this._onDesignerCancel),o.off("adhocDesigner:save").on("adhocDesigner:save",s.proxy(this._onConfirmDesignerSave,this)),o.off("adhocDesigner:saved").on("adhocDesigner:saved",s.proxy(this._onDesignerSave,this)),o.off("adhocDesigner:notification").on("adhocDesigner:notification",s.proxy(this._onDesignerNotification,this))}},_onDesignerCancel:function(){this.trigger("close",this),this._hideDimmer()},_onDesignerNotification:function(e,o,i){this.notification=this.notification?this.notification:new p,this.notification.show({message:o,delay:i,type:"success"})},_hideDimmer:function(){this.$dimmer.addClass("hidden").hide()},_addDimmer:function(){s(".dashboard.dimmer").length?!this.$dimmer&&(this.$dimmer=s(".dashboard.dimmer")):(this.$dimmer=s("<div class='dashboard dimmer hidden' style='z-index:"+a.DASHBOARD_DIMMER_Z_INDEX+"; display: none;'></div>"),s("body").append(this.$dimmer));var e=parseInt(this.$el.css("zIndex"));e>0&&this.$dimmer.css("zIndex",e-1),this.$dimmer.removeClass("hidden").show()},_onDesignerSave:function(e,o){o.label=this.model.get("name"),this.trigger("save",this,o)},_onConfirmDesignerSave:function(e,o){if(this.model.isNew()){var i=new D(o,{dashletCollection:this.model.collection});this.addComponentDialogController=new m(i,{okButtonLabel:"button.save",okButtonDisabled:!0,overElement:this.$el}),this.addComponentDialogController.dialog.open(),this.listenTo(this.addComponentDialogController.dialog,"button:ok",function(){i.isValid()&&(this.model.set("name",i.get("label")),this._postMessageToDesigner("adhocDesigner:save"),this.addComponentDialogController.closeAndRemove())},this),this.listenTo(this.addComponentDialogController.dialog,"button:cancel",function(){this.addComponentDialogController.dialog.close(),this._addDimmer()},this)}else this._postMessageToDesigner("adhocDesigner:save")},_postMessageToDesigner:function(e){this.$el[0].contentWindow.postMessage(e,"*")},_onWindowResize:function(){var e=s("body"),o=e.find("> #banner").outerHeight(!0);this.resizeTimer&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(t.bind(function(){this.$el.height(e.find("> #frame").height()-o),this.$el.width(e.width()-2*a.DASHBOARD_ADHOC_IFRAME_MARGIN)},this),100)},_getFrame:function(){return s(this.$el)[0].contentWindow},detachEvents:function(){var e=this._getFrame();if(s(window).off("resize",this._onWindowResize),e&&e.jQuery){var o=e.jQuery(e.document);o.off("adhocDesigner:cancel errorPage:close").off("adhocDesigner:save")}},hide:function(){this.$el.hide()},removeSubComponents:function(){this.addComponentDialogController&&this.addComponentDialogController.remove(),this.$dimmer&&this.$dimmer.remove()},remove:function(){this.detachEvents(),this.removeSubComponents(),n.View.prototype.remove.apply(this,arguments)}})});