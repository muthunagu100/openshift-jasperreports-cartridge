define(["require","exports","module","jquery","underscore","backbone","common/util/browserDetection","./view/viewer/ViewerToolbarView","./view/viewer/ViewerCanvasView","./model/DashboardModel","bundle!DashboardBundle","logger","css!dashboard/viewer.css"],function(e,o,t){var n=e("jquery"),i=e("underscore"),s=e("backbone"),a=e("common/util/browserDetection"),r=e("./view/viewer/ViewerToolbarView"),d=e("./view/viewer/ViewerCanvasView"),h=e("./model/DashboardModel"),l=e("bundle!DashboardBundle"),c=e("logger").register(t);return e("css!dashboard/viewer.css"),s.View.extend({constructor:function(e){if(e||(e={}),!e.el||!n(e.el)[0]||!n(e.el)[0].tagName)throw new Error("Container for Dashboard is not specified");this.model=new h({},{contextPath:e.contextPath}),this.dashboardId=this._generateDashboardId(),s.View.apply(this,arguments)},initialize:function(){this.toolbar=new r({model:this.model}),this.canvas=new d({model:this.model,dashboardId:this.dashboardId}),this.listenTo(this.model,"error:all",this._onAllModelErrors),this.render(),i.bindAll(this,"_onUnload"),window.onpagehide||null===window.onpagehide?n(window).on("pagehide",this._onUnload):n(window).on("unload",this._onUnload),this._startHistory(),this._initPreventTextSelection("#banner","#frame")},render:function(){return this.$el.empty(),this.$el.append(this.toolbar.render().el),this.$el.append(this.canvas.render().el),this},_onAllModelErrors:function(e,o,t){var n=l["dashboard.canvas.error."+o.errorCode]||l[404===t.status?"dashboard.canvas.error.not.found":"dashboard.canvas.error.unexpected.error"];this.canvas.showMessage(n)},_startHistory:function(){this.history=new s.History,this.history.route(/.*/,i.bind(this._onLocationHashChange,this)),this.history.start()},_loadModelByUri:function(e){var o=this;try{e=decodeURIComponent(e)}catch(t){c.error(t),e=void 0}e&&0!==e.indexOf("/")&&(e="/"+e),e!=this.model.get("uri")&&(this.model.resetToInitialCondition(),e?(this.hideMessageBox(),this.model.set({uri:e}),this.model.fetch().done(function(){o.canvas.componentViews.length&&n.when.apply(n,i.pluck(o.canvas.componentViews,"ready")).then(function(){o.canvas.ready.resolve()}),o.canvas.model&&o.canvas.enableAutoRefresh()}).fail(function(){o.model.currentFoundation.startLoadingSequence()}).always(function(){o.state&&o.state.init()})):(this.showInitialMessage(),this.model.currentFoundation.startLoadingSequence(),this.state&&this.state.init()))},_onUnload:function(){this.canvas.remove()},_initPreventTextSelection:function(){var e=Array.prototype.slice.call(arguments,0).join(",");(a.isIE8()||a.isIE9())&&n(e).on("selectstart",function(e){var o=e.target.tagName;return"INPUT"!=o&&"TEXTAREA"!=o?!1:void 0})},_generateDashboardId:function(){return this.model.cid},getDashboardId:function(){return this.dashboardId},showInitialMessage:function(){this.canvas.showMessage(l["dashboard.canvas.error.not.found"])},hideMessageBox:function(){this.canvas.hideMessage()},_onLocationHashChange:function(e){this._loadModelByUri(e)},remove:function(){this.history.stop(),n(window).off("pagehide unload"),this.canvas.remove(),this.toolbar.remove(),s.View.prototype.remove.apply(this,arguments)}})});