define(["require","jquery","underscore","dashboard/dashboardSettings","dashboard/dashboardMessageBus","dashboard/enum/dashboardMessageBusEvents","./BasicHelper","jquery.ui"],function(e){var i=e("jquery"),t=e("underscore"),s=e("dashboard/dashboardSettings"),a=e("dashboard/dashboardMessageBus"),n=e("dashboard/enum/dashboardMessageBusEvents"),o=e("./BasicHelper");return e("jquery.ui"),o.extend({init:function(e){var a=this;this.container=e,t.bindAll(this,"_onWindowResize"),i(window).on("resize",this._onWindowResize),this.listenTo(this.strategy.model.currentFoundation.components.getDashboardPropertiesComponent(),"change:dashletMargin",function(){a.container.find("["+s.COMPONENT_ID_ATTRIBUTE+"]").each(function(){a._fixResizeHandlePositions(i(this))})}),this.listenTo(this.strategy.model.foundations,"addComponent moveComponent",function(e){t.defer(function(){var i=a.container.find("["+s.COMPONENT_ID_ATTRIBUTE+"="+e.id+"]");i.length&&a._initResizable(i)})}),this.listenTo(this.strategy.model.foundations,"removeComponent",function(e){a._destroyResizable(a.container.find("["+s.COMPONENT_ID_ATTRIBUTE+"="+e.id+"]"))}),this.container.find("["+s.COMPONENT_ID_ATTRIBUTE+"]").each(function(){a._initResizable(i(this))})},deinit:function(){var e=this;this.container.find("["+s.COMPONENT_ID_ATTRIBUTE+"]").each(function(){e._destroyResizable(i(this))}),i(window).off("resize",this._onWindowResize)},_onWindowResize:function(e){if(!e.target.tagName){var t=this;this.resizeTimer&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(function(){var e=t.strategy.gridSize(t.container);t.container.find("["+s.COMPONENT_ID_ATTRIBUTE+"]").each(function(){i(this).is(".ui-resizable")&&i(this).resizable("option",{minWidth:Math.floor(e.x),minHeight:Math.floor(e.y),grid:[Math.floor(e.x),Math.floor(e.y)]})})},300)}},_onDashletResizeStart:function(e){var t=i(e.target),a=t.attr(s.COMPONENT_ID_ATTRIBUTE),n=this.strategy.model.currentFoundation.components.get(a).getPositionObject(),o=this.strategy.gridSize(this.container),r=this.strategy.calculateEmptyArea(n,a),h=n.height,d=n.width,l=i(e.toElement||e.originalEvent.target);this.strategy.model.currentFoundation.components.selectComponent(a),(l.hasClass("ui-resizable-w")||l.hasClass("ui-resizable-nw")||l.hasClass("ui-resizable-sw"))&&(d=n.x+n.width-r.x),(l.hasClass("ui-resizable-e")||l.hasClass("ui-resizable-ne")||l.hasClass("ui-resizable-se"))&&(d=r.x+r.width-n.x),(l.hasClass("ui-resizable-n")||l.hasClass("ui-resizable-ne")||l.hasClass("ui-resizable-nw"))&&(h=n.y+n.height-r.y),(l.hasClass("ui-resizable-s")||l.hasClass("ui-resizable-se")||l.hasClass("ui-resizable-sw"))&&(h=r.y+r.height-n.y),t.resizable("option",{maxHeight:Math.ceil(h*o.y),maxWidth:Math.ceil(d*o.x)})},_onDashletResizeStop:function(e,t){var o=i(e.target).attr(s.COMPONENT_ID_ATTRIBUTE),r=this.strategy.model.currentFoundation.components.get(o),h=this.strategy.gridSize(this.container),d={x:Math.round(t.position.left/h.x),y:Math.round(t.position.top/h.y),width:Math.round(t.size.width/h.x),height:Math.round(t.size.height/h.y)};this.strategy.updateLayout(o,d),(r.hasChanged("width")||r.hasChanged("height"))&&a.trigger(n.SAVE_DASHBOARD_STATE),t.element.css(r.getCssPosition())},_initResizable:function(e){var i=this.strategy.gridSize(this.container);this._destroyResizable(e),e.resizable({handles:"all",containment:"parent",minWidth:Math.floor(i.x),minHeight:Math.floor(i.y),grid:[Math.floor(i.x),Math.floor(i.y)],start:t.bind(this._onDashletResizeStart,this),stop:t.bind(this._onDashletResizeStop,this)}).on("resize",function(e){e.stopPropagation()}),this._fixResizeHandlePositions(e)},_destroyResizable:function(e){try{e.resizable("destroy")}catch(i){}},_fixResizeHandlePositions:function(e){var i=this.strategy.model.currentFoundation.components.getDashboardPropertiesComponent().get("dashletMargin")-3;e.find(".ui-resizable-n, .ui-resizable-ne, .ui-resizable-nw").css({top:i+"px"}),e.find(".ui-resizable-e, .ui-resizable-se, .ui-resizable-ne").css({right:i+"px"}),e.find(".ui-resizable-s, .ui-resizable-se, .ui-resizable-sw").css({bottom:i+"px"}),e.find(".ui-resizable-w, .ui-resizable-sw, .ui-resizable-nw").css({left:i+"px"})}})});