dd.display={PAGE:"design",LEFT_TREE_TEMPLATE_DOM_ID:"list_responsive_collapsible_type_tables",RIGHT_TREE_TEMPLATE_DOM_ID:"list_responsive_collapsible_type_sets",TREE_DRAG_PATTERN:".draggable",JOINS_TREE_ID:"joinsTree",TABLES_TREE_ID:"tablesTree",VIEW_TREE_ID:"viewTree",JOINS_TREE_DATA_PROVIDER:"joinTreeDataProvider",TABLES_TREE_DATA_PROVIDER:"selectedTreeDataProvider",VIEW_TREE_DATA_PROVIDER:"selectedViewTreeDataProvider",RESOURCE_VIEW_MODES:{JOIN_TREE:"joinTree",TABLES_TREE:"tablesTree"},TAB_JOIN_TREE_VIEW_ID:"joinTreeView",TAB_TABLES_LIST_VIEW_ID:"tableListView",ADD_ITEM_ID:"add",ADD_ITEM_TO_SET_ID:"addToSet",DELETE_ITEM_ID:"deleteItem",DELETE_TABLE_ID:"deleteTable",NEW_SET_ID:"newSet",MOVE_TO_TOP_ID:"toTop",MOVE_UPWARD_ID:"upward",MOVE_TO_BOTTOM_ID:"toBottom",MOVE_DOWNWARD_ID:"downward",DONE_BUTTON_ID:"done",DEFAULT_SET_ID:"newSet",CREATE_NEW_SET_ID:"#newSet",RESOURCES_CONTAILNER_ID:"resourcesBody",SETS_CONTAILNER_ID:"setsAndItemsBody",DOM_ID_TO_SAVE_SELECTED_NODES:["#add","#addToSet","#deleteTable","#newSet","#deleteItem","#toTop","#upward","#downward","#toBottom","#joinTreeView","#tableListView","#properties","#joinsTree","#tablesTree","#viewTree"],joinsTree:null,tablesTree:null,viewTree:null,copyMoveController:new domain.NodeCopyMoveController,resourceViewMode:null,dontWarnOfDeleteItems:!0,islands:null,joinTreeModel:null,usedTablesByItemId:null,dataSourceId:null,designerMode:null,changeOrderController:new domain.DisplayNodeChangeOrderController,getCheckDesignValidator:function(){return this.checkDesignValidator},getValidationPostData:function(){return{page:this.PAGE,selectedModel:this.getTreeModel(this.tablesTree),islands:Object.toJSON(this.islands),selectedView:this.getTreeModel(this.viewTree)}},getTreeModel:function(e){for(var t=e.getRootNode().childs,i=[],r=0;r<t.length;r++)t[r]._markAsDeleted!==!0&&i.push(t[r]);return Object.toJSON(i)},fillForm:function(){$("islands").writeAttribute("value",Object.toJSON(this.islands)),$("selectedView").writeAttribute("value",this.getTreeModel(this.viewTree)),$("dontWarnOfDeleteItems").writeAttribute("value",this.dontWarnOfDeleteItems),$("selectedModel").writeAttribute("value",this.getTreeModel(this.tablesTree)),$("unsavedChangesPresent").writeAttribute("value",dd.isUnsavedChangesPresent().toString())},exportEnabled:function(){return this.viewTree&&this.viewTree.getRootNode()&&!!this.viewTree.getRootNode().childs.first()},exportBundleStub:function(){var e=jQuery.Deferred(),t=function(){e.resolve(),this.viewTreeLoadCallback()}.bind(this),i=function(){this.viewTree.showTree(100,t,domain.treeErrorHandler)}.bind(this),r=function(t,r){dd.generateAndDownloadBundles.bind(dd)(t,r,i,e)};dd.exportBundlesValidator.validate(r)},initFromOptions:function(e){this.joinTreeModel=e.joinTreeModel,this.designerMode=e.designerMode,this.usedTablesByItemId=e.usedTablesByItemId,this.dataSourceId=e.dataSourceId},init:function(e){this.initFromOptions(e),dd.calcFieldsAndFiltersValidator.init(dd.validateForCalcFields.bind(dd),dd.getTablesUsedForFilters.bind(dd,this.usedTablesByItemId[this.dataSourceId])),domain.resetTreeSelectionHandler.init(this.DOM_ID_TO_SAVE_SELECTED_NODES,function(){return[this.tablesTree,this.viewTree,this.joinsTree]}.bind(this),this.updateButtonsState.bind(this),this.deselectNodesValidator.bind(this)),domain.registerClickHandlers([this.changeResourceViewModeClickHandler.bind(this),this.moveButtonsClickEventHandler.bind(this),this.createNewSetClickEventHandler.bind(this),this.addDeleteItemsClickEventHandler.bind(this)]),dd_display.deleteViewItemValidator.init(this.designerMode,this.isDontWarnOfDeleteItems.bind(this),this.setDontWarnOfDeleteItems.bind(this),this.buildCompositeIdentifier),dd_display.addViewItemsValidator.init(domain.getDataIslandId),dd_display.checkDesignValidator.init(this.refreshViewTreeStyle.bind(this)),dd_display.emptySetsValidator.init(this.getViewTree.bind(this),this.copyMoveController),this.propertiesEditor.init(e.defaultMasks,e.typesMap),this.initTrees(),propsEditor.hide()},initTrees:function(){this.tablesTree=domain.createItemsTree({treeId:this.TABLES_TREE_ID,providerId:this.TABLES_TREE_DATA_PROVIDER,templateDomId:this.LEFT_TREE_TEMPLATE_DOM_ID,nodeClass:domain.TablesNode}),this.joinsTree=domain.createItemsTree({treeId:this.JOINS_TREE_ID,providerId:this.JOINS_TREE_DATA_PROVIDER,templateDomId:this.LEFT_TREE_TEMPLATE_DOM_ID,dragPattern:dd.TREE_DRAG_PATTERN,nodeClass:domain.TablesNode,selectOnMousedown:!0}),this.viewTree=domain.createItemsTree({treeId:this.VIEW_TREE_ID,providerId:this.VIEW_TREE_DATA_PROVIDER,templateDomId:this.RIGHT_TREE_TEMPLATE_DOM_ID,dragPattern:dd.TREE_DRAG_PATTERN,nodeClass:domain.DisplayNode,selectOnMousedown:!0}),this.viewTree.createDraggableIfNeeded=function(e,t){this._overNode=t,dynamicTree.Tree.prototype.createDraggableIfNeeded.call(this,e,t)},this.viewTree.sorters=[this.sortByType,this.viewTree.sortByOrder,this.viewTree.sortByName],$H(this.treeEventFactory).each(function(e){[this.tablesTree,this.joinsTree,this.viewTree].invoke("observe",e.key,e.value.bindAsEventListener(this))}.bind(this)),this.initDragAndDrop(),this.tablesTree.showTree(1,this.tablesTreeLoadCallback.bind(this),domain.treeErrorHandler),this.joinsTree.showTree(2,this.joinsTreeLoadCallback.bind(this),domain.treeErrorHandler),this.viewTree.showTree(100,this.viewTreeLoadCallback.bind(this),domain.treeErrorHandler)},sortByType:function(e,t){var i=e.param.type,r=t.param.type;return r>i?1:i>r?-1:0},initDragAndDrop:function(){var e=[this.JOINS_TREE_ID,this.TABLES_TREE_ID,this.RESOURCES_CONTAILNER_ID,this.VIEW_TREE_ID,this.SETS_CONTAILNER_ID],t=function(e,t){var i=e.node;if(i){var r=dynamicTree.trees[i.getTreeId()],a=matchAny(t,["#"+this.RESOURCES_CONTAILNER_ID],!0)?this.joinsTree:this.viewTree;if(r!==a)if(r===this.viewTree){var d=this.viewTree.selectedNodes;this.canDeleteTreeItems(d)&&this.deleteItemsFromViewTree(d,this.successDeleteTreeItemsCallback.bind(this))}else{var s=this.viewTree._overNode;if(s){if(!s.isParent())for(;!s.isParent();)s=s.parent}else s=this.viewTree.getRootNode();d=this.joinsTree.selectedNodes,this.canDeleteTreeItems(d)&&this.addItemsToViewTree(d,s),this.viewTree._overNode=null}}}.bind(this);e.each(function(e){Droppables.remove(e),Droppables.add(e,{accept:["draggable","wrap"],onDrop:t})})},tablesTreeLoadCallback:function(){this.resourceViewMode=this.RESOURCE_VIEW_MODES.JOIN_TREE,$(this.TABLES_TREE_ID).addClassName(layoutModule.HIDDEN_CLASS),dd.createTreeNodesMap(this.tablesTree),this.updateButtonsState()},joinsTreeLoadCallback:function(){this.islands=this.createIslands(this.joinsTree.getRootNode()),dd.createTreeNodesMap(this.joinsTree),this.updateButtonsState()},viewTreeLoadCallback:function(){dd.createTreeNodesMap(this.viewTree),this.buildJoinTreeModelMap(),this.updateButtonsState(),this.setOriginalItemId(this.viewTree.getRootNode())},getFullNodePath:function(e){for(var t=e,i=[t.param.extra.originalItemId];t=t.parent;)t.param.extra&&i.push(t.param.extra.originalItemId);return i.reverse(),i.join(".")},setOriginalItemId:function(e){e.param.extra&&(e.param.extra.originalItemId=e.param.extra.itemId),e.childs&&_.each(e.childs,function(e){dd_display.setOriginalItemId(e)})},getItemTypeNodesRecursively:function(e){var t=[];return"ItemType"===e.param.type&&t.push(e),e.childs&&e.childs.length&&_.each(e.childs,function(e){t=t.concat(dd_display.getItemTypeNodesRecursively(e))}),t},isDontWarnOfDeleteItems:function(){return this.dontWarnOfDeleteItems},setDontWarnOfDeleteItems:function(){this.dontWarnOfDeleteItems=!1},getJoinTreeModelNodeId:function(e){return e.extra.itemId},getJoinsTreeNodeId:function(e){return e.param.extra.itemId},getViewTree:function(){return this.viewTree},buildJoinTreeModelMap:function(){if(this.joinTreeModel){this.joinTreeModel.treeMap={},this.joinTreeModel.viewTreeMap={};var e={},t=function(e,i){this.joinTreeModel.treeMap[i.id]=i,i.parent=e,i.children&&i.children.first()&&(i.isParent=!0,i.children.each(t.bind(this,i)))};this.joinTreeModel.children&&this.joinTreeModel.children.each(t.bind(this,this.joinTreeModel)),$H(this.joinTreeModel.treeMap).values().each(function(t){if(!t.isParent){var i=this.buildCompositeIdentifier(t,".",this.getJoinTreeModelNodeId,this.joinTreeModel);e[i]=t}}.bind(this)),this.viewTree.resourceIdMap={},$H(this.viewTree.treeMap).values().each(function(t){if(!t.isParent()){var i=t.param.extra.resourceId;e[i]&&(this.viewTree.resourceIdMap[i]=t,this.joinTreeModel.viewTreeMap[i]=e[i].id)}}.bind(this))}},deselectNodesValidator:function(){var e=propsEditor.submitEdit();return e&&propsEditor.hide(),e},changeResourceViewMode:function(e){if(this.resourceViewMode!==e.mode){if(!propsEditor.submitEdit())return buttonManager.unSelect(e.destTabId),void buttonManager.select(e.sourceTabId);var t=e.getSourceTree().selectedNodes.first();if(1===e.getSourceTree().selectedNodes.length&&propsEditor.view(t),$(e.sourceTreeId).addClassName(layoutModule.HIDDEN_CLASS),$(e.destTreeId).removeClassName(layoutModule.HIDDEN_CLASS),t){var i=$H(e.getDestTree().treeMap).values().find(function(e){return e.param.id===t.param.id});i&&(e.getDestTree()._deselectAllNodes(),e.getDestTree().openAndSelectNode(i.param.uri))}e.getDestTree()===this.joinsTree?propsEditor.hide():propsEditor.view(e.getDestTree().selectedNodes.first()),this.resourceViewMode=e.mode}},createIslands:function(e){var t=e.childs,i=[];return t.each(function(e){var t=e.childs.findAll(function(e){return e.isParent()}).collect(function(e){return e.param.id});t.length>0&&i.push({islandId:e.param.extra.itemId,tablesIds:t})}),i},buildCompositeIdentifier:function(e,t,i,r){for(var a=i(e),d=e.parent;d&&d!==r;)a=i(d)+t+a,d=d.parent;return a},updateViewTreeResorceIds:function(e,t){var i=this.joinTreeModel.treeMap[e],r=function(e,t,i){return i===e&&t?t:i.extra.itemId}.curry(i,t.param.extra.itemId);i.children.each(function(e){var i=this.buildCompositeIdentifier(e,".",this.getJoinTreeModelNodeId,this.joinTreeModel);delete this.joinTreeModel.treeMap[e.id],e.id=t.param.id+"."+e.extra.itemId,this.joinTreeModel.treeMap[e.id]=e;var a=this.buildCompositeIdentifier(e,".",r,this.joinTreeModel),d=this.viewTree.resourceIdMap[i];d&&(d.param.extra.resourceId=a,delete this.viewTree.resourceIdMap[i],this.viewTree.resourceIdMap[a]=d,delete this.joinTreeModel.viewTreeMap[i],this.joinTreeModel.viewTreeMap[a]=e.id)}.bind(this)),delete this.joinTreeModel.treeMap[i.id],i.id=t.param.id,this.joinTreeModel.treeMap[i.id]=i,i.extra.itemId=t.param.extra.itemId},changeNodeId:function(e,t,i){if(e){var r=e.param.id,a=dynamicTree.trees[e.getTreeId()];e.isParent()?(e.param.extra.originalId||(e.param.extra.originalId=e.param.extra.itemId),e.param.extra.itemId=t,e.name=t,e._getElement()&&(e._getTitle().data=t),e.param.id=e.param.extra.datasourceId+"."+e.param.extra.itemId,i&&this.updateViewTreeResorceIds(r,e)):(e.param.extra.originalId||(e.param.extra.originalId=e.parent.param.extra.originalId+"."+e.param.extra.itemId),e.param.id=e.parent.param.id+"."+e.param.extra.itemId);var d="/"===e.parent.param.uri;e.param.uri=d?"/"+e.param.id:e.parent.param.uri+"/"+e.param.id,delete a.treeMap[r],a.treeMap[e.param.id]=e}},updateExpressions:function(e){e&&e.first()&&e.each(function(e){for(var t in e)[this.tablesTree,this.joinsTree,this.viewTree].each(function(i){var r=i.treeMap[t];r&&(r.param.extra.expression=e[t])})}.bind(this))},changeNodeAlias:function(e,t,i){var r=e.param.id;e=this.tablesTree.treeMap[r];var a=e.param.extra.itemId,d=this.joinsTree.treeMap[r],s=function(r){return"error"===r?void(i&&i(!0)):(dd.setUnsavedChangesPresent(!0),this.updateExpressions(r.changesExpressions),[e,d].each(function(e,i){e&&(this.changeNodeId(e,t,0===i),e.childs.each(function(e){this.changeNodeId(e,t,0===i)}.bind(this)))}.bind(this)),void(i&&i(!0)))};return dd.changeTableAlias(a,t,s.bind(this)),!0},idExistsInTree:function(e,t){var i=e.treeMap;return!!$H(i).values().find(function(e){return e.param.extra.itemId===t||e.param.id===t})},createNode:function(e,t,i){var r=e.processNode(i);return t.addChild(r),r.isloaded=!0,e.treeMap[r.param.id]=r,r},getUniqueItemId:function(e,t){for(var i=1;this.idExistsInTree(e,t+i);)i++;return t+i},updateChildOrders:function(e){e.childs.first()&&(this.viewTree.resortSubtree(e),e.childs.each(function(e,t){e.orderNumber=t+1}),e.refreshNode())},addNewSet:function(){dd.setUnsavedChangesPresent(!0);var e=this.viewTree.selectedNodes.first();e?e.param.type!==e.Types.Folder.name&&(e=e.parent):e=this.viewTree.getRootNode();var t=this.getUniqueItemId(this.viewTree,this.DEFAULT_SET_ID),i=this.changeOrderController.findMaxSiblingNode(e.childs,!1,!1,e.Types.Folder.name),r=i?i.orderNumber:0,a=e===this.viewTree.getRootNode()?"/"+t:e.param.uri+"/"+t,d={id:t,label:t,type:e.Types.Folder.name,uri:a,order:r+1,extra:{itemId:t,originalItemId:t,label:t,descr:t,labelId:"",descrId:"",resourceId:""}},s=this.createNode(this.viewTree,e,d);return this.updateChildOrders(s.parent),s},canDeleteTreeItems:function(e){return sessionManager.resetSession(dd.flowExecutionKey),e&&e.first()&&propsEditor.submitEdit()},successDeleteTreeItemsCallback:function(){propsEditor.hide(),this.updateButtonsState()},getOrCreateJoinsTreeNode:function(e){var t=this.joinsTree.treeMap[e];if(t&&this.joinsTree.findNodeById(t.param.id))return t;var i,r=this.joinTreeModel.treeMap[e],a={id:r.id,label:r.extra.itemId,type:r.type,uri:r.uri,extra:deepClone(r.extra)};return i=r.parent===this.joinTreeModel?this.joinsTree.getRootNode():this.getOrCreateJoinsTreeNode(r.parent.id),this.createNode(this.joinsTree,i,a)},restoreItemToJoinsTree:function(e){delete this.viewTree.resourceIdMap[e];var t=this.joinTreeModel.viewTreeMap[e];t&&this.getOrCreateJoinsTreeNode(t)},updateNodeResourceId:function(e){if(e.isParent()&&e.parent){var t=e.childs.findAll(function(e){return!e.isParent()||""!==e.param.extra.resourceId}).length;t>0||(e.param.extra.resourceId="",e.parent!=this.viewTree.getRootNode()&&this.updateNodeResourceId(e.parent))}},deleteItemsFromViewTree:function(e,t){_.each(e,function(e){e._markAsDeleted=!0});var i=function(){dd.setUnsavedChangesPresent(!0);var i=function(e){e.parent.removeChild(e),this.updateChildOrders(e.parent),delete this.viewTree.treeMap[e.param.id],e.isParent()||this.restoreItemToJoinsTree(e.param.extra.resourceId)}.bind(this),r=function(e){e.isParent()&&e.childs.clone().each(function(e){r(e)}),i(e),this.updateNodeResourceId(e.parent)}.bind(this),a=function(e){e.clone().each(function(e){r(e)}),this.joinsTree.resortSubtree(this.joinsTree.getRootNode()),this.resourceViewMode==dd_display.RESOURCE_VIEW_MODES.JOIN_TREE&&this.joinsTree.renderTree(),t&&t()};dd_display.deleteViewItemValidator.validate(e,a.bind(this))},r=this;domain.designer.checkDesign(_.bind(function(t){if(_.each(e,function(e){e._markAsDeleted=!1}),"success"!==t&&t.errorMessage){var a=domainUtil.getUsedResourcesList(t.errorMessage,domain._messages.ITEM_BEING_USED_BY_RESOURCE),d=[];_.each(e,function(e){d=d.concat(dd_display.getItemTypeNodesRecursively(e))}),d=_.uniq(_.map(d,dd_display.getFullNodePath)),a=_.filter(a,function(e){return-1!==_.indexOf(d,e.field)}),a.length||domainUtil.indexOfNoAccessMessage(t.errorMessage,domain._messages.resourcesWithNoAccess)>-1?(jQuery("#dependentResourcesConfirmMessage").html(domainUtil.getUsedResourcesFormattedMessage(a,t.errorMessage,{"resource.label":domain._messages["resource.label"],"field.label":domain._messages["field.label"],ITEM_BEING_USED_BY_RESOURCE:domain._messages.ITEM_BEING_USED_BY_RESOURCE,resourcesWithNoAccess:domain._messages.resourcesWithNoAccess})),dd_display.makeConfirmDialogSizeable(),domain.confirmDialog.show("dependentResourcesConfirmMessage",function(){i.call(r),dd_display.makeConfirmDialogNotSizeable()},function(){dd_display.makeConfirmDialogNotSizeable()})):i.call(this)}else i.call(this)},this))},makeConfirmDialogSizeable:function(){jQuery(domain.confirmDialog._dialog).addClass("detail").addClass("noMaxWidth").addClass("sizeable").find(".sizer").show()},makeConfirmDialogNotSizeable:function(){jQuery(domain.confirmDialog._dialog).removeClass("detail").removeClass("noMaxWidth").removeClass("sizeable").css({height:"auto",width:"auto"}).find(".sizer").hide()},deleteInvalidViewItems:function(e){if("success"!==e){var t=$H(e.presentationObjectIds).keys();dd.deleteNodesFromTreeById(t,this.viewTree,this.copyMoveController)}},removeTables:function(e,t){var i=e.collect(function(e){return e.param.id}),r=function(){this.joinsTreeLoadCallback(),$(this.JOINS_TREE_ID).addClassName(layoutModule.HIDDEN_CLASS)},a=function(){dd.checkDesign(d.bind(this))},d=function(e){this.deleteInvalidViewItems(e),this.joinsTree.showTree(2,r.bind(this),domain.treeErrorHandler),t&&t()},s=function(e){dd.setUnsavedChangesPresent(!0),dd.deleteNodesFromTreeById(e,this.tablesTree,this.copyMoveController),dd.deleteNodesFromTreeById(i,this.tablesTree,this.copyMoveController),this.updateJoinView(a.bind(this))};dd.calcFieldsAndFiltersValidator.validate(e,!1,s.bind(this))},addItemToViewTree:function(e,t){if(e.param.extra.isIsland)return e.childs.collect(function(e){return this.addItemToViewTree(e,t).first()}.bind(this));var i=e.param.id,r=e.param.extra.itemId;this.idExistsInTree(this.viewTree,r)&&(r=this.getUniqueItemId(this.viewTree,r)),this.idExistsInTree(this.viewTree,i)&&(i=this.getUniqueItemId(this.viewTree,i));var a,d=e.isParent()?t.Types.Folder.name:t.Types.Leaf.name,s=this.viewTree.getRootNode(),n=this.changeOrderController.findMaxSiblingNode(t.childs,!1,!1,d),o=n?n.orderNumber:0,l=t===s?"/"+i:t.param.uri+"/"+i,u=domain.getDataIslandId(e,"itemId");a=e.isParent()?u?u:e.param.extra.itemId:this.buildCompositeIdentifier(e,".",this.getJoinsTreeNodeId,this.joinsTree.getRootNode());var c={id:i,label:e.name,type:d,uri:l,order:o+1,extra:{itemId:r,originalItemId:r,label:e.name,descr:r,labelId:"",descrId:"",resourceId:a}};if(e.isParent()||(c.extra.dataType=e.param.extra.JavaType,c.extra.defaultMask="none"),t.param.extra&&(!t.param.extra.resourceId||t.param.extra.resourceId===e.CONSTANT_TABLE_ID))for(var h=t;h!=this.viewTree.getRootNode();)h.param.extra.resourceId=u,h=h.parent;var m=this.createNode(this.viewTree,t,c);return this.updateChildOrders(m.parent),e.isParent()||(this.viewTree.resourceIdMap[a]=m,this.joinTreeModel.viewTreeMap[a]=e.param.id),e.isParent()&&e.childs.each(function(e){this.addItemToViewTree(e,m)}.bind(this)),[m]},addItemsToViewTree:function(e,t){if(e&&e.first()){t.isloaded=!0;var i=function(){dd.setUnsavedChangesPresent(!0);var i=[];e.clone().each(function(e){var r=this.addItemToViewTree(e,t);i=i.concat(r),dd.deleteNodesFromTreeById([e.param.id],this.joinsTree,this.copyMoveController)}.bind(this)),i.compact().each(function(e){this.viewTree.openAndSelectNode(e.param.uri)}.bind(this)),this.viewTree._deselectAllNodes(),i.each(function(e){e.select()}),1===this.viewTree.selectedNodes.length&&propsEditor.view(this.viewTree.selectedNodes.first()),this.updateButtonsState()};dd_display.addViewItemsValidator.validate(t,e,i.bind(this))}},refreshViewTreeStyle:function(e){$H(this.viewTree.treeMap).values().each(function(e){e.param.extra&&e.param.extra.isInvalid&&(delete e.param.extra.isInvalid,delete e.tooltip,e.refreshNode())}),e&&$H(e).each(function(e){var t=this.viewTree.treeMap[e.key];t&&(t.param.extra.isInvalid="true",t.tooltip=e.value,t.refreshNode())}.bind(this))},updateJoinView:function(e){var t={flowExecutionKey:dd.flowExecutionKey,eventId:"updateJoinView"},i=this.getValidationPostData();i.autoGenerateJoins="false",domain.sendAjaxRequest(t,i,e)},treeMouseDown:function(){},treeDblclick:function(e){var t=dynamicTree.trees[e.getTreeId()];t===this.joinsTree?$(this.ADD_ITEM_ID).click():t===this.viewTree&&$(this.DELETE_ITEM_ID).click()},treeMouseUp:function(e){var t=dynamicTree.trees[e.getTreeId()];if(t===this.joinsTree)return void this.updateButtonsState();if(!propsEditor.submitEdit()){var i=propsEditor.getNode(),r=dynamicTree.trees[i.getTreeId()];return t===r&&(t._deselectAllNodes(),i.select()),void this.updateButtonsState()}1==t.selectedNodes.length?propsEditor.view(t.selectedNodes.first()):propsEditor.hide(),this.updateButtonsState()},changeResourceViewModeClickHandler:function(e){var t=!1;return this.changeResourceViewModeHandlerMap.each(function(i){if(domain.elementClicked(e,i.key))throw this.changeResourceViewMode(i.value),this.updateButtonsState(),t=!0,$break}.bind(this)),t},moveButtonsClickEventHandler:function(e){var t=!1;return this.moveButtonsClickEventMap.each(function(i){if(domain.elementClicked(e,i.key)){var r=this.viewTree.selectedNodes;throw r.sort(i.value.upward?this.changeOrderController.nodeAscSorter:this.changeOrderController.nodeDescSorter).each(function(e){this.changeOrderController.moveNode(e,i.value.upward,i.value.maxmove)}.bind(this)),this.viewTree.resortSubtree(r.first().parent),this.viewTree.renderTree(),this.updateChangeOrderButtonsState(),sessionManager.resetSession(dd.flowExecutionKey),t=!0,$break}}.bind(this)),t},createNewSetClickEventHandler:function(e){if(domain.elementClicked(e,this.CREATE_NEW_SET_ID)){if(sessionManager.resetSession(dd.flowExecutionKey),!propsEditor.submitEdit())throw!0;var t=this.addNewSet();return this.viewTree.openAndSelectNode(t.param.uri),propsEditor.view(t),this.updateButtonsState(),!0}},addDeleteItemsClickEventHandler:function(e){var t=!1;return this.addDeleteItemsClickEventMap.each(function(i){if(domain.elementClicked(e,i.key))throw t=!0,i.value.bind(this)(),$break}.bind(this)),t},updateButtonsState:function(){this.updateSetsButtonsState(),this.updateChangeOrderButtonsState(),this.updateDeleteItemButtonState(),this.updateDeleteTableButtonState(),this.updateDoneButtonState(),dd.updateToolBarButtons()},updateSetsButtonsState:function(){if(this.resourceViewMode!==this.RESOURCE_VIEW_MODES.JOIN_TREE)return domain.enableButton(this.ADD_ITEM_ID,!1),void domain.enableButton(this.ADD_ITEM_TO_SET_ID,!1);domain.enableButton(this.ADD_ITEM_ID,!!this.joinsTree.selectedNodes.first());var e=this.joinsTree.selectedNodes.first()&&1==this.viewTree.selectedNodes.length&&this.viewTree.selectedNodes.first().isParent();domain.enableButton(this.ADD_ITEM_TO_SET_ID,e)},disableMoveButtons:function(){[this.MOVE_TO_TOP_ID,this.MOVE_UPWARD_ID,this.MOVE_DOWNWARD_ID,this.MOVE_TO_BOTTOM_ID].each(function(e){domain.enableButton(e,!1)})},updateChangeOrderButtonsState:function(){if(this.viewTree&&this.viewTree.selectedNodes.first()){var e=this.viewTree.selectedNodes.first().parent,t=this.viewTree.selectedNodes.find(function(t){return t.parent!==e});if(t)return void this.disableMoveButtons();var i=this.viewTree.selectedNodes.first().param.type,r=this.viewTree.selectedNodes.find(function(e,t){return t.param.type!==e}.curry(i));if(r)return void this.disableMoveButtons();var a=this.changeOrderController.findMaxSiblingNode(e.childs,!1,!0,i),d=this.changeOrderController.findMaxSiblingNode(e.childs,!0,!1,i),s=a&&a.orderNumber<d.orderNumber;[this.MOVE_TO_TOP_ID,this.MOVE_UPWARD_ID].each(function(e){domain.enableButton(e,s)});var n=this.changeOrderController.findMaxSiblingNode(e.childs,!1,!1,i),o=this.changeOrderController.findMaxSiblingNode(e.childs,!0,!0,i),l=n&&n.orderNumber>o.orderNumber;[this.MOVE_DOWNWARD_ID,this.MOVE_TO_BOTTOM_ID].each(function(e){domain.enableButton(e,l)})}else this.disableMoveButtons()},updateDeleteItemButtonState:function(){domain.enableButton(this.DELETE_ITEM_ID,this.viewTree.selectedNodes.first())},updateDeleteTableButtonState:function(){if(this.resourceViewMode!==this.RESOURCE_VIEW_MODES.TABLES_TREE)return void $(this.DELETE_TABLE_ID).addClassName(layoutModule.HIDDEN_CLASS);$(this.DELETE_TABLE_ID).removeClassName(layoutModule.HIDDEN_CLASS);var e=this.tablesTree.selectedNodes.first()&&!this.tablesTree.selectedNodes.find(function(e){return!e.isParent()});domain.enableButton(this.DELETE_TABLE_ID,e)},updateDoneButtonState:function(){var e=!!(this.viewTree&&this.viewTree.getRootNode()&&this.viewTree.getRootNode().childs.first());domain.enableButton(this.DONE_BUTTON_ID,e)}};var dd_display=dd.display;dd_display.propertiesEditor={_PROPERTIES_PANEL_ID:"properties",_MODES:{EMPTY:"empty",VIEW:"view",EDIT:"edit"},_ALL_FIELDSETS:["#identification","#bundleInfo","#itemSpecific","#resourceInfo"],_EDIT_ID:"edit",_CANCEL_ID:"cancel",_SAVE_ID:"save",_mode:null,_node:null,_params:null,_defaultAgg:{},_defaultMasks:null,_dimensionOrMeasureLabels:{},_typesMap:null,init:function(e,t){dd_display.propertiesEditor._init.bind(dd_display.propertiesEditor)(e,t)},view:function(e,t){dd_display.propertiesEditor._view.bind(dd_display.propertiesEditor)(e,t)},submitEdit:function(){return dd_display.propertiesEditor._submitEdit.bind(dd_display.propertiesEditor)()},getNode:function(){return dd_display.propertiesEditor._node},hide:function(){dd_display.propertiesEditor._hide.bind(dd_display.propertiesEditor)()},_init:function(e,t){this._defaultMasks=e,this._typesMap=t,this._initAggregations(),this._initDimensionOrMeasureLabels(),domain.registerClickHandlers([this._propertiesEditorClickHandler.bind(this)])},_propertiesEditorClickHandler:function(e){var t=!1;return this.buttonsMap.each(function(i){if(domain.elementClicked(e,i.key))throw i.value&&i.value(),sessionManager.resetSession(dd.flowExecutionKey),t=!0,$break}.bind(this)),t},_getGetValueLabelPairForObject:function(e){return{value:e,label:e}},_initAggregations:function(){var e=function(e){return"None"===e.value?"AAA":e.value};this._defaultAgg["int"]=this._defaultAgg.dec=_.sortBy(this.numberAggFunctionArray.collect(this._getGetValueLabelPairForObject),e),this._defaultAgg.NaN=_.sortBy(this.nanAggFunctionArray.collect(this._getGetValueLabelPairForObject),e),this._defaultAgg.date=this._defaultAgg.timestamp=this._defaultAgg.time=_.sortBy(this.dateAggFunctionArray.collect(this._getGetValueLabelPairForObject),e)},_initDimensionOrMeasureLabels:function(){this._dimensionOrMeasureLabels=this.dimensionOrMeasureArray.collect(this._getGetValueLabelPairForObject)},_view:function(e){if(this._submitEdit()&&(this._mode!==this._MODES.VIEW||this._node!==e)){if(!e)return void this._hide();this._node=e,this._mode=this._MODES.VIEW,$$(this._ALL_FIELDSETS).each(function(e){e.addClassName(layoutModule.HIDDEN_CLASS)}),$(this._EDIT_ID).removeClassName(layoutModule.HIDDEN_CLASS);var t=this.nodeTypeFactory[e.param.type];t.view.bind(this)(e),domain.enableButton(this._EDIT_ID,t.canEdit(e)),this._enableEditMode(!1)}},_edit:function(){this._mode==this._MODES.VIEW&&(this._mode=this._MODES.EDIT,this.nodeTypeFactory[this._node.param.type].edit.bind(this)(this._node),this._enableEditMode(!0),this._initialParamState=_.clone(this._node.param.extra))},_submitEdit:function(){if(this._mode!==this._MODES.EDIT)return!0;var e=function(e){e&&(dd.setUnsavedChangesPresent(!0),this._mode=this._MODES.EMPTY,this._view(this._node))}.bind(this);if(!this._validate())return!1;var t=this.nodeTypeFactory[this._node.param.type],i=t.getValues.bind(this)(this._node),r=t.submitChanges(this._node,i,e),a=this;if(r){var d;if(domain.designer.checkDesign(function(e){d=e},{synchronous:!0}),"success"!==d&&d.errorMessage){var s=domainUtil.getUsedResourcesList(d.errorMessage,domain._messages.ITEM_BEING_USED_BY_RESOURCE),n=_.uniq(_.map(dd_display.getItemTypeNodesRecursively(this._node),dd_display.getFullNodePath));return s=_.filter(s,function(e){return-1!==_.indexOf(n,e.field)}),s.length||domainUtil.indexOfNoAccessMessage(d.errorMessage,domain._messages.resourcesWithNoAccess)>-1?(jQuery("#dependentResourcesConfirmMessage").html(domainUtil.getUsedResourcesFormattedMessage(s,d.errorMessage,{"resource.label":domain._messages["resource.label"],"field.label":domain._messages["field.label"],ITEM_BEING_USED_BY_RESOURCE:domain._messages.ITEM_BEING_USED_BY_RESOURCE,resourcesWithNoAccess:domain._messages.resourcesWithNoAccess})),dd_display.makeConfirmDialogSizeable(),domain.confirmDialog.show("dependentResourcesConfirmMessage",function(){dd_display.makeConfirmDialogNotSizeable(),e(r)},function(){dd_display.makeConfirmDialogNotSizeable(),t.submitChanges(a._node,a._initialParamState,e),t.view.bind(a)(a._node),t.edit.bind(a)(a._node)}),!1):(e(r),!0)}return e(r),!0}},_cancelEdit:function(){this._mode===this._MODES.EDIT&&(this._mode=this._MODES.EMPTY,this._view(this._node),this._validate(!0))},_hide:function(){this._submitEdit()&&(this._node=null,this._validator=null,this._mode=this._MODES.EMPTY,$$(this._ALL_FIELDSETS.concat(["#"+this._EDIT_ID])).each(function(e){e.addClassName(layoutModule.HIDDEN_CLASS)}),this._enableEditMode(!1))},_validate:function(e){return this.nodeTypeFactory[this._node.param.type].validate.bind(this)(e)},_enableEditMode:function(e){e?$(this._PROPERTIES_PANEL_ID).addClassName("editMode"):$(this._PROPERTIES_PANEL_ID).removeClassName("editMode")},_getDataType:function(e){var t=this._typesMap[e.param.extra.dataType];return t||(t="NaN"),t},_itemExistsValidator:function(e){var t=dynamicTree.trees[this._node.getTreeId()],i=t.treeMap,r=!$H(i).values().find(function(e,t){return t!=this._node&&t.param.extra.itemId===e}.bind(this,e));return{isValid:r,errorMessage:domain.getMessage("item.exists")}}};var propsEditor=dd_display.propertiesEditor;dd_display.changeResourceViewModeHandlerMap=$H({"#joinTreeView":{mode:dd_display.RESOURCE_VIEW_MODES.JOIN_TREE,getSourceTree:function(){return dd_display.tablesTree},getDestTree:function(){return dd_display.joinsTree},sourceTreeId:dd_display.TABLES_TREE_ID,destTreeId:dd_display.JOINS_TREE_ID,sourceTabId:dd_display.TAB_TABLES_LIST_VIEW_ID,destTabId:dd_display.TAB_JOIN_TREE_VIEW_ID},"#tableListView":{mode:dd_display.RESOURCE_VIEW_MODES.TABLES_TREE,getSourceTree:function(){return dd_display.joinsTree},getDestTree:function(){return dd_display.tablesTree},sourceTreeId:dd_display.JOINS_TREE_ID,destTreeId:dd_display.TABLES_TREE_ID,sourceTabId:dd_display.TAB_JOIN_TREE_VIEW_ID,destTabId:dd_display.TAB_TABLES_LIST_VIEW_ID}}),dd_display.treeEventFactory={"leaf:mousedown":function(e){var t=e.memo.node;this.treeMouseDown(t),Event.stop(e)},"node:mousedown":function(e){var t=e.memo.node;this.treeMouseDown(t),Event.stop(e)},"leaf:mouseup":function(e){var t=e.memo.node;this.treeMouseUp(t),Event.stop(e)},"node:mouseup":function(e){var t=e.memo.node;this.treeMouseUp(t),Event.stop(e)},"leaf:dblclick":function(e){var t=e.memo.node;this.treeDblclick(t),Event.stop(e)},"node:dblclick":function(e){var t=e.memo.node;this.treeDblclick(t),Event.stop(e)},"tree:mouseout":function(e){var t=e.memo.tree;t===this.viewTree&&(t._overNode=null),Event.stop(e)},"tree:blur":function(e){var t=e.memo.tree;t===this.viewTree&&(t._overNode=null),Event.stop(e)}},dd_display.moveButtonsClickEventMap=$H({"#toTop":{upward:!0,maxmove:!0},"#upward":{upward:!0,maxmove:!1},"#downward":{upward:!1,maxmove:!1},"#toBottom":{upward:!1,maxmove:!0}}),dd_display.addDeleteItemsClickEventMap=$H({"#add":function(){var e=this.joinsTree.selectedNodes;this.canDeleteTreeItems(e)&&this.addItemsToViewTree(e,this.viewTree.getRootNode())},"#addToSet":function(){var e=this.joinsTree.selectedNodes;this.canDeleteTreeItems(e)&&this.addItemsToViewTree(e,this.viewTree.selectedNodes.first())},"#deleteItem":function(){var e=this.viewTree.selectedNodes;this.canDeleteTreeItems(e)&&this.deleteItemsFromViewTree(e,this.successDeleteTreeItemsCallback.bind(this))},"#deleteTable":function(){var e=this.tablesTree.selectedNodes;this.canDeleteTreeItems(e)&&this.removeTables(e,this.successDeleteTreeItemsCallback.bind(this))}}),propsEditor.numberAggFunctionArray=["None","Sum","Average","Max","Min","StdDevP","StdDevS","Mode","Median","Range","CountAll","CountDistinct"],propsEditor.dateAggFunctionArray=["None","Max","Min","Mode","Median","RangeMinutes","RangeHours","RangeDays","RangeWeeks","RangeMonths","RangeQuarters","RangeSemis","RangeYears","CountAll","CountDistinct"],propsEditor.nanAggFunctionArray=["None","CountDistinct","CountAll","Mode"],propsEditor.dimensionOrMeasureArray=["Dimension","Measure"],propsEditor.buttonsMap=$H({"#edit":propsEditor._edit.bind(propsEditor),"#save":propsEditor._submitEdit.bind(propsEditor),"#cancel":propsEditor._cancelEdit.bind(propsEditor)}),propsEditor.nodeTypeFactory={ItemGroupType:{view:function(e){$$(["#identification","#bundleInfo"]).each(function(e){e.removeClassName(layoutModule.HIDDEN_CLASS)
});var t=e.param.extra,i=domain.getMessage("none");$("itemName").writeAttribute("readonly","readonly").value=t.label?t.label:i,$("itemID").writeAttribute("readonly","readonly").value=t.itemId,$("itemDescription").writeAttribute("readonly","readonly").value=t.descr?t.descr:i,$("itemNameKey").writeAttribute("readonly","readonly").value=t.labelId?t.labelId:i,$("itemDescriptionKey").writeAttribute("readonly","readonly").value=t.descrId?t.descrId:i},canEdit:function(){return!0},edit:function(e){$("itemName").writeAttribute("readonly",null),$("itemID").writeAttribute("readonly",null),$("itemDescription").writeAttribute("readonly",null),$("itemNameKey").writeAttribute("readonly",null),$("itemDescriptionKey").writeAttribute("readonly",null),$H({label:"itemName",descr:"itemDescription",labelId:"itemNameKey",descrId:"itemDescriptionKey"}).each(function(t){e.param.extra[t.key]||($(t.value).value="")})},getValues:function(){return{label:$F("itemName"),itemId:$F("itemID"),descr:$F("itemDescription"),labelId:$F("itemNameKey"),descrId:$F("itemDescriptionKey")}},validate:function(e){return e?([$("itemName"),$("itemDescription"),$("itemNameKey"),$("itemDescriptionKey"),$("itemID")].each(function(e){ValidationModule.hideError(e)}),!0):ValidationModule.validate([{validator:dd.escapeJsonValidator.bind(this),element:$("itemName")},{validator:dd.escapeJsonValidator.bind(this),element:$("itemDescription")},{validator:dd.escapeJsonValidator.bind(this),element:$("itemNameKey")},{validator:dd.itemIdValidator.bind(this,"itemNameKey.invalid"),element:$("itemNameKey")},{validator:dd.escapeJsonValidator.bind(this),element:$("itemDescriptionKey")},{validator:dd.itemIdValidator.bind(this,"itemDescriptionKey.invalid"),element:$("itemDescriptionKey")},{validator:this._itemExistsValidator.bind(this),element:$("itemID")},{validator:dd.nonEmptyItemIdValidator.bind(this),element:$("itemID")},{validator:dd.emptyValidator.bind(this),element:$("itemID")}])},submitChanges:function(e,t){return e.changeName(t.label&&t.label.strip()?t.label:t.itemId),$H(t).each(function(t){e.param.extra[t.key]=t.value}),!0}},ItemType:{view:function(e){$$(["#identification","#bundleInfo","#itemSpecific"]).each(function(e){e.removeClassName(layoutModule.HIDDEN_CLASS)});var t=e.param.extra,i=domain.getMessage("none");$("itemName").writeAttribute("readonly","readonly").value=t.label?t.label:i,$("itemID").writeAttribute("readonly","readonly").value=t.itemId,$("itemDescription").writeAttribute("readonly","readonly").value=t.descr?t.descr:i,$("itemNameKey").writeAttribute("readonly","readonly").value=t.labelId?t.labelId:i,$("itemDescriptionKey").writeAttribute("readonly","readonly").value=t.descrId?t.descrId:i,$("resourceID").value=t.resourceId;var r=this._getDataType(e),a=function(e,i,a){var d={value:i.value,label:i.label},s="int"==r||"dec"==r;return d.selected=t[e]?t[e]===i.value:"dimensionOrMeasure"==e?s&&"Measure"==d.value:"defaultAgg"==e?d.value==(s?"Sum":"CountAll"):0==a,d},d=this._defaultAgg[r].collect(a.curry("defaultAgg"));domain.setOptionsToSelect($("summaryType").writeAttribute("disabled","diabled"),d),d=this._dimensionOrMeasureLabels.collect(a.curry("dimensionOrMeasure")),domain.setOptionsToSelect($("dimensionOrMeasure").writeAttribute("disabled","diabled"),d),"NaN"!==r?($$("label[for=dataFormat]").first().removeClassName(layoutModule.HIDDEN_CLASS),d=this._defaultMasks[r].collect(a.curry("defaultMask")),domain.setOptionsToSelect($("dataFormat").writeAttribute("disabled","disabled"),d)):$$("label[for=dataFormat]").first().addClassName(layoutModule.HIDDEN_CLASS)},canEdit:function(){return!0},edit:function(e){$("itemName").writeAttribute("readonly",null),$("itemID").writeAttribute("readonly",null),$("itemDescription").writeAttribute("readonly",null),$("itemNameKey").writeAttribute("readonly",null),$("itemDescriptionKey").writeAttribute("readonly",null),$("summaryType").writeAttribute("disabled",null),"NaN"!==this._getDataType(e)&&$("dataFormat").writeAttribute("disabled",null),$("dimensionOrMeasure").writeAttribute("disabled",null),$H({label:"itemName",descr:"itemDescription",labelId:"itemNameKey",descrId:"itemDescriptionKey"}).each(function(t){e.param.extra[t.key]||($(t.value).value="")})},getValues:function(e){var t={label:$F("itemName"),itemId:$F("itemID"),descr:$F("itemDescription"),labelId:$F("itemNameKey"),descrId:$F("itemDescriptionKey"),defaultAgg:$F("summaryType"),dimensionOrMeasure:$F("dimensionOrMeasure")};return"NaN"!==this._getDataType(e)&&(t.defaultMask=$F("dataFormat")),t},validate:function(e){return e?([$("itemName"),$("itemDescription"),$("itemNameKey"),$("itemDescriptionKey"),$("itemID")].each(function(e){ValidationModule.hideError(e)}),!0):ValidationModule.validate([{validator:dd.escapeJsonValidator.bind(this),element:$("itemName")},{validator:dd.escapeJsonValidator.bind(this),element:$("itemDescription")},{validator:dd.escapeJsonValidator.bind(this),element:$("itemNameKey")},{validator:dd.itemIdValidator.bind(this,"itemNameKey.invalid"),element:$("itemNameKey")},{validator:dd.escapeJsonValidator.bind(this),element:$("itemDescriptionKey")},{validator:dd.itemIdValidator.bind(this,"itemDescriptionKey.invalid"),element:$("itemDescriptionKey")},{validator:this._itemExistsValidator.bind(this),element:$("itemID")},{validator:dd.nonEmptyItemIdValidator.bind(this),element:$("itemID")},{validator:dd.emptyValidator.bind(this),element:$("itemID")}])},submitChanges:function(e,t){return e.changeName(t.label&&t.label.strip()?t.label:t.itemId),$H(t).each(function(t){e.param.extra[t.key]=t.value}),!0}},level:{view:function(e){$("resourceInfo").removeClassName(layoutModule.HIDDEN_CLASS),$$(["label[for=resourceItemType]"]).first().addClassName(layoutModule.HIDDEN_CLASS);var t=e.param.extra;$("resourceItemId").writeAttribute("readonly","readonly").value=t.itemId,$("resourceItemDataSource").value=t.dataSource,$("resourceItemSourceTable").value=t.table},canEdit:function(e){return!e.param.extra.isIsland&&![e.CONSTANT_TABLE_ID,e.CROSSTABLES_FIELDS_TABLE_ID].include(e.param.id)},edit:function(){$("resourceItemId").writeAttribute("readonly",null)},getValues:function(){return{itemId:$F("resourceItemId")}},validate:function(){return ValidationModule.validate([{validator:this._itemExistsValidator.bind(this),element:$("resourceItemId")},{validator:dd.nonEmptyItemIdValidator.bind(this),element:$("resourceItemId")},{validator:dd.emptyValidator.bind(this),element:$("resourceItemId")}])},submitChanges:function(e,t,i){return e.param.extra.itemId===t.itemId?!0:(dd_display.changeNodeAlias(e,t.itemId,i),!0)}},item:{view:function(e){$("resourceInfo").removeClassName(layoutModule.HIDDEN_CLASS),$$(["label[for=resourceItemType]"]).first().removeClassName(layoutModule.HIDDEN_CLASS);var t=e.param.extra;$("resourceItemId").writeAttribute("readonly","readonly").value=t.itemId,$("resourceItemDataSource").value=t.dataSource,$("resourceItemSourceTable").value=t.table,$("resourceItemType").value=t.JavaType},canEdit:function(){return!1},edit:function(){},getValues:function(){},validate:function(){},submitChanges:function(){}}},"undefined"==typeof require&&document.observe("dom:loaded",dd.initialize.bind(dd));