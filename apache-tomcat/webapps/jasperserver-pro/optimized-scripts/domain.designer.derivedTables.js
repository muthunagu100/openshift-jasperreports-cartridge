dd.derivedTables={PAGE:"query",DERIVED_TABLES_TAB:"derivedTablesTab",FLOW_CONTROLS:["tablesTab","derivedTablesTab","joinsTab","preFiltersTab","displayTab"],TREE_DOM_ID:"itemsTree",TREE_DATA_PROVIDER:"selectedTreeDataProvider",TREE_TEMPLATE_DOM_ID:"list_responsive_collapsible_type_tables",QUERY_NAME_INPUT_ID:"queryName",EXPRESSION_INPUT_ID:"expression",SAVE_TABLE_BUTTON_ID:"saveTable",CANCEL_SAVE_BUTTON_ID:"cancelSave",RUN_QUERY_BUTTON_ID:"runQuery",RETURNED_FIELDS_SELECT_ID:"returnedFields",QUERY_RESULTS_ID:"queryResults",ERROR_REPORT_ID:"errorReport",DROPDOWN_MENU_ID:"menu",CHECK_DESIGN_MENU_ID:"checkDesign",EXPORT_MENU_ID:"export",TOOLBAR_DELETE_TABLE_ID:"delete",QUERY_DATA_SET:"JdbcQueryDataSet",DERIVED_TABLE_DETAILS_PANEL:"derivedTableDetailsPanel",ITEMS_PANEL:"fields",SIZER_PATTERN:"div.sizer",queryNameInput:null,expressionInput:null,returnedFieldsSelect:null,itemsTree:null,editedTable:null,usedTablesByItemId:null,dataSourceId:null,queryResult:{query:null,result:null},selectionRange:null,MODES:{WAIT_FOR_ACTION:"wait",EDIT:"edit",EDIT_QUERY_SUCCESS:"edit_query_success",EDIT_QUERY_FAIL:"edit_query_fail"},mode:null,copyMoveController:new domain.TablesCopyMoveController,getValidationPostData:function(){return{selectedModel:this.getSelectedModel(),page:this.PAGE}},getSelectedModel:function(){var e=this.itemsTree.getRootNode().childs;return Object.toJSON(e)},fillForm:function(){$("selectedModel").writeAttribute("value",this.getSelectedModel()),$("unsavedChangesPresent").writeAttribute("value",dd.isUnsavedChangesPresent().toString())},initFromOptions:function(e){this.dataSourceId=e.dataSourceId,this.usedTablesByItemId=e.usedTablesByItemId},init:function(e){this.initFromOptions(e),dd.calcFieldsAndFiltersValidator.init(dd.validateForCalcFields.bind(dd),dd.getTablesUsedForFilters.bind(dd,this.usedTablesByItemId[this.dataSourceId])),domain.resetTreeSelectionHandler.init([this.SIZER_PATTERN,this.DERIVED_TABLE_DETAILS_PANEL,this.ITEMS_PANEL,this.TREE_DOM_ID,this.QUERY_NAME_INPUT_ID,this.EXPRESSION_INPUT_ID,this.SAVE_TABLE_BUTTON_ID,this.RUN_QUERY_BUTTON_ID,this.RETURNED_FIELDS_SELECT_ID,this.ERROR_REPORT_ID,this.CANCEL_SAVE_BUTTON_ID,this.DROPDOWN_MENU_ID,this.CHECK_DESIGN_MENU_ID,this.EXPORT_MENU_ID].concat(this.FLOW_CONTROLS).collect(function(e){return"#"+e}),function(){return[this.itemsTree]}.bind(this),this.deselectNodes.bind(this),this.deselectNodesValidator.bind(this)),domain.registerClickHandlers([this.cancelSaveClickHandler.bind(this),this.runQueryClickHandler.bind(this),this.saveTableClickHandler.bind(this)]),domain.registerClickHandlers([this.checkUnsavedChangesClickHander.bind(this)],null,!0),this.initTree(),this.initInputs(),this.setMode(this.MODES.WAIT_FOR_ACTION),this.updateButtonsState()},initTree:function(){this.itemsTree=domain.createItemsTree({multiSelectEnabled:!1,treeId:this.TREE_DOM_ID,providerId:this.TREE_DATA_PROVIDER,templateDomId:this.TREE_TEMPLATE_DOM_ID,nodeClass:domain.DerivedTablesNode,selectOnMousedown:!1});for(var e in this.treeEventFactory)this.itemsTree.observe(e,this.treeEventFactory[e].bindAsEventListener(this));this.itemsTree.showTree(1,dd.createTreeNodesMap.curry(this.itemsTree),domain.treeErrorHandler)},initInputs:function(){this.queryNameInput=$(this.QUERY_NAME_INPUT_ID),this.expressionInput=$(this.EXPRESSION_INPUT_ID),this.returnedFieldsSelect=$(this.RETURNED_FIELDS_SELECT_ID),this.queryNameInput.observe("keyup",this.queryIdChanged.bind(this)),this.expressionInput.observe("keyup",this.expressionChanged.bind(this)),this.expressionInput.observe("mouseup",this.saveSelection.bind(this)),this.returnedFieldsSelect.observe("change",this.updateButtonsState.bind(this))},setMode:function(e){this.mode=e},saveTable:function(e,t,i,s,d){var r=e+"."+t,a={id:r,label:t,type:"level",uri:"/"+r};a.extra={dataSetType:this.QUERY_DATA_SET,dataSource:e,datasourceId:e,itemId:t,originalId:t,repoId:"",query:escapeString(i,[/\n/g,/;/g],[" ",""])};var n=this.itemsTree.processNode(a);s.each(function(t){var i=t.type,s=a.id+"."+t.itemId,d={id:s,label:t.fieldDbName,type:"item",uri:a.uri+"/"+s};d.extra={JavaType:i,JdbcType:"",dataSource:e,datasourceId:e,itemId:t.itemId,originalId:a.extra.originalId+"."+t.itemId,fieldDbName:t.fieldDbName,repoId:"",table:a.extra.originalId};var r=this.itemsTree.processNode(d);n.addChild(r)}.bind(this)),d&&d.parent.removeChild(d),this.itemsTree.getRootNode().addChild(n),n.isloaded=!0,this.itemsTree.treeMap[n.param.id]=n,this.itemsTree.resortSubtree(this.itemsTree.getRootNode()),this.itemsTree.renderTree(),this.cancelEdit(),dd.setUnsavedChangesPresent(!0)},queryIdChanged:function(){this.mode===this.MODES.WAIT_FOR_ACTION&&this.setMode(this.MODES.CREATE),this.updateButtonsState()},expressionChanged:function(){this.mode===this.MODES.WAIT_FOR_ACTION?this.setMode(this.MODES.CREATE):this.mode!==this.MODES.EDIT_QUERY_SUCCESS&&this.mode!==this.MODES.EDIT_QUERY_FAIL||this.queryResult.query===$F(this.EXPRESSION_INPUT_ID).strip()||(this.setMode(this.MODES.EDIT),this.queryResult.query=null,this.queryResult.result=null),this.saveSelection(),this.updateButtonsState()},saveSelection:function(){document.selection&&(this.selectionRange=document.selection.createRange())},deselectNodesValidator:function(){return this.mode===this.MODES.WAIT_FOR_ACTION||confirm(domain.getMessage("changesWillBeLost"))},deselectNodes:function(){this.editedTable&&this.cancelEdit()},cancelEdit:function(){this.editedTable&&this.editedTable.deselect(),this.editedTable=null,this.queryResult.query=null,this.queryResult.result=null,[this.queryNameInput,this.expressionInput].invoke("setValue",""),this.setMode(this.MODES.WAIT_FOR_ACTION),buttonManager.enable(this.queryNameInput),$(this.QUERY_RESULTS_ID).removeClassName("success").removeClassName("error"),[this.queryNameInput,this.expressionInput,this.returnedFieldsSelect].each(function(e){ValidationModule.hideError(e)}),this.updateButtonsState()},queryIdEmptyValidator:function(e){return{isValid:dd.emptyValidator(e).isValid,errorMessage:domain.getMessage("queryId.empty")}},queryIdInvalidValidator:function(e){return{isValid:dd.nonEmptyItemIdValidator(e).isValid&&e.indexOf(".")<0,errorMessage:domain.getMessage("queryId.invalid")}},queryIdExistsValidator:function(e){var t=!0;if(e&&!this.editedTable){var i=$H(this.itemsTree.treeMap).values().find(function(e,t){return t.param.extra.itemId===e}.bind(this,e));t=!i}return{isValid:t,errorMessage:domain.getMessage("fieldId.exists")}},queryExpressionValidator:function(e){var t=!1,i=domain.getMessage("expression.empty");if(e&&e.strip()){var s=e.strip().split(/\s+/,4);s.length>=4&&"select"==s[0].toLowerCase()?t=!0:i=domain.getMessage("expression.nonselect")}return{isValid:t,errorMessage:i}},queryResultValidator:function(){var e=!1,t=domain.getMessage("expression.notRunned");return this.mode===this.MODES.EDIT_QUERY_SUCCESS?e=!0:this.mode===this.MODES.EDIT_QUERY_FAIL&&(t=domain.getMessage("expression.queryFailed")),{isValid:e,errorMessage:t}},isFieldsSelectedValidator:function(){var e;if(this.mode===this.MODES.EDIT_QUERY_SUCCESS){var t=$F(this.RETURNED_FIELDS_SELECT_ID);e=t&&t.first()}else e=!0;return{isValid:e,errorMessage:domain.getMessage("resultFields.emptySelection")}},insertNodeToQuery:function(e){if(!(e.param.extra.expression||e.param.extra.query||[e.CONSTANT_TABLE_ID,e.CROSSTABLES_FIELDS_TABLE_ID].include(e.param.id))){var t;e.param.type&&(t=e.param.extra.table),e.isParent()||(t=e.param.extra.fieldDbName),dd.insertAtCaret($(this.EXPRESSION_INPUT_ID),t,this.selectionRange),this.expressionChanged()}},removeTable:function(e){if(e){var t=function(t){dd.setUnsavedChangesPresent(!0);var i=e.param.id;t&&t.first()&&dd.deleteNodesFromTreeById(t,this.itemsTree,this.copyMoveController),dd.deleteNodesFromTreeById([i],this.itemsTree,this.copyMoveController),this.updateButtonsState()};dd.calcFieldsAndFiltersValidator.validate([e],!1,t.bind(this))}},runJDBCquery:function(e,t){var i={eventId:"runJDBCQuery",flowExecutionKey:dd.flowExecutionKey},s={createdQuerySql:e,selectedDatasource:this.dataSourceId};domain.sendAjaxRequest(i,s,t)},cancelSaveClickHandler:function(e){return domain.elementClicked(e,"#"+this.CANCEL_SAVE_BUTTON_ID)?(this.deselectNodesValidator()&&this.cancelEdit(),!0):void 0},runQueryClickHandler:function(e){if(domain.elementClicked(e,"#"+this.RUN_QUERY_BUTTON_ID)){var t=$F(this.EXPRESSION_INPUT_ID).strip().split("\r\n").join("\n"),i=function(e){if(e.error)this.queryResult.query=t,this.queryResult.result=e.error,$(this.ERROR_REPORT_ID).update(e.error),$(this.QUERY_RESULTS_ID).removeClassName("success").addClassName("error"),this.setMode(this.MODES.EDIT_QUERY_FAIL);else if(e.success){this.queryResult.query=t,this.queryResult.result=e.success;var i=[];this.editedTable&&(i=this.editedTable.childs.collect(function(e){return e.param.extra.itemId}));var s=this.queryResult.result.collect(function(e){return e.itemId}),d=i.length+s.length,r=i.concat(s).uniq().length===d,a=this.queryResult.result.collect(function(e){var t=r?!0:i.indexOf(e.itemId)>-1;return{value:e.itemId,label:e.fieldDbName,selected:t}},this);domain.setOptionsToSelect(this.returnedFieldsSelect,a),$(this.QUERY_RESULTS_ID).addClassName("success").removeClassName("error"),this.setMode(this.MODES.EDIT_QUERY_SUCCESS)}this.updateButtonsState()},s=ValidationModule.validate([{validator:this.queryExpressionValidator,element:this.expressionInput}]);return ValidationModule.hideError(this.returnedFieldsSelect),s&&this.runJDBCquery(t,i.bind(this)),!0}},saveTableClickHandler:function(e){if(domain.elementClicked(e,"#"+this.SAVE_TABLE_BUTTON_ID)){var t=ValidationModule.validate([{validator:this.queryIdExistsValidator.bind(this),element:this.queryNameInput},{validator:this.queryIdInvalidValidator.bind(this),element:this.queryNameInput},{validator:this.queryIdEmptyValidator.bind(this),element:this.queryNameInput},{validator:this.isFieldsSelectedValidator.bind(this),element:this.returnedFieldsSelect},{validator:this.queryResultValidator.bind(this),element:this.expressionInput},{validator:this.queryExpressionValidator.bind(this),element:this.expressionInput}]);if(t){var i=$F(this.RETURNED_FIELDS_SELECT_ID),s=this.queryResult.result.findAll(function(e){return i.indexOf(e.itemId)>=0}.bind(this));this.saveTable(this.dataSourceId,$F(this.QUERY_NAME_INPUT_ID),this.queryResult.query,s,this.editedTable),this.updateButtonsState()}return!0}},nodeMouseUp:function(e){(!e.param.extra.query||this.mode!==this.MODES.WAIT_FOR_ACTION&&this.editedTable!==e)&&(e.deselect(),this.editedTable&&this.editedTable.select()),this.updateButtonsState()},nodeClickHandler:function(e){this.editedTable!==e&&e.param.extra.query&&this.deselectNodesValidator()&&(this.cancelEdit(),e.param.extra.query&&(this.editedTable=e,this.queryNameInput.setValue(e.param.extra.itemId),this.expressionInput.setValue(e.param.extra.query),buttonManager.disable(this.queryNameInput)),this.updateButtonsState())},checkUnsavedChangesClickHander:function(e){var t=!1;return this.FLOW_CONTROLS.each(function(i){if(domain.elementClicked(e,"#"+i)&&i!==this.DERIVED_TABLES_TAB){var s=this.deselectNodesValidator();throw s||(tabModule.setSelected($(this.DERIVED_TABLES_TAB).parentNode),tabModule.setUnselected($(i).parentNode)),t=!s,$break}}.bind(this)),t},updateButtonsState:function(){domain.enableButton(this.RUN_QUERY_BUTTON_ID,$F(this.EXPRESSION_INPUT_ID).strip());var e=$F(this.QUERY_NAME_INPUT_ID).strip()&&$F(this.EXPRESSION_INPUT_ID).strip(),t=this.mode===this.MODES.EDIT_QUERY_SUCCESS&&$F(this.RETURNED_FIELDS_SELECT_ID).first();domain.enableButton(this.SAVE_TABLE_BUTTON_ID,e&&t),this.updateToolbarButtonsState()},updateToolbarButtonsState:function(){[this.TOOLBAR_DELETE_TABLE_ID].each(function(e){toolbarButtonModule.setButtonState($(e),this.toolbarButtonsEnabled())}.bind(this))}};var dd_derivedTables=dd.derivedTables;dd_derivedTables.toolbarActionMap={"delete":"dd_derivedTables.deleteTable"},dd_derivedTables.deleteTable=function(){var e=dd_derivedTables.itemsTree.selectedNodes.first();dd_derivedTables.removeTable.bind(dd_derivedTables,e)()},dd_derivedTables.toolbarButtonsEnabled=function(){var e=dd_derivedTables.itemsTree.selectedNodes.first();return e&&e.isParent()&&e.param.id!==e.CONSTANT_TABLE_ID&&e.param.id!==e.CROSSTABLES_FIELDS_TABLE_ID},dd_derivedTables.treeEventFactory={"leaf:mousedown":function(e){this.nodeClickHandler(e.memo.node),Event.stop(e)},"node:mousedown":function(e){this.nodeClickHandler(e.memo.node),Event.stop(e)},"leaf:mouseup":function(e){this.nodeMouseUp(e.memo.node),Event.stop(e)},"node:mouseup":function(e){this.nodeMouseUp(e.memo.node),Event.stop(e)},"node:dblclick":function(e){this.insertNodeToQuery(e.memo.node),Event.stop(e)},"leaf:dblclick":function(e){this.insertNodeToQuery(e.memo.node),Event.stop(e)}},"undefined"==typeof require&&document.observe("dom:loaded",dd.initialize.bind(dd));